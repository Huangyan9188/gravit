!function(a){function b(a){this._scene=a,this._guides=[],this._counter=0,this._visuals=[],this._shapeBoxGuide=new GShapeBoxGuide(this),this._addGuide(this._shapeBoxGuide),this._addGuide(new GPageGuide(this)),this._addGuide(new GGridGuide(this)),this._addGuide(new GUnitGuide(this))}GObject.inherit(b,GEventTarget),b.VISUALS_LENGTH=10,b.InvalidationRequestEvent=function(a){this.area=a},GObject.inherit(b.InvalidationRequestEvent,GEvent),b.InvalidationRequestEvent.prototype.area=null,b.InvalidationRequestEvent.prototype.toString=function(){return"[Event GGuides.InvalidationRequestEvent]"},b.prototype._scene=null,b.prototype._guides=null,b.prototype._shapeBoxGuide=null,b.prototype._counter=0,b.prototype._visuals=null,b.prototype._area=null,b.prototype.beginMap=function(){0==this._counter&&(this._visuals=[],this._area&&!this._area.isEmpty()&&this.invalidate(this._area),this._area=null),++this._counter},b.prototype.finishMap=function(){if(this._counter>0&&(--this._counter,0==this._counter&&this._visuals.length)){for(var a,b=null,c=null,d=null,e=null,f=0;f<this._visuals.length;++f){a=this._visuals[f];for(var g=0;2>g;++g)(null===b||b>a[g].getX())&&(b=a[g].getX()),(null===c||c>a[g].getY())&&(c=a[g].getY()),(null===d||d<a[g].getX())&&(d=a[g].getX()),(null===e||e<a[g].getY())&&(e=a[g].getY())}b-=1,c-=1,d+=1,e+=1,this._area=new GRect(b,c,d-b,e-c),this.invalidate(this._area),this._shapeBoxGuide.cleanExclusions()}},b.prototype.mapPoint=function(a){for(var b,c=null,d=null,e=null,f=[],g=0;g<this._guides.length&&(null===c||null===d);++g)b=this._guides[g],b.isMappingAllowed()&&(e=b.map(a.getX(),a.getY()),e&&(e.x&&null===c&&(c=e.x.value,this._visuals&&e.x.guide&&(e.x.guide instanceof GPoint?f.push(e.x.guide):this._visuals.push(e.x.guide))),e.y&&null===d&&(d=e.y.value,this._visuals&&e.y.guide&&(e.y.guide instanceof GPoint?f.push(e.y.guide):this._visuals.push(e.y.guide)))),e=null);null===c&&(c=a.getX()),null===d&&(d=a.getY());for(var h,i=new GPoint(c,d),g=0;g<f.length;++g)h=f[g],(Math.abs(c-h.getX())>=2||Math.abs(d-h.getY())>=2)&&this._visuals.push([i,h]);return i},b.prototype.paint=function(a,b){for(var c,d=0;d<this._guides.length;++d)c=this._guides[d],c.hasMixin(GGuide.Visual)&&c.paint(a,b);for(var e,d=0;d<this._visuals.length;++d){e=this._visuals[d];var f=a.mapPoint(e[0]),g=a.mapPoint(e[1]);b.canvas.strokeLine(Math.floor(f.getX())+.5,Math.floor(f.getY())+.5,Math.floor(g.getX())+.5,Math.floor(g.getY())+.5,1,b.guideOutlineColor)}this._visuals=[]},b.prototype.invalidate=function(a){this.hasEventListeners(b.InvalidationRequestEvent)&&(a&&!a.isEmpty()?this.trigger(new b.InvalidationRequestEvent(a)):this._area&&!this._area.isEmpty()&&(this.trigger(new b.InvalidationRequestEvent(this._area)),this._area=null))},b.prototype.getShapeBoxGuide=function(){return this._shapeBoxGuide},b.prototype.getBBoxSnapZones=function(a,c){for(var d=null,e=!1,f=0;f<this._guides.length&&!e;++f){var g=this._guides[f];!g.isMappingAllowed()||g instanceof GUnitGuide||(e=!0)}var h=this._scene.getProperty("pickDist");if(e&&a&&!a.isEmpty()&&a.expanded(h,h,h,h).containsPoint(c)){d=[];var i,j=a.getClosestSideName(c),k=a.getSide(j),l=a.getSide(GRect.Side.TOP_LEFT),m=a.getSide(GRect.Side.BOTTOM_RIGHT),n=Math.abs(m.getX()-l.getX()),o=Math.abs(m.getY()-l.getY());i=n>2*b.VISUALS_LENGTH?b.VISUALS_LENGTH:n>b.VISUALS_LENGTH?n/2:n;var p=k.getY(),q=p,r=l.getX();switch(j){case GRect.Side.TOP_CENTER:case GRect.Side.CENTER:case GRect.Side.BOTTOM_CENTER:r=k.getX()-i/2;break;case GRect.Side.TOP_RIGHT:case GRect.Side.RIGHT_CENTER:case GRect.Side.BOTTOM_RIGHT:r=k.getX()-i}var s=r+i;d.push([new GPoint(r,p),new GPoint(s,q)]);var t;switch(t=o>2*b.VISUALS_LENGTH?b.VISUALS_LENGTH:o>b.VISUALS_LENGTH?o/2:o,r=k.getX(),s=r,p=l.getY(),j){case GRect.Side.LEFT_CENTER:case GRect.Side.CENTER:case GRect.Side.RIGHT_CENTER:p=k.getY()-t/2;break;case GRect.Side.BOTTOM_LEFT:case GRect.Side.BOTTOM_CENTER:case GRect.Side.BOTTOM_RIGHT:p=k.getY()-t}q=p+t,d.push([new GPoint(r,p),new GPoint(s,q)])}return d},b.prototype._addGuide=function(a){this._guides.push(a)},b.prototype.toString=function(){return"[Object GGuides]"},a.GGuides=b}(this),function(a){function b(a){this._guides=a,this._scene=a._scene}GObject.inherit(b,GObject),b.prototype._guides=null,b.prototype._scene=null,b.Visual=function(){},b.Visual.prototype.paint=function(){},b.Visual.prototype.toString=function(){return"[Mixin GGuide.Visual]"},b.Map=function(){},b.Map.prototype.map=function(){},b.Map.prototype.isMappingAllowed=function(){return!0},b.Map.prototype.toString=function(){return"[Mixin GGuide.Map]"},b.prototype.toString=function(){return"[Object GGuide]"},a.GGuide=b}(this),function(a){function b(a){GGuide.call(this,a)}GObject.inheritAndMix(b,GGuide,[GGuide.Visual,GGuide.Map]),b.MIN_CELL_SPACE=10,b.prototype.paint=function(a,c){if(this._scene.getProperty("gridActive")&&c.configuration.gridVisible){var d=a.getScaleFactor(),e=this._scene.getProperty("gridSizeX"),f=this._scene.getProperty("gridSizeY"),g=e*d,h=f*d;g<b.MIN_CELL_SPACE&&(g*=1+Math.floor(b.MIN_CELL_SPACE/g)),h<b.MIN_CELL_SPACE&&(h*=1+Math.floor(b.MIN_CELL_SPACE/h)),e=g/d,f=h/d;for(var i=c.dirtyMatcher.getDirtyRectangles(),j=0;j<i.length;++j){for(var k=i[j],l=new GPoint(k.getX(),k.getY()),m=a.inverted().mapPoint(l),n=Math.ceil(m.getX()/e)*e,o=Math.ceil(m.getY()/f)*f,p=new GPoint(n,o),q=a.mapPoint(p),r=q.getX();r-k.getX()<k.getWidth();r+=g)c.canvas.fillRect(Math.round(r),k.getY(),1,k.getHeight(),GRGBColor.BLACK,.125);for(var s=q.getY();s-k.getY()<k.getHeight();s+=h)c.canvas.fillRect(k.getX(),Math.round(s),k.getWidth(),1,GRGBColor.BLACK,.125)}}},b.prototype.map=function(a,b){var c=null;if(this._scene.getProperty("gridActive")){var d=this._scene.getProperty("gridSizeX"),e=this._scene.getProperty("gridSizeY");c={x:{value:Math.round(a/d)*d,guide:null},y:{value:Math.round(b/e)*e,guide:null}}}return c},b.prototype.isMappingAllowed=function(){return!ifPlatform.modifiers.metaKey},b.prototype.toString=function(){return"[Object GGridGuide]"},a.GGridGuide=b}(this),function(a){function b(a){GGuide.call(this,a)}GObject.inheritAndMix(b,GGuide,[GGuide.Map]),b.prototype.map=function(a,b){return this._scene.getProperty("unitSnap")===!0?{x:{value:GMath.round(a,!0),guide:null},y:{value:GMath.round(b,!0),guide:null}}:null},b.prototype.toString=function(){return"[Object GUnitGuide]"},a.GUnitGuide=b}(this),function(a){function b(a){GGuide.call(this,a)}GObject.inheritAndMix(b,GGuide,[GGuide.Map]),b.prototype.map=function(a,b){var c=this._scene.getProperty("snapDist"),d=null,e=null,f=null,g=null,h=null,i=function(h){var i=h.getGeometryBBox();if(i&&!i.isEmpty())for(var j=i.getSide(GRect.Side.TOP_LEFT),k=i.getSide(GRect.Side.BOTTOM_RIGHT),l=i.getSide(GRect.Side.CENTER),m=[j,k,l],n=[GRect.Side.TOP_LEFT,GRect.Side.BOTTOM_RIGHT,GRect.Side.CENTER],o=0;o<n.length;++o){var p=m[o];null===d&&Math.abs(a-p.getX())<=c&&(d=p.getX(),n[o]==GRect.Side.CENTER&&(f=[new GPoint(d,j.getY()),new GPoint(d,k.getY())])),null===e&&Math.abs(b-p.getY())<=c&&(e=p.getY(),n[o]==GRect.Side.CENTER&&(g=[new GPoint(j.getX(),e),new GPoint(k.getX(),e)]))}};if(this._scene.getProperty("singlePage"))i(this._scene.getActivePage());else for(var j=this._scene.getFirstChild();null!==j&&(null===d||null===e);j=j.getNext())j instanceof GPage&&!j.hasFlag(GElement.Flag.Hidden)&&i(j);return(null!==d||null!==e)&&(h={x:null!==d?{value:d,guide:f}:null,y:null!==e?{value:e,guide:g}:null}),h},b.prototype.isMappingAllowed=function(){return!ifPlatform.modifiers.metaKey},b.prototype.toString=function(){return"[Object GPageGuide]"},a.GPageGuide=b}(this),function(a){function b(a){GGuide.call(this,a)}GObject.inheritAndMix(b,GGuide,[GGuide.Map]),b.GUIDE_MARGIN=20,b.prototype._exclusions=null,b.prototype.map=function(a,c){var d=null,e=null,f=null,g=null,h=null;if(this._scene.getProperty("singlePage")){var i=this._scene.getProperty("snapDist"),j=function(h){if(this._exclusions)for(var j=0;j<this._exclusions.length;++j)if(this._exclusions[j]==h)return;var k=h.getGeometryBBox();if(k&&!k.isEmpty())for(var l=k.getSide(GRect.Side.TOP_LEFT),m=k.getSide(GRect.Side.BOTTOM_RIGHT),n=k.getSide(GRect.Side.CENTER),o=[l,m,n],p=[GRect.Side.TOP_LEFT,GRect.Side.BOTTOM_RIGHT,GRect.Side.CENTER],j=0;j<p.length;++j){var q=o[j];null===d&&Math.abs(a-q.getX())<=i&&(d=q.getX(),f=c<=l.getY()?[new GPoint(d,c-b.GUIDE_MARGIN),new GPoint(d,m.getY()+b.GUIDE_MARGIN)]:l.getY()<c&&c<m.getY()?[new GPoint(d,l.getY()-b.GUIDE_MARGIN),new GPoint(d,m.getY()+b.GUIDE_MARGIN)]:[new GPoint(d,l.getY()-b.GUIDE_MARGIN),new GPoint(d,c+b.GUIDE_MARGIN)]),null===e&&Math.abs(c-q.getY())<=i&&(e=q.getY(),g=a<=l.getX()?[new GPoint(a-b.GUIDE_MARGIN,e),new GPoint(m.getX()+b.GUIDE_MARGIN,e)]:l.getX()<a&&a<m.getX()?[new GPoint(l.getX()-b.GUIDE_MARGIN,e),new GPoint(m.getX()+b.GUIDE_MARGIN,e)]:[new GPoint(l.getX()-b.GUIDE_MARGIN,e),new GPoint(a+b.GUIDE_MARGIN,e)])}}.bind(this),k=this._scene.getActivePage();k.accept(function(a){a instanceof GShape&&a.getParent()instanceof GLayer&&j(a)})}return(null!==d||null!==e)&&(h={x:null!==d?{value:d,guide:f}:null,y:null!==e?{value:e,guide:g}:null}),h},b.prototype.isMappingAllowed=function(){return!ifPlatform.modifiers.metaKey},b.prototype.useExclusions=function(a){this._exclusions=a},b.prototype.cleanExclusions=function(){this._exclusions=null},b.prototype.toString=function(){return"[Object GShapeBoxGuide]"},a.GShapeBoxGuide=b}(this),function(a){function b(a,b,c){var d=a.getSide(GRect.Side.TOP_LEFT);this.tlx=d.getX(),this.tly=d.getY();var e=a.getSide(GRect.Side.TOP_RIGHT);this.trx=e.getX(),this.try=e.getY();var f=a.getSide(GRect.Side.BOTTOM_RIGHT);this.brx=f.getX(),this.bry=f.getY();var g=a.getSide(GRect.Side.BOTTOM_LEFT);this.blx=g.getX(),this.bly=g.getY(),this._vertices=new GVertexContainer,this.cx=b?b:(this.tlx+this.brx)/2,this.cy=c?c:(this.tly+this.bry)/2}b.ANNOT_SIZE=6,b.TRANSFORM_MARGIN=0,b.Handles={TOP_LEFT:0,TOP_CENTER:1,TOP_RIGHT:2,RIGHT_CENTER:3,BOTTOM_RIGHT:4,BOTTOM_CENTER:5,BOTTOM_LEFT:6,LEFT_CENTER:7,ROTATION_CENTER:8},b.OUTLINE=GUtil.uuid(),b.INSIDE=GUtil.uuid(),b.OUTSIDE=GUtil.uuid(),b.prototype.tlx=null,b.prototype.tly=null,b.prototype.trx=null,b.prototype.try=null,b.prototype.brx=null,b.prototype.bry=null,b.prototype.blx=null,b.prototype.bly=null,b.prototype.cx=null,b.prototype.cy=null,b.prototype.trf=null,b.prototype.cTrf=null,b.prototype._vertices=null,b.prototype._extTransform=null,b.prototype.getTransform=function(){return this.trf},b.prototype.setTransform=function(a){this.trf=a},b.prototype.transform=function(a){a&&!a.isIdentity()&&(this.trf=this.trf?this.trf.multiplied(a):a)},b.prototype.rewindVertices=function(a){return(null==this._vertices||this._verticesDirty||0==this._vertices.getCount())&&(this._vertices.clearVertices(),this._generateVertices(),this._verticesDirty=!1),this._vertices.rewindVertices(a)},b.prototype.readVertex=function(a){return this._vertices.readVertex(a)},b.prototype._calculateGeometryBBox=function(){for(var a=this._getPoint(b.Handles.ROTATION_CENTER),c=a.getX(),d=c,e=a.getY(),f=e,g=[b.Handles.TOP_LEFT,b.Handles.TOP_RIGHT,b.Handles.BOTTOM_RIGHT,b.Handles.BOTTOM_LEFT],h=0;h<g.length;++h){var i=this._getPoint(g[h]);c>i.getX()&&(c=i.getX()),d<i.getX()&&(d=i.getX()),e>i.getY()&&(e=i.getY()),f<i.getY()&&(f=i.getY())}return new GRect(c,e,d-c,f-e)},b.prototype._calculatePaintBBox=function(){var a=this._calculateGeometryBBox();return a?a=a.expanded(b.ANNOT_SIZE,b.ANNOT_SIZE,b.ANNOT_SIZE,b.ANNOT_SIZE):null},b.prototype.paint=function(a,c){var d=c.canvas.resetTransform();if(this._extTransform=a?d.multiplied(a):d,this._verticesDirty=!0,!this._centerOnly){if(!this.rewindVertices(0))return;c.canvas.putVertices(new GVertexPixelAligner(this)),c.canvas.strokeVertices(GRGBColor.BLACK,1);for(var e=this._collectResizeHandles(a),f=0;f<e.length;++f){var g=this._getPoint(e[f]);ifAnnotation.paintAnnotation(c,null,g,ifAnnotation.AnnotType.Rectangle,!1,b.ANNOT_SIZE,GRGBColor.WHITE,GRGBColor.BLACK)}}ifAnnotation.paintAnnotation(c,null,this._getPoint(b.Handles.ROTATION_CENTER),ifAnnotation.AnnotType.Circle,!1,b.ANNOT_SIZE,GRGBColor.WHITE,GRGBColor.BLACK),c.canvas.setTransform(d),this._extTransform=null},b.prototype.hide=function(){this._centerOnly=!0},b.prototype.show=function(){this._centerOnly=!1},b.prototype.setCenterTransform=function(a){this.cTrf=a},b.prototype.getPartInfoAt=function(a,c,d){var e=null;c&&(this._extTransform=c,this._verticesDirty=!0);var f=this._collectResizeHandles(c);f.push(b.Handles.ROTATION_CENTER);for(var g=0;g<f.length;++g){var h=this._getPoint(f[g]);if(ifAnnotation.getAnnotationBBox(null,h,b.ANNOT_SIZE).expanded(d,d,d,d).containsPoint(a)){e=new GElementEditor.PartInfo(null,f[g],h);break}}if(!e){var i=new GVertexInfo.HitResult;if(ifVertexInfo.hitTest(a.getX(),a.getY(),this,d,!0,i))if(i.outline){var j=i.segment%2;e=new GElementEditor.PartInfo(null,b.OUTLINE,j)}else e=new GElementEditor.PartInfo(null,b.INSIDE,null);else{var k=this.getRotationSegment(a,c);e=new GElementEditor.PartInfo(null,b.OUTSIDE,k)}}return this._extTransform=null,e},b.prototype.getRotationSegment=function(a,b){var c=0,d=b.mapPoint(new GPoint(this.cx,this.cy)),e=Math.atan2(a.getY()-d.getY(),a.getX()-d.getX())+7*Math.PI/8;return 0>e&&(e+=GMath.PI2),c=Math.floor(e/(Math.PI/4)),(0>c||c>7)&&(c=7),c},b.prototype.calculateTransformation=function(a,c,d,e,f,g,h){var i=d.subtract(c),j=i.getX(),k=i.getY(),l=function(a,b,c,d){var f=e.mapPoint(new GPoint(a+j,b+k));c&&(j=f.getX()-a),d&&(k=f.getY()-b)}.bind(this);if(a.id<8){var m=[GRect.Side.TOP_LEFT,GRect.Side.TOP_CENTER,GRect.Side.TOP_RIGHT,GRect.Side.RIGHT_CENTER,GRect.Side.BOTTOM_RIGHT,GRect.Side.BOTTOM_CENTER,GRect.Side.BOTTOM_LEFT,GRect.Side.LEFT_CENTER],n=new GRect(this.tlx,this.tly,this.brx-this.tlx,this.bry-this.tly),o=m[a.id],p=n.getSide(o);return l(p.getX(),p.getY(),!0,!0),n.getResizeTransform(o,j,k,g,f)}if(a.id==b.Handles.ROTATION_CENTER)return l(this.cx,this.cy,!0,!0),new GTransform(1,0,0,1,j,k);if(a.id==b.OUTSIDE){transform1=new GTransform(1,0,0,1,-this.cx,-this.cy),transform3=new GTransform(1,0,0,1,this.cx,this.cy);var q=Math.atan2(c.getY()-this.cy,c.getX()-this.cx),r=Math.atan2(d.getY()-this.cy,d.getX()-this.cx),s=q-r;if(g){var t=h?h:Math.PI/12;s=Math.round(s/t)*t}var u=Math.cos(s),v=Math.sin(s),w=new GTransform(u,-v,v,u,0,0);return transform1.multiplied(w).multiplied(transform3)}if(a.id==b.OUTLINE){if(transform1=new GTransform(1,0,0,1,-this.cx,-this.cy),transform3=new GTransform(1,0,0,1,this.cx,this.cy),g&&h){var t=h?h:20;j=Math.round(j/t)*t,k=Math.round(k/t)*t}var w=new GTransform(1,2*k/(this.brx-this.tlx),2*-j/(this.bry-this.tly),1,0,0);return transform1.multiplied(w).multiplied(transform3)}var x=(this.brx-this.tlx)/3,y=(this.bry-this.tly)/3,z=this.cx,A=this.cy;return c.getX()<=this.tlx+x?z=this.tlx:c.getX()>=this.tlx+2*x&&(z=this.brx),c.getY()<=this.tly+y?A=this.tly:c.getY()>=this.tly+2*y&&(A=this.bry),l(z,A,!0,!0),new GTransform(1,0,0,1,j,k)},b.prototype.applyCenterTransform=function(){if(this.trf||this.cTrf){var a=this.trf?this.trf:this.cTrf,b=a.mapPoint(new GPoint(this.cx,this.cy));this.cTrf=null,this.trf=null,this.cx=b.getX(),this.cy=b.getY()}},b.prototype._generateVertices=function(){this._vertices&&5==this._vertices.getCount()?this._vertices.rewindVertices(0):this._vertices=new GVertexContainer;var a=this._getPoint(b.Handles.TOP_LEFT),c=this._getPoint(b.Handles.TOP_RIGHT),d=this._getPoint(b.Handles.BOTTOM_RIGHT),e=this._getPoint(b.Handles.BOTTOM_LEFT);this._vertices.addVertex(GVertex.Command.Move,a.getX(),a.getY()),this._vertices.addVertex(GVertex.Command.Line,c.getX(),c.getY()),this._vertices.addVertex(GVertex.Command.Line,d.getX(),d.getY()),this._vertices.addVertex(GVertex.Command.Line,e.getX(),e.getY()),this._vertices.addVertex(GVertex.Command.Close)},b.prototype._getPoint=function(a,c){var d=null,e=function(a,b){var d=b?b:this.trf,e=this._extTransform;return d&&!c&&(e=e?d.multiplied(e):d),e&&a&&(a=e.mapPoint(a)),a}.bind(this);switch(a){case b.Handles.TOP_LEFT:d=e(new GPoint(this.tlx,this.tly)),d=new GPoint(d.getX()-b.TRANSFORM_MARGIN,d.getY()-b.TRANSFORM_MARGIN);break;case b.Handles.TOP_CENTER:d=e(new GPoint((this.tlx+this.trx)/2,(this.tly+this.try)/2)),d=new GPoint(d.getX(),d.getY()-b.TRANSFORM_MARGIN);break;case b.Handles.TOP_RIGHT:d=e(new GPoint(this.trx,this.try)),d=new GPoint(d.getX()+b.TRANSFORM_MARGIN,d.getY()-b.TRANSFORM_MARGIN);break;case b.Handles.RIGHT_CENTER:d=e(new GPoint((this.trx+this.brx)/2,(this.try+this.bry)/2)),d=new GPoint(d.getX()+b.TRANSFORM_MARGIN,d.getY());break;case b.Handles.BOTTOM_RIGHT:d=e(new GPoint(this.brx,this.bry)),d=new GPoint(d.getX()+b.TRANSFORM_MARGIN,d.getY()+b.TRANSFORM_MARGIN);break;case b.Handles.BOTTOM_CENTER:d=e(new GPoint((this.blx+this.brx)/2,(this.bly+this.bry)/2)),d=new GPoint(d.getX(),d.getY()+b.TRANSFORM_MARGIN);break;case b.Handles.BOTTOM_LEFT:d=e(new GPoint(this.blx,this.bly)),d=new GPoint(d.getX()-b.TRANSFORM_MARGIN,d.getY()+b.TRANSFORM_MARGIN);break;case b.Handles.LEFT_CENTER:d=e(new GPoint((this.tlx+this.blx)/2,(this.tly+this.bly)/2)),d=new GPoint(d.getX()-b.TRANSFORM_MARGIN,d.getY());break;case b.Handles.ROTATION_CENTER:d=e(new GPoint(this.cx,this.cy),this.cTrf)}return d},b.prototype._collectResizeHandles=function(a){var c=new GRect(this.tlx,this.tly,this.brx-this.tlx,this.bry-this.tly);c=this.trf?this.trf.mapRect(c):c;var d=a?a.mapRect(c):c,e=[];return d.getHeight()>2*(b.ANNOT_SIZE+2)&&d.getWidth()>2*(b.ANNOT_SIZE+2)&&(e=e.concat([b.Handles.TOP_LEFT,b.Handles.TOP_RIGHT,b.Handles.BOTTOM_LEFT,b.Handles.BOTTOM_RIGHT])),d.getHeight()>3*(b.ANNOT_SIZE+2)&&(e=e.concat([b.Handles.RIGHT_CENTER,b.Handles.LEFT_CENTER])),d.getWidth()>3*(b.ANNOT_SIZE+2)&&(e=e.concat([b.Handles.TOP_CENTER,b.Handles.BOTTOM_CENTER])),e},b.prototype.toString=function(){return"[GTransformBox]"},a.GTransformBox=b}(this),function(a){function b(a){this._element=a}GObject.inherit(b,GObject),b._Editors={},b.exports=function(a,c){b._Editors[GObject.getTypeId(c)]=a},b.OPTIONS={annotationSizeRegular:6,annotationSizeSmall:4,centerCrossSize:4},b.Flag={Selected:1,Highlighted:2,Detail:4,Outline:8},b.Annotation={Rectangle:ifAnnotation.AnnotType.Rectangle,Circle:ifAnnotation.AnnotType.Circle,Diamond:ifAnnotation.AnnotType.Diamond},b.DropType={Pattern:0,Text:1,Node:2},b.getEditor=function(a){return a.__editor__?a.__editor__:null},b.createEditor=function(a){var c=b._Editors[GObject.getTypeId(a)];return c?new c(a):null},b.openEditor=function(a){if(!a.isAttached())throw new Error("Node is not attached to create an editor for.");if(null!=b.getEditor(a))return b.getEditor(a);var c=b.createEditor(a);if(!c)return null;for(var d=a.getParent();null!==d;d=d.getParent()){var e=b.getEditor(d);if(e||(e=b.openEditor(d)),e){for(var f=null,g=a.getNext();null!=g;g=g.getNext()){var h=b.getEditor(g);if(h){f=h;break}}e.insertEditor(c,f);break}}return c._attach(),a.__editor__=c,c},b.closeEditor=function(a){var c=b.getEditor(a);if(c){var d=b._Editors[GObject.getTypeId(a)];if(!d)return;var e=c.getEditors();if(e)for(var f=0;f<e.length;++f)b.closeEditor(e[f].getElement());c.getParentEditor()&&c.getParentEditor().removeEditor(c),c._detach(),delete a.__editor__}},b.PartInfo=function(a,b,c,d,e){this.editor=a,this.id=b,this.data=c,this.isolated=d,this.selectable=e},b.PartInfo.prototype.id=null,b.PartInfo.prototype.data=null,b.PartInfo.prototype.editor=null,b.PartInfo.prototype.isolated=null,b.PartInfo.prototype.selectable=null,b.prototype._flags=0,b.prototype._element=null,b.prototype._elementPreview=null,b.prototype._transform=null,b.prototype._parentEditor=null,b.prototype._editors=null,b.prototype._partSelection=null,b.prototype.hasFlag=function(a){return 0!=(this._flags&a)},b.prototype.setFlag=function(a){0==(this._flags&a)&&(this.requestInvalidation(),this._flags=this._flags|a,this.requestInvalidation())},b.prototype.removeFlag=function(a){0!=(this._flags&a)&&(this.requestInvalidation(),this._flags=this._flags&~a,this.requestInvalidation())},b.prototype.getElement=function(){return this._element},b.prototype.getPaintElement=function(){return this._elementPreview?this._elementPreview:this._element},b.prototype.getParentEditor=function(){return this._parentEditor},b.prototype.getEditors=function(){return this._editors},b.prototype.appendEditor=function(a){this.insertEditor(a,null)},b.prototype.insertEditor=function(a,b){var c=this._editors?this._editors.length:0;if(b&&(c=this._editors.indexOf(b),0>c))throw new Error("Unknown reference editor.");if(null!=a._parentEditor)throw new Error("Editor already appended.");this._editors||(this._editors=[]),c>=this._editors.length?this._editors.push(a):this._editors.splice(c,0,a),a._parentEditor=this},b.prototype.removeEditor=function(a){var b=this._editors.indexOf(a);if(0>b)throw new Error("Unknown editor.");this._editors.splice(b,1),a._parentEditor=null},b.prototype.accept=function(a){if(a.call(null,this)===!1)return!1;if(this._editors)for(var b=0;b<this._editors.length;++b)if(this._editors[b].accept(a)===!1)return!1;return!0},b.prototype.isPartSelected=function(a){return this._indexOfPartId(this._partSelection,a)>=0},b.prototype.getPartSelection=function(){return this._partSelection},b.prototype.updatePartSelection=function(a,c){if(this.hasFlag(b.Flag.Selected)){var d=null;if(a&&this._partSelection){if(c){d=[];for(var e=0;e<this._partSelection.length;++e)this._indexOfPartId(c,this._partSelection[e])<0&&d.push(this._partSelection[e]);for(var e=0;e<c.length;++e)this._indexOfPartId(this._partSelection,c[e])<0&&d.push(c[e]);0===d.length&&(d=null)}}else d=c&&c.length>0?c.slice():null;GUtil.equals(d,this._partSelection,!1)||this._updatePartSelection(d)}},b.prototype.isPartSelectionUnderCollisionAllowed=function(){return!1},b.prototype.updatePartSelectionUnderCollision=function(){return!1},b.prototype.isDeletePartsAllowed=function(){return!1},b.prototype.deletePartsSelected=function(){},b.prototype.isAlignPartsAllowed=function(){return!1},b.prototype.alignParts=function(){},b.prototype.getPartInfoAt=function(a,b,c,d){if(d=d||0,this._editors&&this._editors.length)for(var e=this._editors.length-1;e>=0;--e){var f=this._editors[e].getPartInfoAt(a,b,c,d);if(f)return f}if(c&&c.call(null,this)!==!0)return null;var g=this.getBBox(b);if(g&&!g.isEmpty()&&g.containsPoint(a)){var f=this._getPartInfoAt(a,b,d);if(f)return f}return null},b.prototype.paint=function(a,b){this._paintChildren(a,b)},b.prototype.getBBox=function(a){if(this.hasFlag(b.Flag.Selected)||this.hasFlag(b.Flag.Highlighted)){var c=a;this._transform&&(c=this._transform.multiplied(a));var d=this.getPaintElement().getGeometryBBox();if(d&&!d.isEmpty()){var e=this.getBBoxMargin();if(d=c.mapRect(d).expanded(e,e,e,e),this.hasFlag(b.Flag.Detail)){var f=this.getCustomBBox(c,!1);f&&(d=d.united(f))}}return d}return null},b.prototype.getBBoxMargin=function(){return 1},b.prototype.getCustomBBox=function(){return null},b.prototype.requestInvalidation=function(a){GEditor.getEditor(this._element.getScene()).requestInvalidation(this,a)},b.prototype.invalidate=function(a,b){return b?null:this.getBBox(a)},b.prototype.movePart=function(){this.hasFlag(b.Flag.Outline)?this.requestInvalidation():this.setFlag(b.Flag.Outline)},b.prototype.resetPartMove=function(){this._elementPreview=null,this.removeFlag(b.Flag.Outline)},b.prototype.applyPartMove=function(){this._elementPreview=null,this.removeFlag(b.Flag.Outline)},b.prototype.transform=function(a){this._setTransform(a)},b.prototype.resetTransform=function(){this._elementPreview=null,this.requestInvalidation(),this._transform=null,this.removeFlag(b.Flag.Outline)},b.prototype.canApplyTransform=function(){var a=this.getElement();return this._transform&&!this._transform.isIdentity()&&a.hasMixin(GElement.Transform)&&!a.hasFlag(GElement.Flag.Locked)},b.prototype.applyTransform=function(a){this._transform.isIdentity()||a.transform(this._transform),this.resetTransform()},b.prototype.acceptDrop=function(a,c,d,e){if(this._editors)for(var f=0;f<this._editors.length;++f)if(this._editors[f].acceptDrop(a,c,d,e)===!0)return!0;if(c===b.DropType.Node&&d&&d instanceof GStyle&&this._element.hasMixin(GElement.Stylable)){var g=GEditor.getEditor(this._element.getScene());g.beginTransaction();try{this._element.assignFrom(d),this._element.setProperty("sref",null!==d.getProperty("_sdf")?null:d.getReferenceId())}finally{g.commitTransaction("Drag Style")}return!0}return!1},b.prototype.initialSetup=function(){},b.prototype.canInlineEdit=function(){return!1},b.prototype.isInlineEdit=function(){return!1},b.prototype.beginInlineEdit=function(){throw new Error("Not Supported.")},b.prototype.adjustInlineEditForView=function(){throw new Error("Not Supported.")},b.prototype.finishInlineEdit=function(){throw new Error("Not Supported.")},b.prototype.subSelectDragStartAction=function(a){var b=null;if(this._editors)for(var c=0;c<this._editors.length;++c)if(b=this._editors[c].subSelectDragStartAction(a))return b;return a.editor===this&&(b=a),b},b.prototype.validateSelectionChange=function(){return!0},b.prototype._attach=function(){},b.prototype._detach=function(){},b.prototype._paintChildren=function(a,c){if(this._editors)for(var d=0;d<this._editors.length;++d){var e=this._editors[d];e instanceof b&&e.paint(a,c)}},b.prototype._getPartInfoAt=function(){return null},b.prototype._partIdAreEqual=function(a,b){return a===b},b.prototype._indexOfPartId=function(a,b){if(a&&a.length>0)for(var c=0;c<a.length;++c)if(this._partIdAreEqual(a[c],b))return c;return-1},b.prototype._updatePartSelection=function(a){this.requestInvalidation(),this._partSelection=a,this.requestInvalidation()},b.prototype._paintAnnotation=function(a,c,d,e,f,g){var h=g?b.OPTIONS.annotationSizeSmall:b.OPTIONS.annotationSizeRegular;ifAnnotation.paintAnnotation(a,c,d,e,f,h)},b.prototype._getAnnotationBBox=function(a,c,d){var e=d?b.OPTIONS.annotationSizeSmall:b.OPTIONS.annotationSizeRegular;return ifAnnotation.getAnnotationBBox(a,c,e)},b.prototype._showAnnotations=function(){return this.hasFlag(b.Flag.Selected)&&!this.hasFlag(b.Flag.Outline)},b.prototype._setTransform=function(a){GTransform.equals(this._transform,a)||(this.hasFlag(b.Flag.Outline)?this.requestInvalidation():this.setFlag(b.Flag.Outline),this._transform=a,this.requestInvalidation())},b.prototype.toString=function(){return"[Object GElementEditor]"},a.GElementEditor=b}(this),function(a){function b(a){GElementEditor.call(this,a)}GObject.inherit(b,GElementEditor),b.Flag={ResizeEdges:1024,ResizeCenters:2048,ResizeAll:3072},b.RESIZE_HANDLE_PART_ID=GUtil.uuid(),b.prototype.getBBoxMargin=function(){return this._showResizeHandles()?GElementEditor.OPTIONS.annotationSizeSmall+1:GElementEditor.prototype.getBBoxMargin.call(this)},b.prototype.movePart=function(a,c,d,e,f,g,h){if(GElementEditor.prototype.movePart.call(this,a,c,d,e,f,g,h),a===b.RESIZE_HANDLE_PART_ID){var i=e.mapPoint(d);i=f.mapPoint(i);var j=i.subtract(c.point),k=this._element.getGeometryBBox(),l=k.getResizeTransform(c.side,j.getX(),j.getY(),g,h);this.transform(l)}},b.prototype.applyPartMove=function(a,c){a===b.RESIZE_HANDLE_PART_ID&&this.applyTransform(this._element),GElementEditor.prototype.applyPartMove.call(this,a,c)},b.prototype.paint=function(a,b){if(this.hasFlag(GElementEditor.Flag.Selected)||this.hasFlag(GElementEditor.Flag.Highlighted)){var c=a;this._transform&&(c=this._transform.multiplied(a)),this._prePaint(c,b),this._showResizeHandles()&&this._iterateResizeHandles(function(c){this._paintAnnotation(b,a,c,GElementEditor.Annotation.Rectangle,!1,!0)}.bind(this),a),this._postPaint(c,b)}this._paintChildren(a,b)},b.prototype._getPartInfoAt=function(a,c){if(this._showResizeHandles()){var d=null;if(this._iterateResizeHandles(function(e,f){return this._getAnnotationBBox(c,e).containsPoint(a)?(d=new GElementEditor.PartInfo(this,b.RESIZE_HANDLE_PART_ID,{side:f,point:e},!0,!1),!0):void 0}.bind(this),c),d)return d}return null},b.prototype._prePaint=function(){},b.prototype._postPaint=function(){},b.prototype._showResizeHandles=function(){return this._showAnnotations()&&(this.hasFlag(b.Flag.ResizeEdges)||this.hasFlag(b.Flag.ResizeCenters))},b.prototype._iterateResizeHandles=function(a,c){var d=this.getPaintElement().getGeometryBBox();if(d&&!d.isEmpty()){var e=[],f=c?c.mapRect(d):d;this.hasFlag(b.Flag.ResizeEdges)&&f.getHeight()>2*(GElementEditor.OPTIONS.annotationSizeSmall+2)&&f.getWidth()>2*(GElementEditor.OPTIONS.annotationSizeSmall+2)&&(e=e.concat([GRect.Side.TOP_LEFT,GRect.Side.TOP_RIGHT,GRect.Side.BOTTOM_LEFT,GRect.Side.BOTTOM_RIGHT])),this.hasFlag(b.Flag.ResizeCenters)&&(f.getHeight()>3*(GElementEditor.OPTIONS.annotationSizeSmall+2)&&(e=e.concat([GRect.Side.RIGHT_CENTER,GRect.Side.LEFT_CENTER])),f.getWidth()>3*(GElementEditor.OPTIONS.annotationSizeSmall+2)&&(e=e.concat([GRect.Side.TOP_CENTER,GRect.Side.BOTTOM_CENTER])));for(var g=0;g<e.length;++g){var h=e[g],i=d.getSide(h);if(a(i,h)===!0)break}}},b.prototype._paintBBoxOutline=function(a,b,c){var d=this._element.getGeometryBBox(),e=a.mapRect(d);if(e&&!e.isEmpty()){var f=Math.floor(e.getX()),g=Math.floor(e.getY()),h=Math.ceil(e.getX()+e.getWidth())-f,i=Math.ceil(e.getY()+e.getHeight())-g;c||(c=this.hasFlag(GElementEditor.Flag.Highlighted)?b.highlightOutlineColor:b.selectionOutlineColor),b.canvas.strokeRect(f+.5,g+.5,h,i,1,c)}},b.prototype.toString=function(){return"[Object GBlockEditor]"},a.GBlockEditor=b}(this),function(a){function b(a){GElementEditor.call(this,a)}GObject.inherit(b,GElementEditor),GElementEditor.exports(b,GScene),b.prototype._transformBox=null,b.prototype._visuals=null,b.prototype._visualsArea=null,b.TBoxMode={NA:0,PASSIVE:1,TBOXMOVE:2,CNTRMOVE:3,ROTATE:4,RESIZE:5,SKEW:6},b.prototype._tBoxMode=b.TBoxMode.NA,b.prototype._tBoxData=null,b.prototype._mouseInfo=null,b.prototype.paint=function(a,b){if(GElementEditor.prototype.paint.call(this,a,b),this._transformBox&&(this._transformBox.paint(a,b),this._visuals)){for(var c,d=0;d<this._visuals.length;++d){c=this._visuals[d];var e=c[0],f=c[1];b.canvas.strokeLine(Math.floor(e.getX())+.5,Math.floor(e.getY())+.5,Math.floor(f.getX())+.5,Math.floor(f.getY())+.5,1,b.highlightOutlineColor)}this._visuals=null}},b.prototype.getBBox=function(a){var b=GElementEditor.prototype.getBBox.call(this,a);if(this._transformBox){var c=this._transformBox._calculateGeometryBBox();c&&!c.isEmpty()&&(c=a?a.mapRect(c):c,c=c.expanded(GTransformBox.ANNOT_SIZE,GTransformBox.ANNOT_SIZE,GTransformBox.ANNOT_SIZE,GTransformBox.ANNOT_SIZE),b=b?b.united(c):c)}return b},b.prototype._detach=function(){this._transformBox&&this.setTransformBoxActive(!1)},b.prototype.isTransformBoxActive=function(){return null!=this._transformBox},b.prototype.setTransformBoxActive=function(a,b){a||null===a?(this._transformBox||this._element.addEventListener(GElement.GeometryChangeEvent,this._geometryChange,this),this._updateSelectionTransformBox(b)):this._transformBox&&(this._element.removeEventListener(GElement.GeometryChangeEvent,this._geometryChange,this),this.requestInvalidation(),this._transformBox=null,this.requestInvalidation())},b.prototype.getTransformBox=function(){return this._transformBox},b.prototype.requestInvalidation=function(a){this._getGraphicEditor().requestInvalidation(this,a)},b.prototype.getTBoxMode=function(){return this._tBoxMode},b.prototype._updateTBoxMode=function(a){this._tBoxMode=a},b.prototype.hideTransformBox=function(){this._transformBox&&this._transformBox.hide(),this.requestInvalidation()},b.prototype.showTransformBox=function(){this._transformBox&&this._transformBox.show(),this.requestInvalidation()},b.prototype.getTransformBoxCenter=function(){return this._transformBox?new GPoint(this._transformBox.cx,this._transformBox.cy):null},b.prototype._applyTBoxCenterTransform=function(){if(this._transformBox&&(this._transformBox.trf||this._transformBox.cTrf)){this._getGraphicEditor().beginTransaction();try{this._transformBox.applyCenterTransform()}finally{this._getGraphicEditor().commitTransaction("Move")}this.requestInvalidation()}},b.prototype.getCursor=function(a){var b=GCursor.Select;switch(a.id){case GTransformBox.INSIDE:b=GCursor.SelectCross;break;case GTransformBox.OUTSIDE:b=GCursor.SelectRotate[a.data];break;case GTransformBox.OUTLINE:b=a.data?GCursor.SelectSkewHoriz:GCursor.SelectSkewVert;
break;case GTransformBox.Handles.TOP_CENTER:case GTransformBox.Handles.BOTTOM_CENTER:b=GCursor.SelectResizeVert;break;case GTransformBox.Handles.LEFT_CENTER:case GTransformBox.Handles.RIGHT_CENTER:b=GCursor.SelectResizeHoriz;break;case GTransformBox.Handles.TOP_LEFT:case GTransformBox.Handles.BOTTOM_RIGHT:b=GCursor.SelectResizeUpLeftDownRight;break;case GTransformBox.Handles.TOP_RIGHT:case GTransformBox.Handles.BOTTOM_LEFT:b=GCursor.SelectResizeUpRightDownLeft;break;case GTransformBox.Handles.ROTATION_CENTER:b=GCursor.SelectArrowOnly}return b},b.prototype.updateTBoxUnderMouse=function(a,c,d){var e=null;this._tBoxData?(e=new GElementEditor.PartInfo(this._tBoxData.editor,this._tBoxData.id,this._tBoxData.data),e.id==GTransformBox.OUTSIDE&&(e.data=this._transformBox.getRotationSegment(a,c))):e=this._transformBox.getPartInfoAt(a,c,this._element.getProperty("pickDist")),this._mouseInfo&&this._mouseInfo.id==e.id&&this._mouseInfo.data==e.data||(this._mouseInfo=e,d.setCursor(this.getCursor(this._mouseInfo)));var f=null;if(this._visuals=null,this._tBoxMode==b.TBoxMode.PASSIVE&&this._mouseInfo.id==GTransformBox.INSIDE){var g=this._getGraphicEditor().getSelection(),h=GElement.prototype.getGroupGeometryBBox(g);if(h&&!h.isEmpty()){f=c.mapRect(h);var i=this._getGraphicEditor().getGuides().getBBoxSnapZones(f,a);i&&i.length&&(this._visuals=i)}}var j=this._visuals?f.expanded(2,2,2,2):null;j=j?d.getViewTransform().mapRect(j):null,(this._visualsArea||j)&&(this._visualsArea,this.requestInvalidation(),this._visualsArea=j,this.requestInvalidation())},b.prototype.getTBoxPartInfoAt=function(a,b,c){return this._transformBox.getPartInfoAt(a,b,c)},b.prototype.startTBoxTransform=function(a){this._visualsArea&&(this.requestInvalidation(),this._visualsArea=null),this._tBoxData=new GElementEditor.PartInfo(a.editor,a.id,a.data),this._updateTBoxMode(this._tBoxData.id==GTransformBox.OUTLINE?b.TBoxMode.SKEW:this._tBoxData.id==GTransformBox.OUTSIDE?b.TBoxMode.ROTATE:this._tBoxData.id>=0&&this._tBoxData.id<GTransformBox.Handles.ROTATION_CENTER?b.TBoxMode.RESIZE:this._tBoxData.id==GTransformBox.Handles.ROTATION_CENTER?b.TBoxMode.CNTRMOVE:b.TBoxMode.TBOXMOVE),this.hideTransformBox()},b.prototype.transformTBox=function(a,c,d,e,f){if(this._tBoxMode!=b.TBoxMode.PASSIVE&&this._tBoxMode!=b.TBoxMode.NA){var g=this._getGraphicEditor().getGuides();g.getShapeBoxGuide().useExclusions(this._getGraphicEditor().getSelection()),g.beginMap();var h=f;h||this._tBoxMode!=b.TBoxMode.SKEW||(h=this._element.getProperty("gridSizeX"));var i=this._transformBox.calculateTransformation(this._tBoxData,a,c,g,d,e,h);g.finishMap(),this.requestInvalidation(),this._tBoxMode!=b.TBoxMode.CNTRMOVE?(this._transformBox.setTransform(i),this._getGraphicEditor().transformSelection(i,null,null)):(this._transformBox.setCenterTransform(i),this.requestInvalidation())}},b.prototype.applyTBoxTransform=function(a){this._tBoxMode==b.TBoxMode.CNTRMOVE?(this._applyTBoxCenterTransform(),this.showTransformBox()):this._getGraphicEditor().applySelectionTransform(a),this._updateTBoxMode(b.TBoxMode.PASSIVE),this._tBoxData=null,this._mouseInfo=null},b.prototype._updateSelectionTransformBox=function(a){this.requestInvalidation();var c=null,d=null;a?(c=a.getX(),d=a.getY()):this._transformBox&&(c=this._transformBox.cx,d=this._transformBox.cy),this._transformBox=null;var e=this._getGraphicEditor().getSelection(),f=GElement.prototype.getGroupGeometryBBox(e);f&&(this._transformBox=new GTransformBox(f,c,d)),this.requestInvalidation(),this._updateTBoxMode(this._transformBox?b.TBoxMode.PASSIVE:b.TBoxMode.NA),this._tBoxData=null,this._mouseInfo=null,this._visualsArea&&(this._visualsArea=null)},b.prototype._geometryChange=function(a){this._transformBox&&a.type==GElement.GeometryChangeEvent.Type.After&&a.element.hasFlag(GNode.Flag.Selected)&&((this._transformBox.trf||this._transformBox.cTrf)&&this._transformBox.applyCenterTransform(),this._updateSelectionTransformBox())},b.prototype._getGraphicEditor=function(){return this._element.__graphic_editor__},b.prototype.toString=function(){return"[Object GSceneEditor]"},a.GSceneEditor=b}(this),function(a){function b(a){GBlockEditor.call(this,a),this._flags|=GBlockEditor.Flag.ResizeAll}GObject.inherit(b,GBlockEditor),GElementEditor.exports(b,GGroup),b.prototype._prePaint=function(a,b){(this.hasFlag(GElementEditor.Flag.Selected)||this.hasFlag(GElementEditor.Flag.Highlighted))&&this._paintBBoxOutline(a,b),GBlockEditor.prototype._prePaint.call(this,a,b)},b.prototype.toString=function(){return"[Object GGroupEditor]"},a.GGroupEditor=b}(this),function(a){function b(a){GBlockEditor.call(this,a)}GObject.inherit(b,GBlockEditor),b.prototype.initialSetup=function(){var a=this.getElement(),b=a.getScene().getStyleCollection().querySingle('style[_sdf="shape"]');b&&a.assignStyleFrom(b)},b.prototype.acceptDrop=function(a,b,c,d){if(GElementEditor.prototype.acceptDrop.call(this,a,b,c,d)===!1){if(c instanceof GPattern&&d instanceof GShape.HitResult){var e=GEditor.getEditor(this.getElement().getScene());e.beginTransaction();try{switch(d.type){case GShape.HitResult.Type.Border:this.getElement().setProperty("_bpt",c);break;default:this.getElement().setProperty("_fpt",c)}}finally{e.commitTransaction("Drop Pattern")}}return!0}return!0},b.prototype._hasCenterCross=function(){return!1},b.prototype._prePaint=function(a,b){if(this.hasFlag(GElementEditor.Flag.Selected)||this.hasFlag(GElementEditor.Flag.Highlighted)){var c=this.getPaintElement(),d=new GVertexTransformer(c,a);b.canvas.putVertices(new GVertexPixelAligner(d)),b.canvas.strokeVertices(this.hasFlag(GElementEditor.Flag.Highlighted)?b.highlightOutlineColor:b.selectionOutlineColor,1)}},b.prototype._postPaint=function(a,b){if(this.hasFlag(GElementEditor.Flag.Selected)&&this.hasFlag(GElementEditor.Flag.Detail)&&this._hasCenterCross()){var c=this.getPaintElement(),d=c.getTransform(),e=d?d:new GTransform(1,0,0,1,0,0);e=a?e.multiplied(a):e;var f=2*GElementEditor.OPTIONS.centerCrossSize,g=e.getMatrix();if(Math.abs(g[0])*c.getOrigHalfWidth()>f&&Math.abs(g[3])*c.getOrigHalfHeight()>f){var h=e.mapPoint(c.getCenter(!1)),i=Math.floor(h.getX())+.5,j=Math.floor(h.getY())+.5,k=GElementEditor.OPTIONS.centerCrossSize/2;b.canvas.strokeLine(i-k,j-k,i+k,j+k,1,b.selectionOutlineColor),b.canvas.strokeLine(i+k,j-k,i-k,j+k,1,b.selectionOutlineColor)}}},b.prototype.toString=function(){return"[Object GShapeEditor]"},a.GShapeEditor=b}(this),function(a){function b(a){GShapeEditor.call(this,a)}GObject.inherit(b,GShapeEditor),b.prototype.toString=function(){return"[Object GPathBaseEditor]"},a.GPathBaseEditor=b}(this),function(a){function b(a){GShapeEditor.call(this,a),this._flags|=GBlockEditor.Flag.ResizeAll}GObject.inherit(b,GShapeEditor),GElementEditor.exports(b,GText),b.prototype._inlineEditor=null,b.prototype.getProperty=function(a,b){if(!this.isInlineEdit())return this.getElement().getProperty(a);var c=null,d=null,e=rangy.getSelection();if(e.rangeCount)for(var f=e.getRangeAt(0),g=f.collapsed?[f.startContainer]:f.getNodes(),h=0;h<g.length;++h){var i=g[h];if(3===i.nodeType)for(var j=i.parentNode;null!==j;j=j.parentNode)1===j.nodeType&&("p"===j.nodeName.toLowerCase()?c||(c=j):"span"===j.nodeName.toLowerCase()&&(d||f.collapsed||(d=j)))}return GStylable.PropertySetInfo[GStylable.PropertySet.Text].geometryProperties.hasOwnProperty(a)?d?GText.Block.cssToProperty(a,b?window.getComputedStyle(d):d.style):c?GText.Block.cssToProperty(a,b?window.getComputedStyle(c):c.style):this.getElement().getProperty(a):GStylable.PropertySetInfo[GStylable.PropertySet.Paragraph].geometryProperties.hasOwnProperty(a)?c?GText.Paragraph.cssToProperty(a,b?window.getComputedStyle(c):c.style):this.getElement().getProperty(a):void 0},b.prototype.setProperties=function(a,b){for(var c=[],d=[],e=[],f=[],g=[],h=[],i=0;i<a.length;++i)GText.GeometryProperties.hasOwnProperty(a[i])?(c.push(a[i]),d.push(b[i])):GStylable.PropertySetInfo[GStylable.PropertySet.Text].geometryProperties.hasOwnProperty(a[i])?(e.push(a[i]),f.push(b[i])):(g.push(a[i]),h.push(b[i]));this.isInlineEdit()?setTimeout(function(){for(var a={},b=0;b<e.length;++b)GText.Block.propertyToCss(e[b],f[b],a);for(var c={},b=0;b<g.length;++b)GText.Paragraph.propertyToCss(g[b],h[b],c);this._inlineEditor.focus(),this._savedSelection&&(rangy.restoreSelection(this._savedSelection),this._savedSelection=rangy.saveSelection());var d=rangy.getSelection();if(d.rangeCount)for(var i=d.getRangeAt(0),j=i.collapsed?[i.startContainer]:i.getNodes(),b=0;b<j.length;++b){var k=j[b];if(3===k.nodeType)for(var l=k.parentNode;null!==l;l=l.parentNode)if(1===l.nodeType&&"p"===l.nodeName.toLowerCase()){for(var m in c)l.style[m]=c[m];if(d.isCollapsed)for(var m in a)l.style[m]=a[m];break}}!d.isCollapsed,this._triggerSelectionChanged()}.bind(this),0):(this.getElement().setProperties(e,f),this.getElement().setProperties(g,h)),c.length>0&&this.getElement().setProperties(c,d)},b.prototype.initialSetup=function(){var a=this.getElement(),b=a.getScene().getStyleCollection().querySingle('style[_sdf="text"]');b&&a.assignStyleFrom(b)},b.prototype.canInlineEdit=function(){return!0},b.prototype.isInlineEdit=function(){return null!==this._inlineEditor},b.prototype.beginInlineEdit=function(a,b){this.removeFlag(GBlockEditor.Flag.ResizeAll),this.getElement().setFlag(GElement.Flag.NoPaint);var c=this.getElement().asHtml();if(this._inlineEditor=$($("<div></div>")).css(this.getElement().getContent().propertiesToCss({})).css({position:"absolute",background:"transparent","transform-origin":"0% 0%","-webkit-transform-origin":"0% 0%","min-width":"1em","min-height":"1em"}).attr("contenteditable","true").on("mousedown",function(a){a.stopPropagation()}).on("mouseup",function(a){a.stopPropagation(),this._savedSelection&&rangy.removeMarkers(this._savedSelection),this._savedSelection=rangy.saveSelection(),this._activeParagraphElement=null;var b=rangy.getSelection();if(b.rangeCount)for(var c=b.getRangeAt(0),d=c.collapsed?[c.endContainer]:c.getNodes(),e=0;e<d.length;++e){var f=d[e];if(3===f.nodeType){for(var g=null,h=f.parentNode;null!==h;h=h.parentNode)if(1===h.nodeType&&"p"===h.nodeName.toLowerCase()){g=h;break}g&&(this._activeParagraphElement=g)}}this._triggerSelectionChanged()}.bind(this)).on("click",function(a){a.stopPropagation()}).on("dblclick",function(a){a.stopPropagation()}).on("keydown",function(a){a.stopPropagation()}).on("keyup",function(a){a.stopPropagation(),this._savedSelection&&rangy.removeMarkers(this._savedSelection),this._savedSelection=rangy.saveSelection()}.bind(this)).html(c).appendTo(b),this._inlineEditor.focus(),""===c){var d=document.createElement("p");$(d).text("Your Text Here"),this._inlineEditor.append(d);var e=rangy.createRange();e.selectNodeContents(d);var f=rangy.getSelection();f.setSingleRange(e)}},b.prototype.adjustInlineEditForView=function(a,b){var c=this.getElement().getGeometryBBox();if(!c){c=GRect.fromPoints(new GPoint(0,0),new GPoint(1,1));var d=this.getElement().getTransform();d&&(c=d.mapRect(c))}var e=a.getWorldTransform().mapRect(c),f=e.getX(),g=Math.floor(e.getY())+1,h="",i="";this.getElement().getProperty("aw")===!1&&c.getWidth()>0&&(h=c.getWidth()+"px"),this.getElement().getProperty("ah")===!1&&c.getHeight()>0&&(i=c.getHeight()+"px"),this._inlineEditor.css({width:h,height:i,transform:"scale("+a.getZoom()+")","-webkit-transform":"scale("+a.getZoom()+")"}).offset({top:g,left:f}),b&&this.createSelectionFromPosition(b)},b.prototype.createSelectionFromPosition=function(a,b){var c=document,d=null;if("undefined"!=typeof c.caretPositionFromPoint){d=c.createRange();var e=c.caretPositionFromPoint(a.getX(),a.getY());if(d.setStart(e.offsetNode,e.offset),b){var f=c.caretPositionFromPoint(b.getX(),b.getY());d.setEnd(f.offsetNode,f.offset)}}else if("undefined"!=typeof c.caretRangeFromPoint){d=c.createRange();var e=c.caretRangeFromPoint(a.getX(),a.getY());if(d.setStart(e.startContainer,e.startOffset),b){var f=c.caretRangeFromPoint(endX,endY);d.setEnd(b.getX(),b.getY())}}if(null!==d&&"undefined"!=typeof window.getSelection){var g=window.getSelection();g.removeAllRanges(),g.addRange(d)}else if("undefined"!=typeof c.body.createTextRange){if(d=c.body.createTextRange(),d.moveToPoint(a.getX(),a.getY()),b){var h=d.duplicate();h.moveToPoint(b.getX(),b.getY()),d.setEndPoint("EndToEnd",h)}d.select()}},b.prototype.finishInlineEdit=function(){this._savedSelection&&(rangy.removeMarkers(this._savedSelection),this._savedSelection=null);var a=this._inlineEditor.html();return this.getElement().fromHtml(a),this._inlineEditor.remove(),this._inlineEditor=null,this.setFlag(GBlockEditor.Flag.ResizeAll),this.getElement().removeFlag(GElement.Flag.NoPaint),"Modify Text Content"},b.prototype.applyPartMove=function(a,b){a===GBlockEditor.RESIZE_HANDLE_PART_ID&&(this._transform.isIdentity()||this._element.textBoxTransform(this._transform),this.resetTransform()),GElementEditor.prototype.applyPartMove.call(this,a,b)},b.prototype._prePaint=function(a,b){if((this.hasFlag(GElementEditor.Flag.Selected)||this.hasFlag(GElementEditor.Flag.Highlighted))&&!this.isInlineEdit()){var c=this._element.getGeometryBBox();if(c){var d=a.mapRect(c),e=Math.floor(d.getX()),f=Math.floor(d.getY()),g=Math.ceil(d.getX()+d.getWidth())-e,h=Math.ceil(d.getY()+d.getHeight())-f;b.canvas.strokeRect(e+.5,f+.5,g,h,1,this.hasFlag(GElementEditor.Flag.Highlighted)?b.highlightOutlineColor:b.selectionOutlineColor)}}},b.prototype._triggerSelectionChanged=function(){var a=GEditor.getEditor(this.getElement().getScene());a.hasEventListeners(GEditor.InlineEditorEvent)&&a.trigger(new GEditor.InlineEditorEvent(this,GEditor.InlineEditorEvent.Type.SelectionChanged))},b.prototype.toString=function(){return"[Object GTextEditor]"},a.GTextEditor=b}(this),function(a){function b(a){GPathBaseEditor.call(this,a),this._flags|=GBlockEditor.Flag.ResizeAll}GObject.inherit(b,GPathBaseEditor),GElementEditor.exports(b,GEllipse),b.START_ANGLE_PART_ID=GUtil.uuid(),b.END_ANGLE_PART_ID=GUtil.uuid(),b.prototype.getBBoxMargin=function(){var a=GPathBaseEditor.prototype.getBBoxMargin.call(this);return this._showSegmentDetails()?Math.max(GElementEditor.OPTIONS.annotationSizeRegular+1,a):a},b.prototype.getCustomBBox=function(a,b){var c=null;if(this.hasFlag(GElementEditor.Flag.Selected)&&this.hasFlag(GElementEditor.Flag.Detail)){var d=a;b&&this._transform&&(d=this._transform.multiplied(a));var e=this.getPaintElement().getCenter(!0);c=ifAnnotation.getAnnotationBBox(d,e,2*GElementEditor.OPTIONS.centerCrossSize)}return c},b.prototype.movePart=function(a,c,d,e,f,g,h){if(GPathBaseEditor.prototype.movePart.call(this,a,c,d,e,f,g,h),a===b.START_ANGLE_PART_ID||a===b.END_ANGLE_PART_ID){var i=e.mapPoint(d);this._elementPreview||(this._elementPreview=new GEllipse,this._elementPreview.transferProperties(this._element,[GShape.GeometryProperties,GEllipse.GeometryProperties],!0));var j=this._element.getTransform();if(j)var k=j.inverted().mapPoint(i);else var k=i;var l=Math.atan2(k.getY(),k.getX()),m=this._element.getProperty("sa"),n=this._element.getProperty("ea");if(a==b.START_ANGLE_PART_ID)var o=l-m;else var o=l-n;var p=this._partSelection.indexOf(b.START_ANGLE_PART_ID)>=0,q=this._partSelection.indexOf(b.END_ANGLE_PART_ID)>=0;(p||q)&&(this._elementPreview.setProperties(["sa","ea"],[p?GMath.normalizeAngleRadians(m+o):m,q?GMath.normalizeAngleRadians(n+o):n]),this.requestInvalidation())}},b.prototype.applyPartMove=function(a,c){if(a===b.START_ANGLE_PART_ID||a===b.END_ANGLE_PART_ID){var d=this._elementPreview.getProperties(["sa","ea"]);this.resetPartMove(a,c),this._element.setProperties(["sa","ea"],d)}GPathBaseEditor.prototype.applyPartMove.call(this,a,c)},b.prototype.applyTransform=function(a){a&&this._elementPreview?(a.transferProperties(this._elementPreview,[GShape.GeometryProperties,GEllipse.GeometryProperties]),this.resetTransform()):GPathBaseEditor.prototype.applyTransform.call(this,a)},b.prototype._hasCenterCross=function(){return!0},b.prototype._postPaint=function(a,c){GPathBaseEditor.prototype._postPaint.call(this,a,c),this._showSegmentDetails()&&this._iterateArcEnds(!0,function(d){var e=d.id==b.START_ANGLE_PART_ID?GElementEditor.Annotation.Diamond:GElementEditor.Annotation.Circle,f=this._partSelection&&this._partSelection.indexOf(d.id)>=0;return this._paintAnnotation(c,a,d.position,e,f,!1),!1}.bind(this))},b.prototype._getPartInfoAt=function(a,b,c){return this._showSegmentDetails()&&(result=null,this._iterateArcEnds(!1,function(d){return this._getAnnotationBBox(b,d.position).expanded(c,c,c,c).containsPoint(a)?(result=new GElementEditor.PartInfo(this,d.id,null,!0,!0),!0):!1}.bind(this)),result)?result:GShapeEditor.prototype._getPartInfoAt.call(this,a,b,c)},b.prototype._showSegmentDetails=function(){return this._showAnnotations()&&this.hasFlag(GElementEditor.Flag.Detail)&&!this._elementPreview},b.prototype._iterateArcEnds=function(a,c){var d=a?this.getPaintElement():this._element,e=d.getTransform(),f=d.getProperty("sa"),g=d.getProperty("ea");e=e?e:new GTransform(1,0,0,1,0,0);for(var h=[{id:b.START_ANGLE_PART_ID,position:e.mapPoint(new GPoint(Math.cos(f),Math.sin(f)))},{id:b.END_ANGLE_PART_ID,position:e.mapPoint(new GPoint(Math.cos(g),Math.sin(g)))}],i=0;i<h.length&&c(h[i])!==!0;++i);},b.prototype.toString=function(){return"[Object GEllipseEditor]"},a.GEllipseEditor=b}(this),function(a){function b(a){GPathBaseEditor.call(this,a),this._flags|=GBlockEditor.Flag.ResizeAll}GObject.inherit(b,GPathBaseEditor),GElementEditor.exports(b,GRectangle),b.LEFT_SHOULDER_PART_ID=GUtil.uuid(),b.RIGHT_SHOULDER_PART_ID=GUtil.uuid(),b.ANY_SHOULDER_PART_ID=GUtil.uuid(),GEllipseEditor.prototype.getBBoxMargin=function(){var a=GPathBaseEditor.prototype.getBBoxMargin.call(this);return this._showSegmentDetails()?Math.max(GElementEditor.OPTIONS.annotationSizeRegular+1,a):a},b.prototype.movePart=function(a,c,d,e,f,g,h){if(GPathBaseEditor.prototype.movePart.call(this,a,c,d,e,f,g,h),a.id===b.LEFT_SHOULDER_PART_ID||a.id===b.RIGHT_SHOULDER_PART_ID||a.id===b.ANY_SHOULDER_PART_ID){var i=e.mapPoint(d);this._elementPreview||(this._elementPreview=new GRectangle,this._elementPreview.transferProperties(this._element,[GShape.GeometryProperties,GRectangle.GeometryProperties],!0));var j=this._element.getTransform(),k=new GPoint(a.ap.getProperty("x"),a.ap.getProperty("y"));j&&(k=j.mapPoint(k));var l=null,m=null;if(a.id==b.LEFT_SHOULDER_PART_ID||a.id===b.ANY_SHOULDER_PART_ID){var n=this._element.getAnchorPoints().getPreviousPoint(a.ap),o=new GPoint(n.getProperty("x"),n.getProperty("y"));o=j?j.mapPoint(o):o;var p=GMath.getVectorProjection(k.getX(),k.getY(),o.getX(),o.getY(),i.getX(),i.getY(),!0);l=GMath.ptDist(p.getX(),p.getY(),k.getX(),k.getY())}if(a.id===b.RIGHT_SHOULDER_PART_ID||a.id===b.ANY_SHOULDER_PART_ID){var n=this._element.getAnchorPoints().getNextPoint(a.ap),q=new GPoint(n.getProperty("x"),n.getProperty("y"));q=j?j.mapPoint(q):q;var r=GMath.getVectorProjection(k.getX(),k.getY(),q.getX(),q.getY(),i.getX(),i.getY(),!0);m=GMath.ptDist(r.getX(),r.getY(),k.getX(),k.getY())}var s;s=null!==m&&null!==l?m>l?m:l:null!==m?m:l;var t=(this.getPaintElement(),GRectangle.getGeometryPropertiesSidePrefix(a.side));g?this.getPaintElement().setProperties([t+"_sx",t+"_sy"],[s,s]):a.id==b.LEFT_SHOULDER_PART_ID||a.id===b.ANY_SHOULDER_PART_ID&&s==l?this.getPaintElement().setProperty(t+"_sx",s):this.getPaintElement().setProperty(t+"_sy",s),this.requestInvalidation()}},b.prototype.applyPartMove=function(a,c){(a.id===b.LEFT_SHOULDER_PART_ID||a.id===b.RIGHT_SHOULDER_PART_ID||a.id===b.ANY_SHOULDER_PART_ID)&&this._element.transferProperties(this._elementPreview,[GRectangle.GeometryProperties]),GPathBaseEditor.prototype.applyPartMove.call(this,a,c)},b.prototype.applyTransform=function(a){a&&this._elementPreview?(a.transferProperties(this._elementPreview,[GShape.GeometryProperties,GRectangle.GeometryProperties]),this.resetTransform()):GPathBaseEditor.prototype.applyTransform.call(this,a)},b.prototype._hasCenterCross=function(){return!0},b.prototype._postPaint=function(a,c){GPathBaseEditor.prototype._postPaint.call(this,a,c),this._showSegmentDetails()&&this.getPaintElement().iterateSegments(function(d,e,f,g,h,i){var j=this.getPaintElement(),k={id:b.LEFT_SHOULDER_PART_ID,side:e},l={id:b.RIGHT_SHOULDER_PART_ID,side:e},m={id:b.ANY_SHOULDER_PART_ID,side:e};if(0!=g||0!=h){var n=j.getAnchorPoints().getChildByIndex(i),o=j.getTransform(),p=o?n.getLeftShoulderPointTransformed(o,!0):n.getLeftShoulderPoint(!0);p||(p=new GPoint(n.getProperty("x"),n.getProperty("y")),p=o?o.mapPoint(p):p),this._paintAnnotation(c,a,p,GElementEditor.Annotation.Diamond,this.isPartSelected(k),!1);var q=o?n.getRightShoulderPointTransformed(o,!0):n.getRightShoulderPoint(!0);q||(q=new GPoint(n.getProperty("x"),n.getProperty("y")),q=o?o.mapPoint(q):q),this._paintAnnotation(c,a,q,GElementEditor.Annotation.Diamond,this.isPartSelected(l),!1)}else this._paintAnnotation(c,a,d,GElementEditor.Annotation.Diamond,this.isPartSelected(k)||this.isPartSelected(l)||this.isPartSelected(m),!1)}.bind(this),!0)},b.prototype._partIdAreEqual=function(a,b){var c=a===b||a.id===b.id;return c&&a.id&&(c=a.side===b.side),c},b.prototype._getPartInfoAt=function(a,c,d){if(this._showSegmentDetails()){var e=null;if(this.getPaintElement().iterateSegments(function(f,g,h,i,j,k){var l=this.getPaintElement(),m=l.getAnchorPoints().getChildByIndex(k);if(0!=i||0!=j){var n=l.getTransform(),o=n?m.getLeftShoulderPointTransformed(n,!0):m.getLeftShoulderPoint(!0);if(o||(o=new GPoint(m.getProperty("x"),m.getProperty("y")),o=n?n.mapPoint(o):o),this._getAnnotationBBox(c,o).expanded(d,d,d,d).containsPoint(a))return e=new GElementEditor.PartInfo(this,{id:b.LEFT_SHOULDER_PART_ID,side:g,ap:m,point:o},null,!0,!0),!0;var p=n?m.getRightShoulderPointTransformed(n,!0):m.getRightShoulderPoint(!0);if(p||(p=new GPoint(m.getProperty("x"),m.getProperty("y")),p=n?n.mapPoint(p):p),this._getAnnotationBBox(c,p).expanded(d,d,d,d).containsPoint(a))return e=new GElementEditor.PartInfo(this,{id:b.RIGHT_SHOULDER_PART_ID,side:g,ap:m,point:p},null,!0,!0),!0}else if(this._getAnnotationBBox(c,f,!0).expanded(d,d,d,d).containsPoint(a))return e=new GElementEditor.PartInfo(this,{id:b.ANY_SHOULDER_PART_ID,side:g,ap:m,point:f},null,!0,!0),!0}.bind(this),!0),e)return e}return GPathBaseEditor.prototype._getPartInfoAt.call(this,a,c,d)},b.prototype._showSegmentDetails=function(){return this._showAnnotations()&&this.hasFlag(GElementEditor.Flag.Detail)&&!this._elementPreview},b.prototype.toString=function(){return"[Object GRectangleEditor]"},a.GRectangleEditor=b}(this),function(a){function b(a){GPathBaseEditor.call(this,a),this._flags|=GBlockEditor.Flag.ResizeAll}GObject.inherit(b,GPathBaseEditor),GElementEditor.exports(b,GPolygon),b.INSIDE_PART_ID=GUtil.uuid(),b.OUTSIDE_PART_ID=GUtil.uuid(),b.prototype.getBBoxMargin=function(){return GPathBaseEditor.prototype.getBBoxMargin.call(this)},b.prototype.getCustomBBox=function(a,b){var c=null;if(this._showSegmentDetails()){var d=a;b&&this._transform&&(d=this._transform.multiplied(a));var e=function(a){a&&!a.isEmpty()&&(c=c?c.united(a):a)};this.getPaintElement().iterateSegments(function(a){e(this._getAnnotationBBox(d,a))}.bind(this),!0)}return c},b.prototype.movePart=function(a,c,d,e,f,g,h){if(GPathBaseEditor.prototype.movePart.call(this,a,c,d,e,f,g,h),a===b.INSIDE_PART_ID||a===b.OUTSIDE_PART_ID){var i=e.mapPoint(d);i=f.mapPoint(i);var j=this._element.getProperty("trf");j&&(i=j.inverted().mapPoint(i)),this._elementPreview||(this._elementPreview=new GPolygon,this._elementPreview.transferProperties(this._element,[GShape.GeometryProperties,GPolygon.GeometryProperties],!0));var k=this._element.getCenter(!1),l=Math.atan2(i.getY()-k.getY(),i.getX()-k.getX())-c,m=GMath.ptDist(i.getX(),i.getY(),k.getX(),k.getY()),n=this._element.getProperty("oa"),o=this._element.getProperty("or"),p=this._element.getProperty("ia"),q=this._element.getProperty("ir"),r=p,s=q,t=n,u=o,v=this._partSelection.indexOf(b.INSIDE_PART_ID)>=0,w=this._partSelection.indexOf(b.OUTSIDE_PART_ID)>=0;if(1==this._partSelection.length)v&&(g||(r=GMath.normalizeAngleRadians(l+p)),s=m),w&&(g||(t=GMath.normalizeAngleRadians(l+n)),u=m);else if(v&&w)if(a==b.INSIDE_PART_ID){g||(r=GMath.normalizeAngleRadians(l+p)),s=m;var x=s*Math.cos(r)-q*Math.cos(p),y=s*Math.sin(r)-q*Math.sin(p),z=new GPoint(o*Math.cos(n)+x,o*Math.sin(n)+y);t=Math.atan2(z.getY(),z.getX()),u=GMath.ptDist(z.getX(),z.getY(),0,0)}else if(a==b.OUTSIDE_PART_ID){g||(t=GMath.normalizeAngleRadians(l+n)),u=m;var x=u*Math.cos(t)-o*Math.cos(n),y=u*Math.sin(t)-o*Math.sin(n),A=new GPoint(q*Math.cos(p)+x,q*Math.sin(p)+y);r=Math.atan2(A.getY(),A.getX()),s=GMath.ptDist(A.getX(),A.getY(),0,0)}this._elementPreview.setProperties(["oa","or","ia","ir"],[t,u,r,s]),this.requestInvalidation()}},b.prototype.applyPartMove=function(a,c){if(a===b.INSIDE_PART_ID||a===b.OUTSIDE_PART_ID){var d=this._elementPreview.getProperties(["oa","or","ia","ir"]);this.resetPartMove(a,c),this._element.setProperties(["oa","or","ia","ir"],d)}GPathBaseEditor.prototype.applyPartMove.call(this,a,c)},b.prototype.applyTransform=function(a){a&&this._elementPreview?(a.transferProperties(this._elementPreview,[GShape.GeometryProperties,GPolygon.GeometryProperties]),this.resetTransform()):GPathBaseEditor.prototype.applyTransform.call(this,a)},b.prototype._hasCenterCross=function(){return!0},b.prototype._postPaint=function(a,c){if(GPathBaseEditor.prototype._postPaint.call(this,a,c),this._showSegmentDetails()){var d=this.getPaintElement();d.iterateSegments(function(d,e){var f=e?GElementEditor.Annotation.Circle:GElementEditor.Annotation.Diamond,g=e?b.INSIDE_PART_ID:b.OUTSIDE_PART_ID;this._paintAnnotation(c,a,d,f,this._partSelection&&this._partSelection.indexOf(g)>=0,!1)}.bind(this),!0)}},b.prototype._getPartInfoAt=function(a,c,d){if(this._showSegmentDetails()){var e=null;if(this._element.iterateSegments(function(f,g,h){if(this._getAnnotationBBox(c,f).expanded(d,d,d,d).containsPoint(a)){var i=g?b.INSIDE_PART_ID:b.OUTSIDE_PART_ID;return e=new GElementEditor.PartInfo(this,i,h,!0,!0),!0}}.bind(this),!0),e)return e}return GShapeEditor.prototype._getPartInfoAt.call(this,a,c,d)},b.prototype._showSegmentDetails=function(){return this._showAnnotations()&&this.hasFlag(GElementEditor.Flag.Detail)&&!this._elementPreview},b.prototype.toString=function(){return"[Object GPolygonEditor]"},a.GPolygonEditor=b}(this),function(a){function b(a){GPathBaseEditor.call(this,a);for(var c=a.getAnchorPoints().queryAll(":selected"),d=0;d<c.length;++d)this._partSelection||(this._partSelection=[]),this._partSelection.push({type:b.PartType.Point,point:c[d]})}GObject.inherit(b,GPathBaseEditor),GElementEditor.exports(b,GPath),b.PartType={Segment:1,Point:2,LeftHandle:3,RightHandle:4,LeftShoulder:5,RightShoulder:6},b.SegmentData={HitRes:1,Handles:2},b.prototype._sourceIndexToPreviewIndex=null,b.prototype._activeExtedingMode=!1,b.prototype.isActiveExtendingMode=function(){return this._activeExtedingMode},b.prototype.setActiveExtendingMode=function(a){this._activeExtedingMode=a},b.prototype.getBBox=function(a){var b=GPathBaseEditor.prototype.getBBox.call(this,a);if(this._showAnnotations()){this._transform&&(a=this._transform.multiplied(a));var c=function(a){a&&!a.isEmpty()&&(b=b?b.united(a):a)};return this._iteratePoints(!0,function(b){b.leftHandlePosition&&c(this._getAnnotationBBox(a,b.leftHandlePosition,!0)),b.rightHandlePosition&&c(this._getAnnotationBBox(a,b.rightHandlePosition,!0)),b.leftShoulderPosition&&c(this._getAnnotationBBox(a,b.leftShoulderPosition,!0)),b.rightShoulderPosition&&c(this._getAnnotationBBox(a,b.rightShoulderPosition,!0)),c(this._getAnnotationBBox(a,b.position,!0))}.bind(this)),b}return b},b.prototype.movePart=function(a,c,d,e,f,g){switch(this.requestInvalidation(),this._createPathPreviewIfNecessary(a.point),a.type){case b.PartType.LeftHandle:this._movePreviewPointCoordinates(a.point,"hlx","hly",d,e,g,f);break;case b.PartType.RightHandle:this._movePreviewPointCoordinates(a.point,"hrx","hry",d,e,g,f);break;case b.PartType.LeftShoulder:case b.PartType.RightShoulder:var h=e.mapPoint(d);this._movePreviewPointShoulders(a,h,g)}this.requestInvalidation()},b.prototype.resetPartMove=function(){this.releasePathPreview(),this.requestInvalidation()},b.prototype.applyPartMove=function(a,c){switch(a.type){case b.PartType.LeftHandle:this._assignPreviewPointPropertiesToSourcePoint(a.point,["hlx","hly","ah"]);break;case b.PartType.RightHandle:this._assignPreviewPointPropertiesToSourcePoint(a.point,["hrx","hry","ah"]);break;case b.PartType.LeftShoulder:case b.PartType.RightShoulder:this._assignPreviewPointPropertiesToSourcePoint(a.point,["cl","cr"])}this.resetPartMove(a,c)},b.prototype.transform=function(a,c,d){if(this._partSelection&&this._partSelection.length>0){this.requestInvalidation(),this._createPathPreviewIfNecessary();for(var e=0;e<this._partSelection.length;++e){var f=this._partSelection[e];if(f.type===b.PartType.Point){var g=f.point;this._transformPreviewPointCoordinates(g,"x","y",a),g.getProperty("ah")||(null!=g.getProperty("hlx")&&null!=g.getProperty("hly")&&this._transformPreviewPointCoordinates(g,"hlx","hly",a),null!=g.getProperty("hrx")&&null!=g.getProperty("hry")&&this._transformPreviewPointCoordinates(g,"hrx","hry",a))}else if(f.type===b.PartType.Segment&&c&&this._partIdAreEqual(f,c)&&d.type==b.SegmentData.Handles){var h=this.getPathPointPreview(f.apLeft),i=this.getPathPointPreview(f.apRight),j=a.getTranslation(),k=new GPoint(h.getProperty("x"),h.getProperty("y")),l=new GPoint(i.getProperty("x"),i.getProperty("y"));if(d.fixedHDirLpt||d.fixedHDirRpt)if(d.fixedHDirLpt&&d.fixedHDirRpt){var m=j.getX(),n=j.getY(),o=GMath.getVectorProjection(k.getX(),k.getY(),d.apLhr.getX(),d.apLhr.getY(),k.getX()+m,k.getY()+n),p=o.subtract(k),q=a.translated(-j.getX()+p.getX()*d.cL,-j.getY()+p.getY()*d.cL);this._transformPreviewPointCoordinates(f.apLeft,"hrx","hry",q,d.apLhr);var o=GMath.getVectorProjection(l.getX(),l.getY(),d.apRhl.getX(),d.apRhl.getY(),l.getX()+m,l.getY()+n),p=o.subtract(l),q=a.translated(-j.getX()+p.getX()*d.cR,-j.getY()+p.getY()*d.cR);this._transformPreviewPointCoordinates(f.apRight,"hlx","hly",q,d.apRhl)}else{var m=j.getX(),n=j.getY(),r=1/(d.cL+d.cR);if(d.fixedHDirLpt&&!d.fixedHDirRpt)var o=GMath.getVectorProjection(k.getX(),k.getY(),d.apLhr.getX(),d.apLhr.getY(),k.getX()+m,k.getY()+n),p=o.subtract(k),s=r*p.getX(),t=r*p.getY(),u=m/d.cR-d.cL/d.cR*s,v=n/d.cR-d.cL/d.cR*t;else var o=GMath.getVectorProjection(l.getX(),l.getY(),d.apRhl.getX(),d.apRhl.getY(),l.getX()+m,l.getY()+n),p=o.subtract(l),u=r*p.getX(),v=r*p.getY(),s=m/d.cL-d.cR/d.cL*u,t=n/d.cL-d.cR/d.cL*v;var q=a.translated(-j.getX()+s,-j.getY()+t);this._transformPreviewPointCoordinates(f.apLeft,"hrx","hry",q,d.apLhr);var q=a.translated(-j.getX()+u,-j.getY()+v);this._transformPreviewPointCoordinates(f.apRight,"hlx","hly",q,d.apRhl)}else{var q=a.translated(-j.getX()+j.getX()*d.cL,-j.getY()+j.getY()*d.cL);this._transformPreviewPointCoordinates(f.apLeft,"hrx","hry",q,d.apLhr);var q=a.translated(-j.getX()+j.getX()*d.cR,-j.getY()+j.getY()*d.cR);this._transformPreviewPointCoordinates(f.apRight,"hlx","hly",q,d.apRhl)}}}this.requestInvalidation()}else GPathBaseEditor.prototype.transform.call(this,a,c,d)},b.prototype.resetTransform=function(){this.releasePathPreview(),GPathBaseEditor.prototype.resetTransform.call(this)},b.prototype.canApplyTransform=function(){return this._partSelection&&this._partSelection.length>0||this._transform&&!this._transform.isIdentity()},b.prototype.applyTransform=function(a){if(this._partSelection&&this._partSelection.length>0){this._element._beginBlockEvents([GElement.GeometryChangeEvent]);for(var c=[],d=0;d<this._partSelection.length;++d){var e=this._partSelection[d];e.type===b.PartType.Point?(d==this._partSelection.length-1&&this._element._endBlockEvents([GElement.GeometryChangeEvent]),this._transferPreviewProperties(e.point,a),c.push(e)):e.type===b.PartType.Segment&&(this._transferPreviewProperties(e.apLeft,a),d==this._partSelection.length-1&&this._element._endBlockEvents([GElement.GeometryChangeEvent]),this._transferPreviewProperties(e.apRight,a),c.push({type:b.PartType.Point,point:e.apLeft}),c.push({type:b.PartType.Point,point:e.apRight}))
}this.requestInvalidation(),this.resetTransform(),this.updatePartSelection(!1,c)}else GPathBaseEditor.prototype.applyTransform.call(this,a)},b.prototype.subSelectDragStartAction=function(a){if(a.editor!==this)return null;var c=a;if(a.isolated||a.id.type!=b.PartType.Point){if(a.id.type==b.PartType.Segment){var d=a.data.hitRes,e=a.id.apLeft,f=a.id.apRight;if(e&&f){this.requestInvalidation(),this._createPathPreviewIfNecessary();var g=this.getPathPointPreview(e),h=this.getPathPointPreview(f);if(g&&h){var i=e.getProperty("x"),j=e.getProperty("y"),k=f.getProperty("x"),l=f.getProperty("y");if(null!==e.getProperty("hrx")&&null!==e.getProperty("hry")||null!==f.getProperty("hlx")&&null!==f.getProperty("hly"))if(null===e.getProperty("hrx")||null===e.getProperty("hry")){var m=h.getProperty("hlx"),n=h.getProperty("hly"),o=i+2/3*(m-i),p=j+2/3*(n-j);m=k+2/3*(m-k),n=l+2/3*(n-l),g.setProperties(["ah","hrx","hry"],[!1,o,p]),h.setProperties(["ah","hlx","hly"],[!1,m,n]),this.requestInvalidation(),c=new GElementEditor.PartInfo(this,{type:b.PartType.Segment,point:null,apLeft:e,apRight:f},{type:b.SegmentData.Handles,cL:3*(1-d.slope)*(1-d.slope)*d.slope,apLhr:new GPoint(o,p),fixedHDirLpt:!1,cR:3*d.slope*d.slope*(1-d.slope),apRhl:new GPoint(m,n),fixedHDirRpt:!0},!1,!0)}else if(null===f.getProperty("hlx")||null===f.getProperty("hly")){var o=g.getProperty("hrx"),p=g.getProperty("hry"),m=k+2/3*(o-k),n=l+2/3*(p-l);o=i+2/3*(o-i),p=j+2/3*(p-j),g.setProperties(["ah","hrx","hry"],[!1,o,p]),h.setProperties(["ah","hlx","hly"],[!1,m,n]),this.requestInvalidation(),c=new GElementEditor.PartInfo(this,{type:b.PartType.Segment,point:null,apLeft:e,apRight:f},{type:b.SegmentData.Handles,cL:3*(1-d.slope)*(1-d.slope)*d.slope,apLhr:new GPoint(o,p),fixedHDirLpt:!0,cR:3*d.slope*d.slope*(1-d.slope),apRhl:new GPoint(m,n),fixedHDirRpt:!1},!1,!0)}else{g.setProperty("ah",!1),h.setProperty("ah",!1),this.requestInvalidation();var o=g.getProperty("hrx"),p=g.getProperty("hry"),m=h.getProperty("hlx"),n=h.getProperty("hly");c=new GElementEditor.PartInfo(this,{type:b.PartType.Segment,point:null,apLeft:e,apRight:f},{type:b.SegmentData.Handles,cL:3*(1-d.slope),apLhr:new GPoint(o,p),fixedHDirLpt:!0,cR:3*d.slope,apRhl:new GPoint(m,n),fixedHDirRpt:!0},!1,!0)}else{var q=(k-i)/3,r=(l-j)/3,s=q*d.slope,t=q-s,u=r*d.slope,v=r-u,o=d.x-s,p=d.y-u;g.setProperties(["ah","hrx","hry"],[!1,d.x-s,d.y-u]);var m=d.x+t,n=d.y+v;h.setProperties(["ah","hlx","hly"],[!1,d.x+t,d.y+v]),this.requestInvalidation(),c=new GElementEditor.PartInfo(this,{type:b.PartType.Segment,point:null,apLeft:e,apRight:f},{type:b.SegmentData.Handles,cL:4/3,apLhr:new GPoint(o,p),fixedHDirLpt:!1,cR:4/3,apRhl:new GPoint(m,n),fixedHDirRpt:!1},null,!1,!0)}}else c=null}else c=null}}else{var w=a.id.point,x=b.PartType.Point,y=w.getProperty("tp");if(GPathBase.isCornerType(y)&&null!=this._element.getAnchorPoints().getPreviousPoint(w)&&null!=this._element.getAnchorPoints().getNextPoint(w)){var z=w.getProperty("cl"),A=w.getProperty("cr"),B=this._element.getScene().getProperty("pickDist");null==A||2*B>A?x=b.PartType.RightShoulder:(null==z||2*B>z)&&(x=b.PartType.LeftShoulder)}if(x!=b.PartType.Point){z=null!=z?z:B,A=null!=A?A:B,this.requestInvalidation(),this._createPathPreviewIfNecessary(w);var C=this.getPathPointPreview(w);if(C){C.setProperties(["cl","cr"],[z,A]);var D=!0,E=!1;c=new GElementEditor.PartInfo(this,{type:x,point:w},null,D,E)}else c=null}else{var m=w.getProperty("hlx"),n=w.getProperty("hly"),o=w.getProperty("hrx"),p=w.getProperty("hry");if(a.data.apSelected&&w.hasFlag(GNode.Flag.Selected)){if(null===m||null===n||null===o||null===p){this.requestInvalidation(),this._createPathPreviewIfNecessary(w);var C=this.getPathPointPreview(w);if(C){var F=null,D=!0,E=!1;null===o||null===p?(F=b.PartType.RightHandle,C.setProperties(["ah","hrx","hry"],[!1,w.getProperty("x"),w.getProperty("y")])):(F=b.PartType.LeftHandle,C.setProperties(["ah","hlx","hly"],[!1,w.getProperty("x"),w.getProperty("y")])),c=new GElementEditor.PartInfo(this,{type:F,point:w},{apSelected:!0},D,E),this.updatePartSelection(!0,[c.id])}else c=null}}else w.hasFlag(GNode.Flag.Selected)||this.selectOnePoint(w),c=new GElementEditor.PartInfo(this,{type:b.PartType.Point,point:w},{apSelected:!0},D,E)}}return c},b.prototype._attach=function(){var a=this._element.getScene();null!=a&&a.addEventListener(GElement.GeometryChangeEvent,this._geometryChange,this)},b.prototype._detach=function(){for(var a=this._element.getAnchorPoints().getFirstChild();null!=a;a=a.getNext())a.removeFlag(GNode.Flag.Selected);var b=this._element.getScene();null!=b&&b.removeEventListener(GElement.GeometryChangeEvent,this._geometryChange),GPathBaseEditor.prototype._detach.call(this)},b.prototype.hitAnchorPoint=function(a,b,c,d){if(a){var e=this._element.getTransform();return c&&(e=e?e.multiplied(c):c),this._getAnnotationBBox(e,new GPoint(a.getProperty("x"),a.getProperty("y")),!0).expanded(d,d,d,d).containsPoint(b)}return!1},b.prototype.getPointCoord=function(a){var b=null;if(a.getPath()==this._element||this._elementPreview&&a.getPath()==this._elementPreview){var c=this._element;this._elementPreview&&a.getPath()==this._elementPreview&&(c=this._elementPreview);var d=a.getProperty("x"),e=a.getProperty("y");b=new GPoint(d,e);var f=c.getTransform();f&&(b=f.mapPoint(b))}return b},b.prototype._getPartInfoAt=function(a,c,d){if(this._showAnnotations()){var e=function(b,e){return b?this._getAnnotationBBox(c,b,e).expanded(d,d,d,d).containsPoint(a):!1}.bind(this),f=null;if(this._iteratePoints(!1,function(a){var c=null,d=!0,g=!1;return e(a.rightHandlePosition,!0)?c=b.PartType.RightHandle:e(a.leftHandlePosition,!0)?c=b.PartType.LeftHandle:e(a.rightShoulderPosition,!0)?c=b.PartType.RightShoulder:e(a.leftShoulderPosition,!0)?c=b.PartType.LeftShoulder:e(a.position,!0)&&(c=b.PartType.Point,d=!1,g=!0),c?(f=new GElementEditor.PartInfo(this,{type:c,point:a.anchorPoint},{apSelected:a.anchorPoint.hasFlag(GNode.Flag.Selected)},d,g),!0):void 0}.bind(this)),f)return f;if(this.hasFlag(GElementEditor.Flag.Detail)){var g=this._element.pathHitTest(a,c,!1,this._element.getScene().getProperty("pickDist"));if(g){var h=g.data,i=this._element.getAnchorPoints().getChildByIndex(h.segment-1),j=i?this._element.getAnchorPoints().getNextPoint(i):null;return new GElementEditor.PartInfo(this,{type:b.PartType.Segment,point:null,apLeft:i,apRight:j},{type:b.SegmentData.HitRes,hitRes:g.data},!1,!0)}return null}}return null},b.prototype._postPaint=function(a,b){GPathBaseEditor.prototype._postPaint.call(this,a,b),this._showAnnotations()&&this._iteratePoints(!0,function(c){c.leftHandlePosition&&this._paintHandle(a,b,c.position,c.leftHandlePosition),c.rightHandlePosition&&this._paintHandle(a,b,c.position,c.rightHandlePosition),c.leftShoulderPosition&&this._paintAnnotation(b,a,c.leftShoulderPosition,GElementEditor.Annotation.Diamond,!1,!0),c.rightShoulderPosition&&this._paintAnnotation(b,a,c.rightShoulderPosition,GElementEditor.Annotation.Diamond,!1,!0),this._paintAnnotation(b,a,c.position,c.annotation,c.anchorPoint.hasFlag(GNode.Flag.Selected),!0)}.bind(this))},b.prototype._partIdAreEqual=function(a,c){var d=a.type===c.type;return d&&a.type==b.PartType.Point?d=a.point===c.point:d&&a.type==b.PartType.Segment&&(d=a.apLeft===c.apLeft&&a.apRight==c.apRight),d},b.prototype._updatePartSelection=function(a){this.requestInvalidation();var c=this._filterSelection(a);if(this._partSelection)for(var d=0;d<this._partSelection.length;++d){var e=this._partSelection[d],f=!1;if(c)for(var g=0;g<c.length;++g)if(c[g].point===e.point&&e.point||e.type==b.PartType.Segment&&e.type==c[g].type&&e.apLeft==c[g].apLeft&&e.apRight==c[g].apRight){f=!0;break}f||(e.point?e.point.removeFlag(GNode.Flag.Selected):e.type==b.PartType.Segment&&(e.apLeft.removeFlag(GNode.Flag.Selected),e.apRight.removeFlag(GNode.Flag.Selected)))}if(c)for(var d=0;d<c.length;++d){var e=c[d];e.point?e.point.setFlag(GNode.Flag.Selected):e.type==b.PartType.Segment&&(e.apLeft.setFlag(GNode.Flag.Selected),e.apRight.setFlag(GNode.Flag.Selected))}this._partSelection=c,this.requestInvalidation()},b.prototype._paintHandle=function(a,b,c,d){var e=c,f=d;a&&(e=a.mapPoint(c),f=a.mapPoint(d)),b.canvas.strokeLine(e.getX(),e.getY(),f.getX(),f.getY(),1,b.selectionOutlineColor),this._paintAnnotation(b,a,d,GElementEditor.Annotation.Circle,!1,!0)},b.prototype._iteratePoints=function(a,b){for(var c=a?this.getPaintElement():this._element,d=c.getAnchorPoints(),e=c.getTransform(),f=d.getFirstChild();null!=f;f=f.getNext()){var g=d.getPreviousPoint(f),h=d.getNextPoint(f),i=f.getProperty("tp"),j=new GPoint(f.getProperty("x"),f.getProperty("y")),k={type:i,anchorPoint:f,position:j,annotation:GElementEditor.Annotation.Rectangle,leftHandlePosition:null,rightHandlePosition:null,leftShoulderPosition:null,rightShoulderPosition:null};if(f.hasFlag(GNode.Flag.Selected)&&(i===GPathBase.AnchorPoint.Type.Connector?k.annotation=GElementEditor.Annotation.Diamond:(i===GPathBase.AnchorPoint.Type.Symmetric||i===GPathBase.AnchorPoint.Type.Mirror)&&(k.annotation=GElementEditor.Annotation.Circle)),f.hasFlag(GNode.Flag.Selected)||g&&g.hasFlag(GNode.Flag.Selected)){var l=new GPoint(f.getProperty("hlx"),f.getProperty("hly"));null!==l.getX()&&null!==l.getY()&&(k.leftHandlePosition=l)}if(f.hasFlag(GNode.Flag.Selected)||h&&h.hasFlag(GNode.Flag.Selected)){var l=new GPoint(f.getProperty("hrx"),f.getProperty("hry"));null!==l.getX()&&null!==l.getY()&&(k.rightHandlePosition=l)}if(f.hasFlag(GNode.Flag.Selected)&&i!==GPathBase.AnchorPoint.Type.Asymmetric&&i!==GPathBase.AnchorPoint.Type.Symmetric&&i!==GPathBase.AnchorPoint.Type.Mirror&&i!==GPathBase.AnchorPoint.Type.Connector){var m=f.getProperty("cl");if(m&&g){var l=f.getLeftShoulderPoint(!0);l&&null!==l.getX()&&null!==l.getY()&&(k.leftShoulderPosition=l)}var n=f.getProperty("cr");if(n&&h){var l=f.getRightShoulderPoint(!0);l&&null!==l.getX()&&null!==l.getY()&&(k.rightShoulderPosition=l)}}if(e){var o=e.mapPoint(k.position);k.leftHandlePosition&&(k.leftHandlePosition=e.mapPoint(k.leftHandlePosition)),k.rightHandlePosition&&(k.rightHandlePosition=e.mapPoint(k.rightHandlePosition)),k.leftShoulderPosition&&(k.leftShoulderPosition=f.getLeftShoulderPointTransformed(e,!0)),k.rightShoulderPosition&&(k.rightShoulderPosition=f.getRightShoulderPointTransformed(e,!0)),k.position=o}if(b(k)===!0)break}},b.prototype.getPathPreview=function(a,b){return this.requestInvalidation(),a?this.extendPreviewToFull():this._createPathPreviewIfNecessary(b),this.requestInvalidation(),this._elementPreview},b.prototype.getPath=function(){return this._element},b.PointsSelectionType={No:"N",First:"F",Last:"L",Middle:"M",Several:"S"},b.prototype.getPointsSelectionType=function(){var a=b.PointsSelectionType.No;if(this._partSelection)if(this._partSelection.length>1)a=b.PointsSelectionType.Several;else if(this._partSelection[0].point.hasFlag(GNode.Flag.Selected)){var c=this._partSelection[0].point;a=c===this._element.getAnchorPoints().getLastChild()?b.PointsSelectionType.Last:c===this._element.getAnchorPoints().getFirstChild()?b.PointsSelectionType.First:b.PointsSelectionType.Middle}return a},b.prototype.selectOnePoint=function(a){this.updatePartSelection(!1,[{type:b.PartType.Point,point:a}])},b.prototype.isPartSelectionUnderCollisionAllowed=function(){return!0},b.prototype.updatePartSelectionUnderCollision=function(a,c){for(var d=this._element.getAnchorPoints(),e=this._element.getTransform(),f=[],g=d.getFirstChild();null!=g;g=g.getNext()){var h=new GPoint(g.getProperty("x"),g.getProperty("y"));h=e?e.mapPoint(h):h,ifVertexInfo.hitTest(h.getX(),h.getY(),c,0,!0)&&f.push({type:b.PartType.Point,point:g})}return f&&!this._element.hasFlag(GNode.Flag.Selected)&&this._element.setFlag(GNode.Flag.Selected),this.updatePartSelection(a,f),this._partSelection&&this._partSelection.length},b.prototype.isDeletePartsAllowed=function(){var a=!1;if(this._partSelection&&this._partSelection.length){for(var c=0,d=0;d<this._partSelection.length;++d)this._partSelection[d].type==b.PartType.Point&&++c;for(var e=0,f=this._element.getAnchorPoints().getFirstChild();null!=f;f=f.getNext(),++e);e>c&&(a=!0)}return a},b.prototype.deletePartsSelected=function(){if(this._partSelection){for(var a=this._element.getAnchorPoints(),c=0;c<this._partSelection.length;++c)this._partSelection[c].type==b.PartType.Point&&a.removeChild(this._partSelection[c].point);this._partSelection=null}},b.prototype.isAlignPartsAllowed=function(){var a=!1;if(this._partSelection&&this._partSelection.length)for(var c=0;c<this._partSelection.length&&!a;++c)this._partSelection[c].type==b.PartType.Point&&(a=!0);return a},b.prototype.alignParts=function(a,c,d){if(this._partSelection&&this._partSelection.length){var e=this._element.getTransform();this._element._beginBlockEvents([GElement.GeometryChangeEvent]);for(var f=0;f<this._partSelection.length;++f)if(f==this._partSelection.length-1&&this._element._endBlockEvents([GElement.GeometryChangeEvent]),this._partSelection[f].type===b.PartType.Point){var g=this._partSelection[f].point,h=new GPoint(g.getProperty("x"),g.getProperty("y"));e&&(h=e.mapPoint(h));var i=new GPoint(null!==c?c:h.getX(),null!==d?d:h.getY());this.movePoint(g,i)}}},b.prototype.validateSelectionChange=function(){var a=this._element.getParent();return a&&a instanceof GCompoundPath.AnchorPaths?!1:!0},b.prototype.shiftPreviewTable=function(a,b,c){b=null!=b?b:0,c=null!=c?c:this._sourceIndexToPreviewIndex.length-1;for(var d=b;c>d;++d)this._sourceIndexToPreviewIndex[d]+=a},b.prototype.extendPreviewToFull=function(){this._createPathPreviewIfNecessary();var a=this._element.getAnchorPoints(),b=this._elementPreview.getAnchorPoints(),c=b.getFirstChild(),d=a.getFirstChild(),e=0,f=null!=this._sourceIndexToPreviewIndex[e],g=f?this._sourceIndexToPreviewIndex[e]:0;b._beginBlockChanges([GNode._Change.BeforeChildInsert,GNode._Change.AfterChildInsert]);try{for(;!f&&d;){var h=new GPathBase.AnchorPoint;h.transferProperties(d,[GPathBase.AnchorPoint.GeometryProperties]),d.hasFlag(GNode.Flag.Selected)&&h.setFlag(GNode.Flag.Selected),b.insertChild(h,c),this._sourceIndexToPreviewIndex[e]=g,d=d.getNext(),++e,++g,f=null!=this._sourceIndexToPreviewIndex[e]}for(var i=e-0;f&&d;)this._sourceIndexToPreviewIndex[e]+=i,g=this._sourceIndexToPreviewIndex[e],d=d.getNext(),++e,f=null!=this._sourceIndexToPreviewIndex[e];for(++g;!f&&d;){var h=new GPathBase.AnchorPoint;h.transferProperties(d,[GPathBase.AnchorPoint.GeometryProperties]),d.hasFlag(GNode.Flag.Selected)&&h.setFlag(GNode.Flag.Selected),b.appendChild(h),this._sourceIndexToPreviewIndex[e]=g,d=d.getNext(),++e,++g,f=null!=this._sourceIndexToPreviewIndex[e]}}finally{b._endBlockChanges([GNode._Change.BeforeChildInsert,GNode._Change.AfterChildInsert])}this._elementPreview.transferProperties(this._element,[GShape.GeometryProperties,GPath.GeometryProperties])},b.prototype.constrainPosition=function(a,b,c){var d=new GPoint(c.getProperty("x"),c.getProperty("y")),e=this._element.getTransform();e=e?e.multiplied(b):b,d=e.mapPoint(d);var f=GMath.convertToConstrain(d.getX(),d.getY(),a.getX(),a.getY(),this._element.getScene().getProperty("crConstraint"));return f},b.prototype._createPathPreviewIfNecessary=function(a){if(!this._elementPreview){this._sourceIndexToPreviewIndex={},this._elementPreview=new GPath,this._elementPreview.transferProperties(this._element,[GShape.GeometryProperties,GPath.GeometryProperties]);for(var b,c,d,e=function(b){return a&&b===a||!a&&b.hasFlag(GNode.Flag.Selected)},f=this._element.getAnchorPoints(),g=this._elementPreview.getAnchorPoints(),h=null,i=null,j=f.getFirstChild();!(null==j||h&&i);j=j.getNext())b=f.getPreviousPoint(j),c=f.getNextPoint(j),h||(!b&&e(j)?h=j:!e(j)&&c&&e(c)&&(d=f.getFirstRelatedPoint(c),e(d)||f.getPreviousPoint(d)&&e(f.getPreviousPoint(d))||(h=d))),i||(!c&&e(j)?i=j:!e(j)&&b&&e(b)&&(d=f.getLastRelatedPoint(b),e(d)||f.getNextPoint(d)&&e(f.getNextPoint(d))||(i=d)));if((h&&!i||!h&&i||h&&i&&h===i)&&(h=null,i=null),h&&i)for(var k=!0,j=f.getNextPoint(i);j&&j!=h&&k;j=f.getNextPoint(j))e(j)&&(k=!1,h=null,i=null);h=h?h:f.getFirstChild();var l=!1,j=h;g._beginBlockChanges([GNode._Change.BeforeChildInsert,GNode._Change.AfterChildInsert]);try{for(;!l;){var m=new GPathBase.AnchorPoint;m.transferProperties(j,[GPathBase.AnchorPoint.GeometryProperties]),e(j)&&m.setFlag(GNode.Flag.Selected),g.appendChild(m);var n=f.getIndexOfChild(j),o=g.getIndexOfChild(m);this._sourceIndexToPreviewIndex[n]=o,j==i&&(l=!0),j=f.getNextPoint(j),j&&j!=h||(l=!0)}}finally{g._endBlockChanges([GNode._Change.BeforeChildInsert,GNode._Change.AfterChildInsert])}this._elementPreview.transferProperties(this._element,[GShape.GeometryProperties,GPath.GeometryProperties]),h.getProperty("ah")||i&&i.getProperty("ah")?this.extendPreviewToFull():this._elementPreview.getProperty("closed")&&i&&this._elementPreview.setProperty("closed",!1)}return this._elementPreview},b.prototype.releasePathPreview=function(){this._elementPreview=null,this._sourceIndexToPreviewIndex=null},b.prototype.getPathPointPreview=function(a){var b=a.getParent().getIndexOfChild(a);this._sourceIndexToPreviewIndex?null==this._sourceIndexToPreviewIndex[b]&&this._createPathPreviewIfNecessary(a):this.extendPreviewToFull(),this.requestInvalidation();var c=this._sourceIndexToPreviewIndex[b];return this._elementPreview.getAnchorPoints().getChildByIndex(c)},b.prototype.getTransformFromNative=function(a){var b=this._element.getTransform();return a&&(b=b?b.multiplied(a):a),b||(b=new GTransform),b},b.prototype.movePoint=function(a,b,c,d){var e=this.getTransformFromNative(c),f=e.inverted(),g=f.mapPoint(b);if(a.getProperty("ah"))a.setProperties(["x","y"],[g.getX(),g.getY()]);else{var h=d?d:a,i=h.getProperty("hlx"),j=h.getProperty("hly"),k=h.getProperty("hrx"),l=h.getProperty("hry");if(null!=i&&null!=j||null!=k&&null!=l){var m=e.mapPoint(new GPoint(h.getProperty("x"),h.getProperty("y"))),n=b.getX()-m.getX(),o=b.getY()-m.getY();if(null!=i&&null!=j){var p=f.mapPoint(e.mapPoint(new GPoint(i,j)).translated(n,o));i=p.getX(),j=p.getY()}if(null!=k&&null!=l){var p=f.mapPoint(e.mapPoint(new GPoint(k,l)).translated(n,o));k=p.getX(),l=p.getY()}}a.setProperties(["x","y","hlx","hly","hrx","hry"],[g.getX(),g.getY(),i,j,k,l])}},b.prototype.getPartSelection=function(){return this._partSelection},b.prototype._movePreviewPointCoordinates=function(a,b,c,d,e,f){var g=d;if(f){var h=e.inverted();g=this.constrainPosition(d,h,a)}g=e.mapPoint(g);var i=this._element.getTransform(),j=new GPoint(a.getProperty(b),a.getProperty(c));i&&(j=i.mapPoint(j)),this._transformPreviewPointCoordinates(a,b,c,new GTransform(1,0,0,1,g.getX()-j.getX(),g.getY()-j.getY()))},b.prototype._transformPreviewPointCoordinates=function(a,b,c,d,e){var f=this._element.getTransform(),g=this.getPathPointPreview(a);if(g){if(e)var h=e;else var h=new GPoint(a.getProperty(b),a.getProperty(c));var i=d;f&&(i=d.multiplied(f.inverted()),i=f.multiplied(i));var j=i.mapPoint(h),k=[b,c],l=[j.getX(),j.getY()];("hlx"===b||"hrx"===b||"hly"===c||"hry"===c)&&(k.push("ah"),l.push(!1)),g.setProperties(k,l)}},b.prototype._movePreviewPointShoulders=function(a,c,d){var e,f=this._element.getTransform(),g=new GPoint(a.point.getProperty("x"),a.point.getProperty("y"));e=a.type==b.PartType.LeftShoulder?a.point.getLeftShoulderLimitPoint():a.point.getRightShoulderLimitPoint(),f&&(g=f.mapPoint(g),e=f.mapPoint(e));var h=GMath.getVectorProjection(g.getX(),g.getY(),e.getX(),e.getY(),c.getX(),c.getY(),!0),i=GMath.ptDist(h.getX(),h.getY(),g.getX(),g.getY()),j=this.getPathPointPreview(a.point);if(d)if(this.hasFlag(GElementEditor.Flag.Detail)&&1!=j.getProperty("cu")){var k=a.point.getProperty("cl");k=null!=k?k:0;var l=a.point.getProperty("cr");if(l=null!=l?k:0,a.type==b.PartType.LeftShoulder){var m=i-k,n=l-m;n=n>0?n:0,j.setProperties(["cl","cr"],[i,n])}else{var m=i-l,o=k-m;o=o>0?o:0,j.setProperties(["cl","cr"],[o,i])}}else j.setProperties(["cl","cr"],[i,i]);else a.type==b.PartType.LeftShoulder?j.setProperty("cl",i):j.setProperty("cr",i)},b.prototype._assignPreviewPointPropertiesToSourcePoint=function(a,b){var c=this.getPathPointPreview(a);c&&a.setProperties(b,c.getProperties(b))},b.prototype._transferPreviewProperties=function(a,b){var c=this._element.getAnchorPoints().getIndexOfChild(a),d=b.getAnchorPoints().getChildByIndex(c),e=this.getPathPointPreview(d);e&&d.transferProperties(e,[GPathBase.AnchorPoint.GeometryProperties])},b.prototype._filterSelection=function(a){if(!a)return null;for(var c,d=[],e=0;e<a.length;++e)if(a[e].type!=b.PartType.Point)d.push(a[e]);else{c=!0;for(var f=0;f<a.length;++f)if(a[f].type==b.PartType.Segment&&(a[e].point==a[f].apLeft||a[e].point==a[f].apRight)){c=!1;break}c&&d.push(a[e])}return d},b.prototype._geometryChange=function(a){a.type==GElement.GeometryChangeEvent.Type.After&&a.element==this._element&&this._elementPreview&&(this.releasePathPreview(),this.requestInvalidation())},b.prototype.toString=function(){return"[Object GPathEditor]"},a.GPathEditor=b}(this),function(a){function b(a){GShapeEditor.call(this,a),this._flags|=GBlockEditor.Flag.ResizeAll}GObject.inherit(b,GShapeEditor),GElementEditor.exports(b,GImage),b.prototype.initialSetup=function(){},b.prototype.toString=function(){return"[Object GImageEditor]"},a.GImageEditor=b}(this),function(a){function b(a){GShapeEditor.call(this,a)}GObject.inherit(b,GShapeEditor),GElementEditor.exports(b,GCompoundPath),b.prototype.transform=function(a,b,c){if(b&&GUtil.dictionaryContainsValue(GPathEditor.PartType,b.type))for(var d=0;d<this._editors.length;++d){var e=this._editors[d];e.getPartSelection()&&e.transform(a,b,c)}else GShapeEditor.prototype.transform.call(this,a,b,c)},b.prototype._setTransform=function(a){for(var b=0;b<this._editors.length;++b){var c=this._editors[b];c._setTransform(a)}},b.prototype.resetTransform=function(){for(var a=0;a<this._editors.length;++a){var b=this._editors[a];b.resetTransform()}},b.prototype.canApplyTransform=function(){for(var a=!1,b=0;b<this._editors.length;++b){var c=this._editors[b];a=a||c.canApplyTransform()}return a},b.prototype.applyTransform=function(){for(var a=0;a<this._editors.length;++a){var b=this._editors[a];b.canApplyTransform()&&b.applyTransform(b._element)}},b.prototype._attach=function(){var a=this._element.getScene();null!=a&&a.addEventListener(GElement.GeometryChangeEvent,this._geometryChange,this)},b.prototype._detach=function(){for(var a=this._element.getAnchorPaths().getFirstChild();null!=a;a=a.getNext())a.removeFlag(GNode.Flag.Selected);var b=this._element.getScene();null!=b&&b.removeEventListener(GElement.GeometryChangeEvent,this._geometryChange),GShapeEditor.prototype._detach.call(this)},b.prototype._getPartInfoAt=function(a,b,c){for(var d=null,e=this._element.getAnchorPaths().getFirstChild();null!=e;e=e.getNext()){var f=GElementEditor.openEditor(e);if(d=f._getPartInfoAt(a,b,c))return d}return null},b.prototype._prePaint=function(a,b){if(this.hasFlag(GElementEditor.Flag.Selected)||this.hasFlag(GElementEditor.Flag.Highlighted)){var c=this.getPaintElement(),d=new GVertexTransformer(c,a);b.canvas.putVertices(new GVertexPixelAligner(d)),b.canvas.strokeVertices(this.hasFlag(GElementEditor.Flag.Highlighted)?b.highlightOutlineColor:b.selectionOutlineColor,1);for(var e=this._element.getAnchorPaths().getFirstChild();null!=e;e=e.getNext()){var f=GElementEditor.openEditor(e);f._prePaint(a,b)}}},b.prototype._postPaint=function(a,b){for(var c=this._element.getAnchorPaths().getFirstChild();null!=c;c=c.getNext()){var d=GElementEditor.openEditor(c);d._postPaint(a,b)}},b.prototype._partIdAreEqual=function(a,b){var c=a.type===b.type;return c&&a.type==GPathEditor.PartType.Point?c=a.point===b.point:c&&a.type==GPathEditor.PartType.Segment&&(c=a.apLeft===b.apLeft&&a.apRight==b.apRight),c},b.prototype.updatePartSelection=function(a,b){if(this._partSelection&&(this._partSelection=null),!b&&this.hasFlag(GElementEditor.Flag.Selected))for(var c=0;c<this._editors.length;++c)this._editors[c].updatePartSelection(a,null)},b.prototype.isPartSelectionUnderCollisionAllowed=function(){return!0},b.prototype.updatePartSelectionUnderCollision=function(a,b){for(var c=this._element.getAnchorPaths().getFirstChild();null!=c;c=c.getNext()){var d=GElementEditor.openEditor(c);d.updatePartSelectionUnderCollision(a,b)}},b.prototype.isDeletePartsAllowed=function(){var a=!1;if(this.hasFlag(GElementEditor.Flag.Selected))for(var b=this._element.getAnchorPaths().getFirstChild();null!=b&&!a;b=b.getNext()){var c=GElementEditor.openEditor(b);a=c.isDeletePartsAllowed()}return a},b.prototype.deletePartsSelected=function(){for(var a=this._element.getAnchorPaths().getFirstChild();null!=a;a=a.getNext()){var b=GElementEditor.openEditor(a);b.isDeletePartsAllowed()&&b.deletePartsSelected()}},b.prototype.isAlignPartsAllowed=function(){var a=!1;if(this.hasFlag(GElementEditor.Flag.Selected))for(var b=this._element.getAnchorPaths().getFirstChild();null!=b&&!a;b=b.getNext()){var c=GElementEditor.openEditor(b);a=c.isAlignPartsAllowed()}return a},b.prototype.alignParts=function(a,b,c){for(var d=this._element.getAnchorPaths().getFirstChild();null!=d;d=d.getNext()){var e=GElementEditor.openEditor(d);e.isAlignPartsAllowed()&&e.alignParts(a,b,c)}},b.prototype._geometryChange=function(a){a.type==GElement.GeometryChangeEvent.Type.After&&a.element==this._element&&this.requestInvalidation()},b.prototype.setFlag=function(a){if(0==(this._flags&a)){this.requestInvalidation(),this._flags=this._flags|a;for(var b=this._element.getAnchorPaths().getFirstChild();null!=b;b=b.getNext()){var c=GElementEditor.openEditor(b);c.setFlag(a)}this.requestInvalidation()}},b.prototype.removeFlag=function(a){if(0!=(this._flags&a)){this.requestInvalidation(),this._flags=this._flags&~a;for(var b=this._element.getAnchorPaths().getFirstChild();null!=b;b=b.getNext()){var c=GElementEditor.openEditor(b);c.removeFlag(a)}this.requestInvalidation()}},b.prototype.releasePathPreview=function(){for(var a=this._element.getAnchorPaths().getFirstChild();null!=a;a=a.getNext()){var b=GElementEditor.getEditor(a);b&&b.releasePathPreview()}},b.prototype.toString=function(){return"[Object GCompoundPathEditor]"},a.GCompoundPathEditor=b}(this),function(a){function b(a){GBlockEditor.call(this,a),this._flags|=GBlockEditor.Flag.ResizeAll}GObject.inherit(b,GBlockEditor),GElementEditor.exports(b,GSlice),b.prototype._prePaint=function(a,b){(this.hasFlag(GElementEditor.Flag.Selected)||this.hasFlag(GElementEditor.Flag.Highlighted))&&this._paintBBoxOutline(a,b),GBlockEditor.prototype._prePaint.call(this,a,b)},b.prototype.toString=function(){return"[Object GSliceEditor]"},a.GSliceEditor=b}(this),function(a){function b(a){GBlockEditor.call(this,a),this._flags|=GBlockEditor.Flag.ResizeAll}GObject.inherit(b,GBlockEditor),b.exports(b,GPage),b.prototype.canApplyTransform=function(){if(this._transform&&!this._transform.isIdentity()&&!this.getElement().hasFlag(GElement.Flag.Locked)){var a=this._transform.mapRect(new GRect(this._element.getProperty("x"),this._element.getProperty("y"),this._element.getProperty("w"),this._element.getProperty("h")));return this._element.getScene().willPageIntersectWithOthers(this._element,a)?!1:!0}return!1},b.prototype.applyTransform=function(){if(this._transform&&!this._transform.isIdentity()){var a=this._transform.mapRect(new GRect(this._element.getProperty("x"),this._element.getProperty("y"),this._element.getProperty("w"),this._element.getProperty("h")));this._element.setProperties(["x","y","w","h"],[a.getX(),a.getY(),a.getWidth(),a.getHeight()]),this._transform=null}this.resetTransform()},b.prototype._prePaint=function(a,b){(this.hasFlag(GElementEditor.Flag.Selected)||this.hasFlag(GElementEditor.Flag.Highlighted))&&this._paintBBoxOutline(a,b),GBlockEditor.prototype._prePaint.call(this,a,b)},b.prototype.toString=function(){return"[Object GPageEditor]"},a.GPageEditor=b}(this),function(a){function b(a){GBlockEditor.call(this,a),this._flags|=GBlockEditor.Flag.ResizeAll}GObject.inherit(b,GBlockEditor),GElementEditor.exports(b,GLayer),b.prototype.paint=function(a,b){var c=b.selectionOutlineColor,d=this._element.getProperty("cls");b.selectionOutlineColor=d,GBlockEditor.prototype.paint.call(this,a,b),b.selectionOutlineColor=c},b.prototype._prePaint=function(a,b){(this.hasFlag(GElementEditor.Flag.Selected)||this.hasFlag(GElementEditor.Flag.Highlighted))&&this._paintBBoxOutline(a,b),GBlockEditor.prototype._prePaint.call(this,a,b)},b.prototype.toString=function(){return"[Object GLayerEditor]"},a.GLayerEditor=b}(this),function(a){function b(){}GObject.inherit(b,GObject),b.prototype._manager=null,b.prototype._scene=null,b.prototype._view=null,b.prototype._editor=null,b.prototype.getCursor=function(){return GCursor.Default},b.prototype.activate=function(a){this._scene=a?a.getScene():null,this._view=a,this._editor=a.getEditor()},b.prototype.deactivate=function(a){if(a.getScene()!=this._scene||a!=this._view)throw new Error("Not supposed to happen");this._scene=null,this._view=null,this._editor=null},b.prototype.isDeactivatable=function(){return!0},b.prototype.paint=function(){},b.prototype.updateCursor=function(){this._manager&&this==this._manager.getActiveTool()&&this._manager._updateActiveToolCursor()},b.prototype.invalidateArea=function(a){this._manager&&this==this._manager.getActiveTool()&&this._manager._invalidateActiveToolArea(a)},b.prototype.catchesContextMenu=function(){return!1},b.prototype.toString=function(){return"[Object GTool]"},a.GTool=b}(this),function(a){function b(){this._tools=[],this._typeIdToIndexMap={},this._paintLink=this._paint.bind(this)}GObject.inheritAndMix(b,GObject,[GEventTarget]),b.ToolChangedEvent=function(a,b){this.previousTool=a,this.newTool=b},GObject.inherit(b.ToolChangedEvent,GEvent),b.ToolChangedEvent.prototype.previousTool=null,b.ToolChangedEvent.prototype.newTool=null,b.ToolChangedEvent.prototype.toString=function(){return"[Event GToolManager.ToolChangedEvent]"},b.prototype._tools=null,b.prototype._typeIdToIndexMap=null,b.prototype._activeTool=null,b.prototype._view=null,b.prototype._viewStage=null,b.prototype._temporaryActiveTool=null,b.prototype._temporarySubselect=!1,b.prototype.addTool=function(a){if(a._manager)throw new Error("Tool is already registered");this._tools.push(a),a._manager=this,this._typeIdToIndexMap={};for(var b=0;b<this._tools.length;++b){var a=this._tools[b];this._typeIdToIndexMap[GObject.getTypeId(a)]=b}this._activeTool||this.activateTool(a)},b.prototype.hasTool=function(a){return this._typeIdToIndexMap.hasOwnProperty(GObject.getTypeId(a))},b.prototype.getToolCount=function(){return this._tools.length},b.prototype.indexOf=function(a){return this._typeIdToIndexMap.hasOwnProperty(GObject.getTypeId(a))?this._typeIdToIndexMap[GObject.getTypeId(a)]:-1},b.prototype.getTool=function(a){return a>=0&&a<this._tools.length?this._tools[a]:null},b.prototype.getActiveTool=function(){return this._activeTool},b.prototype.getTemporaryActiveTool=function(){return this._temporaryActiveTool},b.prototype.activateTool=function(a){return this._temporaryActiveTool?!1:this._activateTool(a)},b.prototype.setView=function(a){a!=this._view&&(this._view&&(this._removeActiveToolFromView(),this._viewStage.paint=null,ifPlatform.removeEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged)),this._view=a,this._viewStage=a?a.getToolStage():null,this._view&&(this._addActiveToolToView(),this._viewStage.paint=this._paintLink,ifPlatform.addEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged,this)))},b.prototype._activateTool=function(a){if(this._activeTool&&!this._activeTool.isDeactivatable())return!1;if(a instanceof GTool||(a=this.getTool(this.indexOf(a))),a!=this._activeTool){this._removeActiveToolFromView();var c=this._activeTool;return this._activeTool=a,this.hasEventListeners(b.ToolChangedEvent)&&this.trigger(new b.ToolChangedEvent(c,a)),this._addActiveToolToView(),!0}return!1},b.prototype._addActiveToolToView=function(){this._activeTool&&this._view&&(this._activeTool.activate(this._view),this._updateActiveToolCursor())},b.prototype._removeActiveToolFromView=function(){this._activeTool&&this._view&&(this._activeTool.deactivate(this._view),this._view.setCursor(null),this._view.getEditor().closeInlineEditor())
},b.prototype._updateActiveToolCursor=function(){this._activeTool&&this._view&&this._view.setCursor(this._activeTool.getCursor())},b.prototype._invalidateActiveToolArea=function(a){this._activeTool&&this._view&&this._viewStage.invalidate(a)},b.prototype._paint=function(a){this._activeTool&&this._activeTool.paint(a)},b.prototype._updateTemporaryTool=function(){if(!this._view.getEditor().isInlineEditing()){var a=this.getTool(this.indexOf(GPointerTool)),b=this.getTool(this.indexOf(GSubSelectTool)),c=this.getTool(this.indexOf(GHandTool)),d=this.getTool(this.indexOf(GZoomTool)),e=null;if(ifPlatform.modifiers.metaKey&&!ifPlatform.modifiers.spaceKey&&this._activeTool!==a&&this._temporaryActiveTool!==a&&(e=a),ifPlatform.modifiers.optionKey&&(e===a||this._activeTool instanceof GPointerTool||this._temporaryActiveTool===a)&&(e=b),ifPlatform.modifiers.spaceKey&&this._temporaryActiveTool!==c&&(e=c),ifPlatform.modifiers.metaKey&&(e===c||this._activeTool instanceof GHandTool)&&(e=d),!e&&this._temporaryActiveTool)this._activateTool(this._temporaryActiveTool)&&(this._temporaryActiveTool=null);else if(e&&e!==this._activeTool){var f=this._activeTool;this._activateTool(e)&&(this._temporaryActiveTool||(this._temporaryActiveTool=f))}}},b.prototype._modifiersChanged=function(){this._updateTemporaryTool()},b.prototype.toString=function(){return"[Object GToolManager]"},a.GToolManager=b}(this),function(a){function b(){GTool.call(this)}GObject.inherit(b,GTool),b._Mode={Select:1,Move:2,Moving:3,Transforming:4},b.prototype._selectArea=null,b.prototype._mode=null,b.prototype._elementUnderMouse=null,b.prototype._editorUnderMouseInfo=null,b.prototype._editorMovePartInfo=null,b.prototype._keyDelta=null,b.prototype._moveStart=null,b.prototype._moveStartTransformed=null,b.prototype._moveCurrent=null,b.prototype._visuals=null,b.prototype._visualsArea=null,b.prototype.getCursor=function(){return this._editorUnderMouseInfo?GCursor.SelectDot:GCursor.Select},b.prototype.activate=function(a){GTool.prototype.activate.call(this,a),a.addEventListener(GMouseEvent.DragStart,this._mouseDragStart,this),a.addEventListener(GMouseEvent.Drag,this._mouseDrag,this),a.addEventListener(GMouseEvent.DragEnd,this._mouseDragEnd,this),a.addEventListener(GMouseEvent.Down,this._mouseDown,this),a.addEventListener(GMouseEvent.Release,this._mouseRelease,this),a.addEventListener(GMouseEvent.Move,this._mouseMove,this),a.addEventListener(GMouseEvent.DblClick,this._mouseDblClick,this),a.addEventListener(GKeyEvent.Down,this._keyDown,this),a.addEventListener(GKeyEvent.Release,this._keyRelease,this),ifPlatform.addEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged,this)},b.prototype.deactivate=function(a){this._visualsArea&&(this.invalidateArea(this._visualsArea),this._visualsArea=null),this._mode===b._Mode.Transforming&&this._closeTransformBox(),a.removeEventListener(GMouseEvent.DragStart,this._mouseDragStart),a.removeEventListener(GMouseEvent.Drag,this._mouseDrag),a.removeEventListener(GMouseEvent.DragEnd,this._mouseDragEnd),a.removeEventListener(GMouseEvent.Down,this._mouseDown),a.removeEventListener(GMouseEvent.Release,this._mouseRelease),a.removeEventListener(GMouseEvent.Move,this._mouseMove),a.removeEventListener(GMouseEvent.DblClick,this._mouseDblClick),a.removeEventListener(GKeyEvent.Down,this._keyDown),a.removeEventListener(GKeyEvent.Release,this._keyRelease),ifPlatform.removeEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged),GTool.prototype.deactivate.call(this,a)},b.prototype.isDeactivatable=function(){return!this._mode||this._mode===b._Mode.Transforming},b.prototype.paint=function(a){if(this._mode==b._Mode.Select&&this._hasSelectArea()){var c=Math.floor(this._selectArea.getX())+.5,d=Math.floor(this._selectArea.getY())+.5,e=Math.ceil(this._selectArea.getWidth())-1,f=Math.ceil(this._selectArea.getHeight())-1;a.canvas.strokeRect(c,d,e,f,1,a.selectionOutlineColor)}if(this._visuals){for(var g,h=0;h<this._visuals.length;++h){g=this._visuals[h];var i=g[0],j=g[1];a.canvas.strokeLine(Math.floor(i.getX())+.5,Math.floor(i.getY())+.5,Math.floor(j.getX())+.5,Math.floor(j.getY())+.5,1,a.highlightOutlineColor)}this._visuals=null}},b.prototype._mouseMove=function(a){var c=GElementEditor.getEditor(this._scene);c&&c.isTransformBoxActive()&&this._updateMode(b._Mode.Transforming),this._updateEditorUnderMouse(a.client)},b.prototype._mouseDown=function(a){if(a.button===GMouseEvent.BUTTON_LEFT&&!this._editor.closeInlineEditor()){this._elementUnderMouse=null,this._editor.updateByMousePosition(a.client,this._view.getWorldTransform());var c=GElementEditor.getEditor(this._scene);if(c&&c.isTransformBoxActive())this._mode!=b._Mode.Transforming&&this._updateMode(b._Mode.Transforming),this._editorMovePartInfo=c.getTBoxPartInfoAt(a.client,this._view.getWorldTransform(),this._scene.getProperty("pickDist"));else{this._updateMode(b._Mode.Select);var d=ifPlatform.modifiers.metaKey&&null==this._manager.getTemporaryActiveTool();if(!d){var e=GElementEditor.getEditor(this._scene);if(e){var f=e.getPartInfoAt(a.client,this._view.getWorldTransform(),function(a){return a.hasFlag(GElementEditor.Flag.Selected)}.bind(this),this._scene.getProperty("pickDist"));if(f){var g=f.editor,h=f.id,i=f.selectable;(ifPlatform.modifiers.shiftKey||!g.isPartSelected(h)&&i)&&g.updatePartSelection(ifPlatform.modifiers.shiftKey,[h]),(!i||g.isPartSelected(h))&&(this._editorMovePartInfo=f),this._updateMode(b._Mode.Move)}}}}if(this._mode===b._Mode.Select){var j,k=this._editor.getSelection(),l=[],m=null;if(k&&k.length&&!d)for(var n=0;n<k.length&&!m;++n)k[n]instanceof GElement&&(j=k[n],m=j.hitTest(a.client,this._view.getWorldTransform(),null,d,-1,this._scene.getProperty("pickDist"),!0));if(m)l.push(j);else{var o=this._scene.hitTest(a.client,this._view.getWorldTransform(),null,d,-1,this._scene.getProperty("pickDist"),!1,this._selectFilter);if(o){for(var p=[],n=0;n<o.length;++n)p.push(o[n].element);l=this._getSelectableElements(p)}}if(l.length>0)if(l.length>1){for(var q=null,n=0;n<l.length;++n)l[n].hasFlag(GNode.Flag.Selected)&&(q=n);null==q||q+1>=l.length?this._editor.updateSelection(ifPlatform.modifiers.shiftKey,[l[0]]):this._editor.updateSelection(ifPlatform.modifiers.shiftKey,[l[q+1]])}else{if(this._elementUnderMouse=l[0],ifPlatform.modifiers.shiftKey||!this._elementUnderMouse.hasFlag(GNode.Flag.Selected))this._editor.updateSelection(ifPlatform.modifiers.shiftKey,[this._elementUnderMouse]);else if(this._elementUnderMouse.hasFlag(GNode.Flag.Selected)){var g=GElementEditor.getEditor(this._elementUnderMouse);g&&g.updatePartSelection(!1,null)}k=this._editor.getSelection(),k&&k.length>0&&this._updateMode(b._Mode.Move)}else this._editor.updateSelection(ifPlatform.modifiers.shiftKey,[])}}},b.prototype._mouseRelease=function(a){this._editorMovePartInfo=null,this._moveStart=null,this._moveStartTransformed=null,this._moveCurrent=null,this._mode!=b._Mode.Transforming&&this._updateMode(null),this._updateEditorUnderMouse(a.client)},b.prototype._mouseDragStart=function(a){this._visualsArea&&(this.invalidateArea(this._visualsArea),this._visualsArea=null);var c=GElementEditor.getEditor(this._scene);c&&c.isTransformBoxActive()?this._mode!=b._Mode.Transforming&&(c.setTransformBoxActive(!1),this._updateMode(null)):this._mode==b._Mode.Transforming&&this._updateMode(null),this._mode==b._Mode.Move?(this._moveStart=a.client,this._moveStartTransformed=this._view.getViewTransform().mapPoint(this._moveStart),this._updateMode(b._Mode.Moving)):this._mode==b._Mode.Transforming&&(this._moveStart=a.client,this._moveStartTransformed=this._view.getViewTransform().mapPoint(this._moveStart),c.startTBoxTransform(this._editorMovePartInfo))},b.prototype._mouseDrag=function(a){if(this._mode==b._Mode.Transforming){var c=GElementEditor.getEditor(this._scene);c&&c.isTransformBoxActive()||this._updateMode(null)}this._mode==b._Mode.Moving||this._mode==b._Mode.Transforming?(this._moveCurrent=a.client,this._updateSelectionTransform()):this._mode==b._Mode.Select&&(this._hasSelectArea()&&this.invalidateArea(this._selectArea),this._selectArea=GRect.fromPoints(a.clientStart,a.client),this._hasSelectArea()&&this.invalidateArea(this._selectArea))},b.prototype._mouseDragEnd=function(){if(this._mode==b._Mode.Moving)if(this._editorMovePartInfo&&this._editorMovePartInfo.isolated){this._editor.beginTransaction();try{this._editorMovePartInfo.editor.applyPartMove(this._editorMovePartInfo.id,this._editorMovePartInfo.data)}finally{var a=this._editorMovePartInfo.editor.getElement().getNodeNameTranslated();a||(a="Element"),this._editor.commitTransaction("Modify "+a)}}else this._editor.applySelectionTransform(ifPlatform.modifiers.optionKey);else if(this._mode==b._Mode.Select)if(this._hasSelectArea()){var c=this._view.getViewTransform().mapRect(this._selectArea),d=c.getX(),e=c.getY(),f=d+c.getWidth(),g=e+c.getHeight(),h=new GVertexContainer;h.addVertex(GVertex.Command.Move,d,e),h.addVertex(GVertex.Command.Line,f,e),h.addVertex(GVertex.Command.Line,f,g),h.addVertex(GVertex.Command.Line,d,g),h.addVertex(GVertex.Command.Close,0,0);var i=this._scene.getCollisions(h,GElement.CollisionFlag.GeometryBBox|GElement.CollisionFlag.Partial,null,this._selectFilter),j=this._getSelectableElements(i);this._editor.updateSelectionUnderCollision(ifPlatform.modifiers.shiftKey,j,h);var k=this._selectArea;this._selectArea=null,this.invalidateArea(k)}else this._selectArea=null;else if(this._mode==b._Mode.Transforming){var l=GElementEditor.getEditor(this._scene);l&&l.isTransformBoxActive()&&(l.applyTBoxTransform(ifPlatform.modifiers.optionKey),this.invalidateArea())}},b.prototype._mouseDblClick=function(a){if(!this._closeTransformBox()){var b=!0;this._elementUnderMouse&&this._editor.openInlineEditor(this._elementUnderMouse,this._view,a.client)&&(b=!1),b&&this._openTransformBox()}},b.prototype._keyDown=function(a){if(!(a.key!==GKey.Constant.UP&&a.key!==GKey.Constant.DOWN&&a.key!==GKey.Constant.LEFT&&a.key!==GKey.Constant.RIGHT||!this._editor.hasSelection()||this._mode&&this._mode!==b._Mode.Moving)){this._mode!==b._Mode.Moving&&this._updateMode(b._Mode.Moving);var c=this._scene.getProperty(ifPlatform.modifiers.shiftKey?"crDistBig":"crDistSmall"),d=0,e=0;switch(a.key){case GKey.Constant.UP:e-=c;break;case GKey.Constant.DOWN:e+=c;break;case GKey.Constant.LEFT:d-=c;break;case GKey.Constant.RIGHT:d+=c}this._keyDelta=this._keyDelta?this._keyDelta.add(new GPoint(d,e)):new GPoint(d,e),this._editor.moveSelection(this._keyDelta,!1)}},b.prototype._keyRelease=function(a){(a.key===GKey.Constant.UP||a.key===GKey.Constant.DOWN||a.key===GKey.Constant.LEFT||a.key===GKey.Constant.RIGHT)&&this._keyDelta&&(this._editor.applySelectionTransform(),this._keyDelta=null,this._updateMode(null))},b.prototype._modifiersChanged=function(a){var c=GElementEditor.getEditor(this._scene);c&&c.isTransformBoxActive()?this._mode!=b._Mode.Transforming&&this._updateMode(b._Mode.Transforming):this._mode==b._Mode.Transforming&&this._updateMode(null),!(a.changed.shiftKey||a.changed.optionKey||a.changed.metaKey)||this._mode!==b._Mode.Moving&&this._mode!=b._Mode.Transforming||this._updateSelectionTransform()},b.prototype._closeTransformBox=function(){var a=GElementEditor.getEditor(this._scene);return a&&a.isTransformBoxActive()?(a.setTransformBoxActive(!1),this._updateMode(null),this.invalidateArea(),this.updateCursor(),!0):!1},b.prototype._openTransformBox=function(){var a=GElementEditor.getEditor(this._scene);a=a?a:GElementEditor.openEditor(this._scene),a.setTransformBoxActive(!0),a.isTransformBoxActive()&&this._updateMode(b._Mode.Transforming)},b.prototype._updateSelectionTransform=function(){if(this._mode==b._Mode.Moving){var a=this._moveCurrent;if(this._editorMovePartInfo&&this._editorMovePartInfo.isolated){var c=this._editor.getSelection();if(this._editorMovePartInfo.id===GBlockEditor.RESIZE_HANDLE_PART_ID){c=[],c=c.concat(this._editor.getSelection());for(var d=this._editorMovePartInfo.editor.getElement(),e=0;e<c.length&&d!=c[e];++e);e<c.length&&d==c[e]&&(c=c.splice(e,1))}this._editor.getGuides().getShapeBoxGuide().useExclusions(c),this._editor.getGuides().beginMap(),this._editorMovePartInfo.editor.movePart(this._editorMovePartInfo.id,this._editorMovePartInfo.data,a,this._view.getViewTransform(),this._editor.getGuides(),ifPlatform.modifiers.shiftKey,ifPlatform.modifiers.optionKey),this._editor.getGuides().finishMap()}else{if(ifPlatform.modifiers.shiftKey){var f=this._scene.getProperty("crConstraint");a=GMath.convertToConstrain(this._moveStart.getX(),this._moveStart.getY(),a.getX(),a.getY(),f)}if(a=this._view.getViewTransform().mapPoint(a),this._editorMovePartInfo&&this._editorMovePartInfo.id&&(this._editorMovePartInfo.id.type==GPathEditor.PartType.Point||this._editorMovePartInfo.id.type==GPathEditor.PartType.Segment)){this._editor.getGuides().beginMap(),a=this._editor.getGuides().mapPoint(a),this._editor.getGuides().finishMap();var g=a.subtract(this._moveStartTransformed);if(this._editorMovePartInfo.id.type==GPathEditor.PartType.Point){var h=this._editorMovePartInfo.editor.getPointCoord(this._editorMovePartInfo.id.point);g=a.subtract(h)}this._editor.moveSelection(g,!1,this._editorMovePartInfo?this._editorMovePartInfo.id:null,this._editorMovePartInfo?this._editorMovePartInfo.data:null)}else{var g=a.subtract(this._moveStartTransformed);this._editor.moveSelection(g,!0,this._editorMovePartInfo?this._editorMovePartInfo.id:null,this._editorMovePartInfo?this._editorMovePartInfo.data:null,this._moveStartTransformed)}}}else if(this._mode==b._Mode.Transforming){var i=GElementEditor.getEditor(this._scene);if(i&&i.isTransformBoxActive()&&this._moveStart){var j=this._view.getViewTransform().mapPoint(this._moveCurrent);i.transformTBox(this._moveStartTransformed,j,ifPlatform.modifiers.optionKey,ifPlatform.modifiers.shiftKey),this.invalidateArea()}}},b.prototype._updateMode=function(a){a!==this._mode&&(this._mode=a)},b.prototype._updateEditorUnderMouse=function(a){var c=!1;if(this._visuals=null,this._mode==b._Mode.Transforming){var d=GElementEditor.getEditor(this._scene);d&&d.isTransformBoxActive()?(this._editorUnderMouseInfo&&(this._editorUnderMouseInfo=null),d.updateTBoxUnderMouse(a,this._view.getWorldTransform(),this._view),c=!0):this._updateMode(null)}var e=null;if(!this._mode){var f=GElementEditor.getEditor(this._scene);f&&(e=f.getPartInfoAt(a,this._view.getWorldTransform(),function(a){return a.hasFlag(GElementEditor.Flag.Selected)}.bind(this),this._scene.getProperty("pickDist")),e!==this._editorUnderMouseInfo&&(this._editorUnderMouseInfo=e,c=!0,this.updateCursor()))}var g=null;if(this._visuals=null,!this._mode&&!e||this._mode==b._Mode.Select){var h,i=this._editor.getSelection(),j=null,k=!1;if(i&&1==i.length&&i[0]instanceof GItem&&(j=i[0].hitTest(a,this._view.getWorldTransform(),null,k,-1,this._scene.getProperty("pickDist"),!0),j&&(h=i[0])),!h){var l=this._scene.hitTest(a,this._view.getWorldTransform(),null,k,-1,this._scene.getProperty("pickDist"));if(l&&l.length)for(var m=0;m<l.length&&!h;++m)l[m].element instanceof GItem&&!l[m].element.hasFlag(GNode.Flag.Selected)&&(h=l[m].element)}if(h&&(g=h.getGeometryBBox(),g&&!g.isEmpty())){g=this._view.getWorldTransform().mapRect(g);var n=this._editor.getGuides().getBBoxSnapZones(g,a);n&&n.length&&(this._visuals=n)}}!c&&this._editorUnderMouseInfo&&(this._editorUnderMouseInfo=null,this.updateCursor());var o=this._visuals?g.expanded(2,2,2,2):null;(this._visualsArea||o)&&(this._visualsArea&&this.invalidateArea(this._visualsArea),o&&this.invalidateArea(o),this._visualsArea=o)},b.prototype._selectFilter=function(a){return a instanceof GLayer&&a.getProperty("tp")!==GLayer.Type.Output&&a.hasFlag(GElement.Flag.Locked)&&!a.hasFlag(GNode.Flag.Active)?!1:!0},b.prototype._getSelectableElements=function(a){for(var b=[],c=0;c<a.length;++c){var d=this._getSelectableElement(a[c]);d&&b.indexOf(d)<0&&b.push(d)}return b},b.prototype._getSelectableElement=function(a){for(var b=a;null!==b;b=b.getParent())if(b instanceof GItem&&(!b.getParent()||!(b.getParent()instanceof GItem)))return b;return null},b.prototype._hasSelectArea=function(){return this._selectArea&&(this._selectArea.getHeight()>0||this._selectArea.getWidth()>0)},b.prototype.toString=function(){return"[Object GSelectTool]"},a.GSelectTool=b}(this),function(a){function b(a){GTool.call(this),this._areaSelector=a}GObject.inherit(b,GTool),b._AreaSelector=function(){this._vertexContainer=new GVertexContainer,this._pixelTransformer=new GVertexPixelAligner(this._vertexContainer)},b._AreaSelector.prototype._vertexContainer=null,b._AreaSelector.prototype._pixelTransformer=null,b._AreaSelector.prototype.getAreaBounds=function(){return ifVertexInfo.calculateBounds(this._pixelTransformer,!1)},b._AreaSelector.prototype.begin=function(){this._vertexContainer.clearVertices()},b._AreaSelector.prototype.finish=function(){},b._AreaSelector.prototype.start=function(){},b._AreaSelector.prototype.move=function(){},b._AreaSelector.prototype.paint=function(a){a.canvas.putVertices(this._pixelTransformer),a.canvas.strokeVertices(GRGBColor.BLACK)},b.prototype._areaSelector=null,b.prototype._areaBounds=null,b.prototype.activate=function(a){GTool.prototype.activate.call(this,a),a.addEventListener(GMouseEvent.DragStart,this._mouseDragStart,this),a.addEventListener(GMouseEvent.Drag,this._mouseDrag,this),a.addEventListener(GMouseEvent.DragEnd,this._mouseDragEnd,this),a.addEventListener(GMouseEvent.Down,this._mouseDown,this),a.addEventListener(GMouseEvent.Release,this._mouseRelease,this),ifPlatform.addEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged,this)},b.prototype.deactivate=function(a){GTool.prototype.deactivate.call(this,a),a.removeEventListener(GMouseEvent.DragStart,this._mouseDragStart),a.removeEventListener(GMouseEvent.Drag,this._mouseDrag),a.removeEventListener(GMouseEvent.DragEnd,this._mouseDragEnd),a.removeEventListener(GMouseEvent.Down,this._mouseDown),a.removeEventListener(GMouseEvent.Release,this._mouseRelease),ifPlatform.removeEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged)},b.prototype.isDeactivatable=function(){return!this._areaBounds},b.prototype.paint=function(a){this._areaBounds&&this._areaSelector.paint(a)},b.prototype._mouseDown=function(a){a.button===GMouseEvent.BUTTON_LEFT&&this._editor.updateByMousePosition(a.client,this._view.getWorldTransform())},b.prototype._mouseRelease=function(){if(!this._areaBounds||this._areaBounds.isEmpty())this._editor.clearSelection();else if(this._areaBounds&&!this._areaBounds.isEmpty()){var a=this._areaBounds;this._areaBounds=null,this.invalidateArea(a)}else this._areaBounds=null},b.prototype._mouseDragStart=function(a){this._areaSelector.begin(),this._areaSelector.start(a.client)},b.prototype._mouseDrag=function(a){this._areaBounds&&this.invalidateArea(this._areaBounds),this._areaSelector.move(a.client),this._updateAreaBoundsAndInvalidate()},b.prototype._mouseDragEnd=function(){if(this._areaBounds){var a=new GVertexTransformer(this._areaSelector._pixelTransformer,this._view.getViewTransform()),b=function(a){return a instanceof GItem},c=this._scene.getCollisions(a,GElement.CollisionFlag.GeometryBBox|GElement.CollisionFlag.Partial,b);this._editor.updateSelectionUnderCollision(ifPlatform.modifiers.shiftKey,c,a)}this._areaSelector.finish()},b.prototype._modifiersChanged=function(){},b.prototype._updateAreaBoundsAndInvalidate=function(){this._areaBounds=this._areaSelector.getAreaBounds(),this._areaBounds&&this._areaBounds.isEmpty()&&(this._areaBounds=null),this._areaBounds&&(this._areaBounds=this._areaBounds.expanded(1,1,1,1),this.invalidateArea(this._areaBounds))},b.prototype.toString=function(){return"[Object GMarqueeTool]"},a.GMarqueeTool=b}(this),function(a){function b(a,b){GTool.call(this),this._keepRatio=a,this._fromCenter=b}GObject.inherit(b,GTool),b.options={centerCrossSize:4},b.prototype._dragStart=null,b.prototype._dragCurrent=null,b.prototype._keepRatio=!1,b.prototype._fromCenter=!1,b.prototype._shape=null,b.prototype._dragArea=null,b.prototype._dragLine=null,b.prototype._hasCreatedShape=!1,b.prototype.getCursor=function(){return GCursor.Cross},b.prototype.activate=function(a){GTool.prototype.activate.call(this,a),a.addEventListener(GMouseEvent.Move,this._mouseMove,this),a.addEventListener(GMouseEvent.DragStart,this._mouseDragStart,this),a.addEventListener(GMouseEvent.Drag,this._mouseDrag,this),a.addEventListener(GMouseEvent.DragEnd,this._mouseDragEnd,this),a.addEventListener(GMouseEvent.Down,this._mouseDown,this),a.addEventListener(GMouseEvent.Release,this._mouseRelease,this),ifPlatform.addEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged,this)},b.prototype.deactivate=function(a){GTool.prototype.deactivate.call(this,a),a.removeEventListener(GMouseEvent.Move,this._mouseMove,this),a.removeEventListener(GMouseEvent.DragStart,this._mouseDragStart),a.removeEventListener(GMouseEvent.Drag,this._mouseDrag),a.removeEventListener(GMouseEvent.DragEnd,this._mouseDragEnd),a.removeEventListener(GMouseEvent.Down,this._mouseDown),a.removeEventListener(GMouseEvent.Release,this._mouseRelease),ifPlatform.removeEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged)},b.prototype.isDeactivatable=function(){return this._dragStart?!1:!0},b.prototype.paint=function(a){if(this._shape&&(this._paintOutline(a),this._hasCenterCross())){var c=this._shape.getGeometryBBox(),d=4*b.options.centerCrossSize;if(c&&!c.isEmpty()&&c.getWidth()>d&&c.getHeight()>d){var e=b.options.centerCrossSize/2+.5,f=c.getSide(GRect.Side.CENTER),g=Math.floor(f.getX())+.5,h=Math.floor(f.getY())+.5;a.canvas.strokeLine(g-e,h-e,g+e,h+e,1,a.selectionOutlineColor),a.canvas.strokeLine(g+e,h-e,g-e,h+e,1,a.selectionOutlineColor)}}},b.prototype._paintOutline=function(a){a.canvas.putVertices(new GVertexPixelAligner(this._shape)),a.canvas.strokeVertices(a.selectionOutlineColor)},b.prototype._mouseDown=function(a){a.button===GMouseEvent.BUTTON_LEFT&&this._editor.updateByMousePosition(a.client,this._view.getWorldTransform())},b.prototype._mouseRelease=function(a){if(!this._hasCreatedShape){var b=this._view.getViewTransform().mapPoint(a.client);b=this._editor.getGuides().mapPoint(b),this._createShapeManually(b)}this._hasCreatedShape=!1},b.prototype._mouseDragStart=function(a){this._hasCreatedShape=!1,this._dragStart=this._view.getViewTransform().mapPoint(a.client),this._editor.getGuides().beginMap(),this._dragStart=this._editor.getGuides().mapPoint(this._dragStart),this._editor.getGuides().finishMap(),this._shape=this._createShape(),this._invalidateShape(),this.updateCursor()},b.prototype._mouseDrag=function(a){this._dragCurrent=this._view.getViewTransform().mapPoint(a.client),this._invalidateShape()},b.prototype._mouseDragEnd=function(){var a=this._shape;this._shape=null,this._invalidateShapeArea(a),this._prepareShapeForAppend(a),this._dragStart=null,this._dragCurrent=null,this._shape=null,this._dragArea=null,this._dragLine=null,this.updateCursor(),this._insertShape(a),this._hasCreatedShape=!0},b.prototype._mouseMove=function(){},b.prototype._modifiersChanged=function(a){(this._keepRatio&&a.changed.shiftKey||this._fromCenter&&a.changed.optionKey||a.changed.metaKey)&&this._invalidateShape()},b.prototype._invalidateShape=function(){if(this._dragStart&&this._dragCurrent){this._editor.getGuides().beginMap();var a=this._editor.getGuides().mapPoint(this._dragCurrent);if(this._editor.getGuides().finishMap(),GPoint.equals(this._dragStart,a))this._invalidateShapeArea();else{var b=this._dragStart.getX(),c=this._dragStart.getY(),d=a.getX(),e=a.getY(),f=d,g=e;if(this._keepRatio&&ifPlatform.modifiers.shiftKey){var h=Math.abs(d-b),i=Math.abs(e-c),j=b>d?-1:1,k=c>e?-1:1;h>=i?(d=b+h*j,e=c+h*k,g=2*i>h?e:c):(d=b+i*j,e=c+i*k,f=2*h>i?d:b)}var l=null,m=null;this._fromCenter&&ifPlatform.modifiers.optionKey?(l=GRect.fromPoints(new GPoint(b-(d-b),c-(e-c)),new GPoint(b+(d-b),c+(e-c))),m=[new GPoint(b-(f-b),c-(g-c)),new GPoint(b+(f-b),c+(g-c))]):(l=GRect.fromPoints(new GPoint(b,c),new GPoint(d,e)),m=[new GPoint(b,c),new GPoint(f,g)]),this._dragArea=l,this._dragLine=m;var n=this._view.getWorldTransform(),o=n.mapRect(l),p=[n.mapPoint(m[0]),n.mapPoint(m[1])];this._invalidateShapeArea(),this._updateShape(this._shape,o,p,!1),this._invalidateShapeArea()}}},b.prototype._prepareShapeForAppend=function(a){this._updateShape(a,this._dragArea,this._dragLine,!0)},b.prototype._insertShape=function(a){this._editor.insertElements([a])},b.prototype._invalidateShapeArea=function(a){if(a=a||this._shape){var b=a.getGeometryBBox();b&&(b.getWidth()>0||b.getHeight()>0)&&this.invalidateArea(b.expanded(1,1,1,1))}},b.prototype._createShapeManually=function(){},b.prototype._createShape=function(){throw new Error("Not Supported.")},b.prototype._updateShape=function(){throw new Error("Not Supported.")},b.prototype._hasCenterCross=function(){return!1},b.prototype.toString=function(){return"[Object GShapeTool]"},a.GShapeTool=b}(this),function(a){function b(){GSelectTool.call(this)}GObject.inherit(b,GSelectTool),b.prototype.getCursor=function(){var a=GSelectTool.prototype.getCursor.call(this);return a===GCursor.Select?GCursor.SelectInverse:a===GCursor.SelectDot?GCursor.SelectDotInverse:a},b.prototype.activate=function(a){GSelectTool.prototype.activate.call(this,a),this._editor.setSelectionDetail(!0)},b.prototype.deactivate=function(a){this._editor.setSelectionDetail(!1),GSelectTool.prototype.deactivate.call(this,a)},b.prototype._mouseDragStart=function(a){if(this._mode==GSelectTool._Mode.Move){if(this._moveStart=a.client,this._moveStartTransformed=this._view.getViewTransform().mapPoint(this._moveStart),this._updateMode(GSelectTool._Mode.Moving),this._editorMovePartInfo)if(this._editorMovePartInfo.isolated)this._editorMovePartInfo=this._editorMovePartInfo.editor.subSelectDragStartAction(this._editorMovePartInfo);else{var b=this._editor.getSelection();if(b&&b.length)for(var c=0;c<b.length;++c){var d=GElementEditor.getEditor(b[c]);if(d){var e=d.subSelectDragStartAction(this._editorMovePartInfo);if(e){this._editorMovePartInfo=e;break}}}}}else GSelectTool.prototype._mouseDragStart.call(this,a)},b.prototype._getSelectableElement=function(a){return a instanceof GItem?a:null},b.prototype.toString=function(){return"[Object GSubSelectTool]"},a.GSubSelectTool=b}(this),function(a){function b(){GMarqueeTool.call(this,new b._AreaSelector)}GObject.inherit(b,GMarqueeTool),b._AreaSelector=function(){GMarqueeTool._AreaSelector.call(this)},GObject.inherit(b._AreaSelector,GMarqueeTool._AreaSelector),b._AreaSelector.prototype._current=null,b._AreaSelector.prototype.start=function(){this._current=null},b._AreaSelector.prototype.move=function(a){(null==this._current||Math.abs(a.getX()-this._current.getX())>=3||Math.abs(a.getY()-this._current.getY())>=3)&&(this._vertexContainer.addVertex(0==this._vertexContainer.getCount()?GVertex.Command.Move:GVertex.Command.Line,a.getX(),a.getY()),this._current=a)},b.prototype.getCursor=function(){return GCursor.Lasso},b.prototype.toString=function(){return"[Object GLassoTool]"},a.GLassoTool=b}(this),function(a){function b(){GSelectTool.call(this)}GObject.inherit(b,GSelectTool),b.prototype.activate=function(a){GSelectTool.prototype.activate.call(this,a),this._editor.storeSelection();var b=this._scene.getActiveLayer();b?this._editor.updateSelection(!1,[b]):this._editor.clearSelection()},b.prototype.deactivate=function(a){this._editor.restoreSelection(),GSelectTool.prototype.deactivate.call(this,a)},b.prototype._getSelectableElement=function(a){for(var b=a;null!==b;b=b.getParent())if(b instanceof GLayer)return b;return null},b.prototype.toString=function(){return"[Object GLayerTool]"},a.GLayerTool=b}(this),function(a){function b(){GTool.call(this)}GObject.inherit(b,GTool),b.prototype._panning=!1,b.prototype.getCursor=function(){return this._panning?GCursor.HandClosed:GCursor.HandOpen},b.prototype.activate=function(a){GTool.prototype.activate.call(this,a),a.addEventListener(GMouseEvent.DragStart,this._mouseDragStart,this),a.addEventListener(GMouseEvent.Drag,this._mouseDrag,this),a.addEventListener(GMouseEvent.DragEnd,this._mouseDragEnd,this)},b.prototype.deactivate=function(a){GTool.prototype.deactivate.call(this,a),a.removeEventListener(GMouseEvent.DragStart,this._mouseDragStart),a.removeEventListener(GMouseEvent.Drag,this._mouseDrag),a.removeEventListener(GMouseEvent.DragEnd,this._mouseDragEnd)},b.prototype.isDeactivatable=function(){return this._panning?!1:!0},b.prototype._mouseDragStart=function(){this._panning=!0,this.updateCursor()},b.prototype._mouseDrag=function(a){this._panning&&this._view.scrollBy(-a.clientDelta.getX(),-a.clientDelta.getY())},b.prototype._mouseDragEnd=function(){this._panning&&(this._panning=!1,this.updateCursor())},b.prototype.toString=function(){return"[Object GHandTool]"},a.GHandTool=b}(this),function(a){function b(){GTool.call(this)}GObject.inherit(b,GTool),b.options={zoomStep:2},b.prototype._zoomMode=!1,b.prototype._dragArea=null,b.prototype.getCursor=function(){switch(this._zoomMode){case-2:case-1:return GCursor.ZoomMinus;case 1:case 2:return GCursor.ZoomPlus;default:return GCursor.ZoomNone}},b.prototype.activate=function(a){GTool.prototype.activate.call(this,a),this._updateMode(),a.addEventListener(GMouseEvent.DragStart,this._mouseDragStart,this),a.addEventListener(GMouseEvent.Drag,this._mouseDrag,this),a.addEventListener(GMouseEvent.DragEnd,this._mouseDragEnd,this),a.addEventListener(GMouseEvent.Release,this._mouseRelease,this),ifPlatform.addEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged,this)},b.prototype.deactivate=function(a){GTool.prototype.deactivate.call(this,a),a.removeEventListener(GMouseEvent.DragStart,this._mouseDragStart),a.removeEventListener(GMouseEvent.Drag,this._mouseDrag),a.removeEventListener(GMouseEvent.DragEnd,this._mouseDragEnd),a.removeEventListener(GMouseEvent.Release,this._mouseRelease),ifPlatform.removeEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged)},b.prototype.isDeactivatable=function(){return this._dragArea?!1:!0},b.prototype.paint=function(a){if(this._hasDragArea()){var b=Math.floor(this._dragArea.getX())+.5,c=Math.floor(this._dragArea.getY())+.5,d=Math.ceil(this._dragArea.getWidth())-1,e=Math.ceil(this._dragArea.getHeight())-1;a.canvas.strokeRect(b,c,d,e)}},b.prototype._mouseDragStart=function(){},b.prototype._mouseDrag=function(a){0!=this._zoomMode&&(this._hasDragArea()&&this.invalidateArea(this._dragArea),this._dragArea=GRect.fromPoints(a.clientStart,a.client),this._hasDragArea()&&this.invalidateArea(this._dragArea))},b.prototype._mouseDragEnd=function(){if(0!=this._zoomMode)if(this._dragArea&&!this._dragArea.isEmpty()){var a=this._view.getViewTransform().mapRect(this._dragArea);this._view.zoomAll(a,this._zoomMode<0),this._updateMode()}else this._hasDragArea()&&this.invalidateArea(this._dragArea)},b.prototype._mouseRelease=function(a){if(!this._dragArea||this._dragArea&&this._dragArea.isEmpty()){var c=null;switch(this._zoomMode){case-2:c=GSceneWidget.options.minZoomFactor;break;case-1:c=this._view.getZoom()/b.options.zoomStep;break;case 1:c=this._view.getZoom()*b.options.zoomStep;break;case 2:c=GSceneWidget.options.maxZoomFactor}if(null!=c){var d=this._view.getViewTransform().mapPoint(a.client);this._view.zoomAt(d,c),this._updateMode()}}this._dragArea=null},b.prototype._modifiersChanged=function(){this._updateMode()},b.prototype._updateMode=function(){var a=0;ifPlatform.modifiers.optionKey?(a=-1,ifPlatform.modifiers.shiftKey&&(a=-2)):(a=1,ifPlatform.modifiers.shiftKey&&(a=2)),0>a&&this._view.getZoom()<=GSceneWidget.options.minZoomFactor?a=0:a>0&&this._view.getZoom()>=GSceneWidget.options.maxZoomFactor&&(a=0),a!=this._zoomMode&&(this._zoomMode=a,this.updateCursor())},b.prototype._hasDragArea=function(){return this._dragArea&&(this._dragArea.getHeight()>0||this._dragArea.getWidth()>0)},b.prototype.toString=function(){return"[Object GZoomTool]"},a.GZoomTool=b}(this),function(a){function b(){GTool.call(this)}GObject.inherit(b,GTool),b.prototype._pathRef=null,b.prototype._dpathRef=null,b.prototype._newPoint=null,b.prototype._editPt=null,b.prototype._refPt=null,b.prototype._pathEditor=null,b.prototype._compoundPathEditor=null,b.prototype._released=!0,b.prototype._dragStarted=!1,b.prototype._dragStartPt=null,b.prototype._firstAlt=!1,b.Transaction={NoTransaction:0,InsertPoint:1,AppendPoint:2,MovePoint:3,DeletePoint:4,ModifyPointProperties:5,ModifyPathProperties:6,InsertElement:7},b.prototype._transactionType=b.Transaction.NoTransaction,b.Mode={Append:0,Prepend:1,Edit:2},b.prototype._mode=b.Mode.Append,b.prototype._mDownTime=0,b.DBLCLICKTM=300,b.prototype._cursor=null,b.prototype._lastMouseEvent=null,b.prototype._deactivationAllowed=!0,b.prototype.getCursor=function(){return this._cursor
},b.prototype.catchesContextMenu=function(){return!0},b.prototype.activate=function(a){GTool.prototype.activate.call(this,a),a.addEventListener(GMouseEvent.Down,this._mouseDown,this),a.addEventListener(GMouseEvent.Release,this._mouseRelease,this),a.addEventListener(GKeyEvent.Down,this._keyDown,this),ifPlatform.addEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged,this),this._cursor=GCursor.PenStart,this._transactionType=b.Transaction.NoTransaction,this._initialSelectCorrection()},b.prototype.deactivate=function(a){(this._newPoint||this._dpathRef)&&(this._pathEditor.requestInvalidation(),this._pathEditor.releasePathPreview(),this._pathEditor.requestInvalidation()),this._finishTransaction(),this._allowDeactivation(),this._reset(),GTool.prototype.deactivate.call(this,a),a.removeEventListener(GMouseEvent.Down,this._mouseDown),a.removeEventListener(GMouseEvent.Release,this._mouseRelease),a.removeEventListener(GKeyEvent.Down,this._keyDown),ifPlatform.removeEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged)},b.prototype.isDeactivatable=function(){return this._deactivationAllowed},b.prototype._allowDeactivation=function(){this._deactivationAllowed=!0},b.prototype._blockDeactivation=function(){this._deactivationAllowed=!1},b.prototype._checkPathEditor=function(){var a=this._editor.getPathSelection();a&&(this._pathEditor=GElementEditor.openEditor(a),this._pathEditor.setFlag(GElementEditor.Flag.Detail),this._compoundPathEditor=this._pathEditor instanceof GCompoundPathEditor?this._pathEditor:null)},b.prototype._checkMode=function(){if(this._checkPathEditor(),this._pathEditor)if(this._compoundPathEditor)this._mode=b.Mode.Edit;else if(this._pathRef=this._pathEditor.getPath(),this._pathRef.getProperty("closed"))this._mode=b.Mode.Edit;else{var a=this._pathEditor.getPointsSelectionType();a==GPathEditor.PointsSelectionType.No||a==GPathEditor.PointsSelectionType.Several||a==GPathEditor.PointsSelectionType.Middle?this._mode=b.Mode.Edit:a==GPathEditor.PointsSelectionType.Last?this._mode=b.Mode.Append:a==GPathEditor.PointsSelectionType.First&&(this._mode=b.Mode.Prepend)}else this._mode=b.Mode.Append,this._pathRef=null},b.prototype._initialSelectCorrection=function(){if(this._checkPathEditor(),this._pathEditor&&this._pathEditor instanceof GPathEditor)if(this._pathRef=this._pathEditor.getPath(),this._pathRef.getProperty("closed"))this._pathEditor.setActiveExtendingMode(!1);else if(this._pathEditor.isActiveExtendingMode()){var a=this._pathEditor.getPointsSelectionType();a!=GPathEditor.PointsSelectionType.Last&&a!=GPathEditor.PointsSelectionType.First&&this._pathEditor.selectOnePoint(this._pathRef.getAnchorPoints().getLastChild()),this._cursor=GCursor.Pen}},b.prototype._renewPreviewLink=function(){this._dpathRef=this._pathEditor?this._pathEditor.getPathPreview():null},b.prototype._updatePoint=function(a){var c=null;return this._pathRef&&this._editPt&&(c=this._mode!=b.Mode.Edit?this._constrainIfNeeded(a,this._view.getWorldTransform(),this._pathRef):this._constrainIfNeeded(a,this._view.getWorldTransform(),this._pathRef,this._dpathRef.getAnchorPoints().getPreviousPoint(this._editPt)),this._editor.getGuides().beginMap(),c=this._view.getWorldTransform().mapPoint(this._editor.getGuides().mapPoint(this._view.getViewTransform().mapPoint(c))),this._editor.getGuides().finishMap(),this._pathEditor.movePoint(this._editPt,c,this._view.getWorldTransform(),this._dragStartPt)),c},b.prototype._addPoint=function(a,c,d,e){if(e||a.setFlag(GNode.Flag.Selected),this._pathEditor&&!d){var f=this._pathRef.getTransform();if(f){var g=new GPoint(a.getProperty("x"),a.getProperty("y"));g=f.inverted().mapPoint(g),a.setProperties(["x","y"],[g.getX(),g.getY()])}}c?this._pathEditor?(this._pathEditor.requestInvalidation(),this._mode==b.Mode.Append?(e||this._dpathRef.getAnchorPoints().getLastChild().removeFlag(GNode.Flag.Selected),this._dpathRef.getAnchorPoints().appendChild(a),this._editPt=this._dpathRef.getAnchorPoints().getLastChild(),this._newPoint=!0,this._pathEditor.setActiveExtendingMode(!0)):this._mode==b.Mode.Prepend&&(e||this._dpathRef.getAnchorPoints().getFirstChild().removeFlag(GNode.Flag.Selected),this._dpathRef.getAnchorPoints().insertChild(a,this._dpathRef.getAnchorPoints().getFirstChild()),this._pathEditor.shiftPreviewTable(1),this._editPt=this._dpathRef.getAnchorPoints().getFirstChild(),this._newPoint=!0,this._pathEditor.setActiveExtendingMode(!0)),this._pathEditor.requestInvalidation()):(this._startTransaction(b.Transaction.InsertElement),this._createAndAppendPath(a),this._pathEditor.selectOnePoint(a),this._checkMode(),this._renewPreviewLink(),this._editPt=this._dpathRef.getAnchorPoints().getLastChild(),this._pathEditor.requestInvalidation(),this._pathEditor.setActiveExtendingMode(!0)):this._pathEditor?(this._pathEditor.requestInvalidation(),this._mode==b.Mode.Append?(this._pathEditor.releasePathPreview(),this._pathEditor.requestInvalidation(),this._startTransaction(b.Transaction.AppendPoint),this._pathRef.getAnchorPoints().appendChild(a),this._pathEditor.selectOnePoint(a),this._pathEditor.setActiveExtendingMode(!0)):this._mode==b.Mode.Prepend&&(this._pathEditor.releasePathPreview(),this._pathEditor.requestInvalidation(),this._startTransaction(b.Transaction.AppendPoint),this._pathRef.getAnchorPoints().insertChild(a,this._pathRef.getAnchorPoints().getFirstChild()),this._pathEditor.selectOnePoint(a),this._pathEditor.setActiveExtendingMode(!0)),this._pathEditor.requestInvalidation()):(this._startTransaction(b.Transaction.InsertElement),this._createAndAppendPath(a),this._pathEditor.selectOnePoint(a),this._checkMode(),this._renewPreviewLink(),this._pathEditor.requestInvalidation(),this._pathEditor.setActiveExtendingMode(!0))},b.prototype._commitChanges=function(){this._pathEditor.requestInvalidation(),this._pathEditor.releasePathPreview(),this._pathEditor.requestInvalidation(),this._reset()},b.prototype._createAndAppendPath=function(a){var b=new GPath;b.getAnchorPoints().appendChild(a),a.setFlag(GNode.Flag.Selected),b.setFlag(GNode.Flag.Selected),this._editor.insertElements([b],!1,!0),this._checkPathEditor()},b.prototype._mouseDown=function(){this._released=!1},b.prototype._mouseDblClick=function(a){this._lastMouseEvent=null,this._checkMode(),this._pathEditor&&(this._pathEditor.updatePartSelection(!1),this._pathEditor instanceof GPathEditor&&this._pathEditor.setActiveExtendingMode(!1),this._commitChanges()),this._mode=b.Mode.Edit,this._setCursorForPosition(null,a.client)},b.prototype._mouseRelease=function(){this._released=!0,this._dragStarted=!1,this._dragStartPt=null},b.prototype._reset=function(){this._compoundPathEditor?this._compoundPathEditor.removeFlag(GElementEditor.Flag.Detail):this._pathEditor&&this._pathEditor.removeFlag(GElementEditor.Flag.Detail),this._dpathRef=null,this._pathRef=null,this._pathEditor=null,this._newPoint=!1,this._editPt=null,this._dragStartPt=null,this._refPt=null,this._compoundPathEditor=null},b.prototype._keyDown=function(a){a.key===GKey.Constant.TAB&&(this._lastMouseEvent=null,this._tabAction())},b.prototype._modifiersChanged=function(a){a.changed.shiftKey&&this._lastMouseEvent&&(this._released?this._mouseMove(this._lastMouseEvent):this._mouseDrag(this._lastMouseEvent)),a.changed.optionKey&&(this._firstAlt=!1,this._released||(ifPlatform.modifiers.optionKey&&(this._firstAlt=!this._dragStarted),this._mouseDrag(this._lastMouseEvent)))},b.prototype._tabAction=function(){this._released&&(this._checkMode(),this._pathEditor&&(this._pathEditor.updatePartSelection(!1),this._pathEditor instanceof GPathEditor&&(this._pathEditor.setActiveExtendingMode(!1),this._pathRef.removeFlag(GNode.Flag.Selected)),this._commitChanges()),this._setCursorForPosition(GCursor.PenStart))},b.prototype._constrainIfNeeded=function(a,c,d,e){var f=a;if(ifPlatform.modifiers.shiftKey){var g=null;e?g=e:d&&(this._mode==b.Mode.Append?g=d.getAnchorPoints().getLastChild():this._mode==b.Mode.Prepend&&(g=d.getAnchorPoints().getFirstChild())),g&&(f=this._pathEditor.constrainPosition(a,c,g))}return f},b.prototype._makePointMajor=function(a){this._compoundPathEditor&&(this._compoundPathEditor.updatePartSelection(!1),this._compoundPathEditor.releasePathPreview(),this._compoundPathEditor.requestInvalidation()),this._pathEditor.selectOnePoint(a),this._dpathRef=null,this._pathEditor.releasePathPreview(),this._pathEditor.requestInvalidation(),this._dpathRef=this._pathEditor.getPathPreview(!1,a)},b.prototype._startTransaction=function(a){this._transactionType==b.Transaction.NoTransaction&&this._editor.beginTransaction(),this._transactionType=a},b.prototype._finishTransaction=function(){try{switch(this._transactionType){case b.Transaction.AppendPoint:this._editor.commitTransaction("Append Point");break;case b.Transaction.InsertElement:this._editor.commitTransaction("Insert Element(s)");break;case b.Transaction.InsertPoint:this._editor.commitTransaction("Insert Point");break;case b.Transaction.MovePoint:this._editor.commitTransaction("Move Point");break;case b.Transaction.DeletePoint:this._editor.commitTransaction("Delete Point");break;case b.Transaction.ModifyPointProperties:this._editor.commitTransaction("Modify Point Properties");break;case b.Transaction.ModifyPathProperties:this._editor.commitTransaction("Modify Path Properties")}}finally{this._transactionType=b.Transaction.NoTransaction}},b.prototype._mouseDownOnEdit=function(a,c){var d=a.client;this._pathEditor.requestInvalidation(),this._pathEditor.releasePathPreview(),this._pathEditor.requestInvalidation();var e=this._pathEditor.getPartInfoAt(d,this._view.getWorldTransform(),null,this._scene.getProperty("pickDist"));if(e&&(this._pathEditor=e.editor,this._pathRef=this._pathEditor.getPath()),e&&e.id.type==GPathEditor.PartType.Point){var f=e.id.point;this._pathRef.getProperty("closed")||f!==this._pathRef.getAnchorPoints().getLastChild()?this._pathRef.getProperty("closed")||f!==this._pathRef.getAnchorPoints().getFirstChild()?(this._refPt=f,this._setCursorForPosition(null!==this._refPt.getProperty("hlx")&&null!==this._refPt.getProperty("hly")||null!==this._refPt.getProperty("hrx")&&null!==this._refPt.getProperty("hry")?GCursor.PenModify:GCursor.PenMinus)):(this._mode=b.Mode.Prepend,this._makePointMajor(f)):(this._mode=b.Mode.Append,this._makePointMajor(f))}else if(e&&e.id.type==GPathEditor.PartType.Segment&&e.data.type==GPathEditor.SegmentData.HitRes){this._setCursorForPosition(GCursor.PenPlus),this._startTransaction(b.Transaction.InsertPoint);var f=this._pathRef.insertHitPoint(e.data.hitRes);if(f){if(a.button==GMouseEvent.BUTTON_RIGHT&&ifPlatform.modifiers.optionKey){var g=f.getProperty("tp");g==GPathBase.AnchorPoint.Type.Asymmetric&&f.setProperty("tp",GPathBase.AnchorPoint.Type.Connector)}c&&c(f),this._makePointMajor(f),this._refPt=f,this._editPt=this._pathEditor.getPathPointPreview(f),this._pathEditor.requestInvalidation(),this._mode=b.Mode.Edit}else this._finishTransaction(),this._reset(),this._mode=b.Mode.Append}else this._setCursorForPosition(GCursor.PenStart),this._pathEditor.updatePartSelection(!1),this._commitChanges(),this._mode=b.Mode.Append},b.prototype._mouseNoDragReleaseOnEdit=function(a){this._refPt&&(null!=this._refPt.getProperty("hlx")||null!=this._refPt.getProperty("hly")||null!=this._refPt.getProperty("hrx")||null!=this._refPt.getProperty("hry")?(this._transactionType==b.Transaction.NoTransaction&&this._startTransaction(b.Transaction.ModifyPointProperties),this._refPt.setProperties(["ah","hlx","hly","hrx","hry"],[!1,null,null,null,null]),this._makePointMajor(this._refPt),this._setCursorForPosition(GCursor.PenMinus)):(this._pathRef.getAnchorPoints().getFirstChild()!=this._pathRef.getAnchorPoints().getLastChild()&&(this._transactionType==b.Transaction.NoTransaction?this._startTransaction(b.Transaction.DeletePoint):this._transactionType=b.Transaction.DeletePoint,this._pathRef.getAnchorPoints().removeChild(this._refPt)),this._setCursorForPosition(null,a)),this._refPt=null,this._commitChanges())},b.prototype._setCursorForPosition=function(a,c){if(null!==a)this._cursor=a;else if(c)if(this._pathEditor||this._checkPathEditor(),this._pathEditor){var d=this._pathEditor.getPartInfoAt(c,this._view.getWorldTransform(),null,this._scene.getProperty("pickDist"));if(d&&d.id.type==GPathEditor.PartType.Point){var e=d.id.point,f=d.editor.getPath();this._cursor=f.getProperty("closed")||e!==f.getAnchorPoints().getFirstChild()&&e!==f.getAnchorPoints().getLastChild()?this._mode==b.Mode.Edit?null!==e.getProperty("hlx")&&null!==e.getProperty("hly")||null!==e.getProperty("hrx")&&null!==e.getProperty("hry")?GCursor.PenModify:GCursor.PenMinus:GCursor.Pen:this._mode==b.Mode.Append&&e===f.getAnchorPoints().getFirstChild()||this._mode==b.Mode.Prepend&&e===f.getAnchorPoints().getLastChild()?GCursor.PenEnd:GCursor.Pen}else this._cursor=this._mode==b.Mode.Edit?d&&d.id.type==GPathEditor.PartType.Segment?GCursor.PenPlus:GCursor.PenStart:GCursor.Pen}else this._cursor=GCursor.PenStart;else this._cursor=GCursor.PenStart;this.updateCursor()},b.prototype.toString=function(){return"[Object GPathTool]"},a.GPathTool=b}(this),function(a){function b(){GPathTool.call(this)}GObject.inherit(b,GPathTool),b.prototype.activate=function(a){GPathTool.prototype.activate.call(this,a),a.addEventListener(GMouseEvent.Drag,this._mouseDrag,this),a.addEventListener(GMouseEvent.Move,this._mouseMove,this)},b.prototype.deactivate=function(a){GPathTool.prototype.deactivate.call(this,a),a.removeEventListener(GMouseEvent.Drag,this._mouseDrag),a.removeEventListener(GMouseEvent.Move,this._mouseMove)},b.prototype._mouseDown=function(a){var b=(new Date).getTime();if(b-this._mDownTime<GPathTool.DBLCLICKTM)return void this._mouseDblClick(a);var c=null;if(this._lastMouseEvent=a,this._dragStarted=!1,this._dragStartPt=null,this._mouseMove(a),this._mDownTime=b,this._released=!1,ifPlatform.modifiers.optionKey&&(this._firstAlt=!0),this._blockDeactivation(),this._checkMode(),this._mode==GPathTool.Mode.Edit&&this._mouseDownOnEdit(a),this._mode!=GPathTool.Mode.Edit)if(this._renewPreviewLink(),this._newPoint&&this._pathEditor){if(this._updatePoint(a.client),this._mode==GPathTool.Mode.Append){var d=this._editPt.getPrevious();d&&(d.removeFlag(GNode.Flag.Selected),this._editPt.setFlag(GNode.Flag.Selected))}else{var e=this._editPt.getNext();e&&(e.removeFlag(GNode.Flag.Selected),this._editPt.setFlag(GNode.Flag.Selected))}this._pathEditor.requestInvalidation(),a.button==GMouseEvent.BUTTON_RIGHT?ifPlatform.modifiers.optionKey?this._editPt.setProperty("tp",GPathBase.AnchorPoint.Type.Connector):this._editPt.setProperties(["tp","cu"],[GPathBase.CornerType.Rounded,!0]):ifPlatform.modifiers.optionKey||this._closePreviewIfNeeded(),this._dpathRef.getProperty("closed")&&(this._refPt=this._mode==GPathTool.Mode.Append?this._pathRef.getAnchorPoints().getFirstChild():this._pathRef.getAnchorPoints().getLastChild()),this._pathEditor.requestInvalidation()}else if(this._pathEditor)this._refPt=this._mode==GPathTool.Mode.Append?this._pathRef.getAnchorPoints().getLastChild():this._pathRef.getAnchorPoints().getFirstChild();else{var f=this._view.getViewTransform().mapPoint(a.client);this._editor.getGuides().beginMap(),f=this._editor.getGuides().mapPoint(f),this._editor.getGuides().finishMap(),c=this._constructNewPoint(a,f),a.button==GMouseEvent.BUTTON_RIGHT&&(ifPlatform.modifiers.optionKey?c.setProperty("tp",GPathBase.AnchorPoint.Type.Connector):c.setProperties(["tp","cu"],[GPathBase.CornerType.Rounded,!0])),this._addPoint(c,!0,!1)}this._editor.updateByMousePosition(a.client,this._view.getWorldTransform())},b.prototype._renewPreviewLink=function(){if(this._pathEditor){var a=this._pathEditor.getPathPreview(!0);if(this._editPt){var b;b=this._mode==GPathTool.Mode.Append?a.getAnchorPoints().getLastChild():a.getAnchorPoints().getFirstChild(),this._editPt!=b&&(this._newPoint=!1,this._editPt=null)}this._dpathRef=a}else this._editPt=null,this._newPoint=!1,this._dpathRef=null},b.prototype._closePreviewIfNeeded=function(){if(this._pathRef&&this._newPoint&&(this._mode==GPathTool.Mode.Append||this._mode==GPathTool.Mode.Prepend)){var a,b;this._mode==GPathTool.Mode.Append?(a=this._dpathRef.getAnchorPoints().getLastChild(),b=this._dpathRef.getAnchorPoints().getFirstChild()):(a=this._dpathRef.getAnchorPoints().getFirstChild(),b=this._dpathRef.getAnchorPoints().getLastChild());var c=new GPoint(a.getProperty("x"),a.getProperty("y")),d=this._pathRef.getTransform();if(c=d?d.mapPoint(c):c,b&&this._pathEditor.hitAnchorPoint(b,c,null,this._scene.getProperty("pickDist"))){this._dpathRef=this._pathEditor.getPathPreview(!0),this._editPt=this._mode==GPathTool.Mode.Append?this._dpathRef.getAnchorPoints().getFirstChild():this._dpathRef.getAnchorPoints().getLastChild();var e=this._editPt.getProperty("tp");GPathBase.isCornerType(e)||this._editPt.setProperty("tp",GPathBase.AnchorPoint.Type.Asymmetric),this._editPt.setProperties(["hlx","hly"],[null,null]),this._editPt.setProperty("ah",!1),this._dpathRef.getAnchorPoints().removeChild(a),this._dpathRef.setProperty("closed",!0),this._pathEditor.requestInvalidation(),this._editPt.setFlag(GNode.Flag.Selected),this._pathEditor.requestInvalidation(),this._newPoint=!1}}},b.prototype._mouseMove=function(a){var b=(new Date).getTime();if(!(b-this._mDownTime<GPathTool.DBLCLICKTM)){var c;if(!this._released)return void(a.button==GMouseEvent.BUTTON_RIGHT&&this._mouseDrag(a));if(this._lastMouseEvent=a,this._checkMode(),this._mode==GPathTool.Mode.Edit)this._setCursorForPosition(null,a.client);else{this._renewPreviewLink();var d=a.client;if(!this._newPoint&&this._pathEditor){d=this._constrainIfNeeded(a.client,this._view.getWorldTransform(),this._pathRef);var e=this._view.getViewTransform().mapPoint(d);this._editor.getGuides().beginMap(),e=this._editor.getGuides().mapPoint(e),this._editor.getGuides().finishMap(),d=this._view.getWorldTransform().mapPoint(e),c=this._constructNewPoint(a,e),this._addPoint(c,!0,!1,!0)}else this._editPt&&(this._pathEditor.requestInvalidation(),d=this._updatePoint(a.client),this._pathEditor.requestInvalidation());if(this._editPt){var f;f=this._mode==GPathTool.Mode.Append?this._pathRef.getAnchorPoints().getFirstChild():this._pathRef.getAnchorPoints().getLastChild(),this._setCursorForPosition(this._pathEditor.hitAnchorPoint(f,d,this._view.getWorldTransform(),this._scene.getProperty("pickDist"))?GCursor.PenEnd:GCursor.Pen)}else this._setCursorForPosition(null,a.client)}}},b.prototype._updateHandles=function(a){var b,c,d,e,f=this._editPt.getProperty("tp"),g=this._editPt.getProperty("x"),h=this._editPt.getProperty("y");if(this._pathEditor.hitAnchorPoint(this._editPt,a,this._view.getWorldTransform(),0)&&!this._firstAlt)this._mode!=GPathTool.Mode.Edit?this._mode==GPathTool.Mode.Append?null!==this._editPt.getProperty("hlx")&&null!==this._editPt.getProperty("hly")?this._editPt.setProperties(["tp","hrx","hry"],[GPathBase.AnchorPoint.Type.Symmetric,null,null]):this._editPt.setProperties(["tp","hrx","hry"],[GPathBase.AnchorPoint.Type.Asymmetric,null,null]):null!==this._editPt.getProperty("hrx")&&null!==this._editPt.getProperty("hry")?this._editPt.setProperties(["tp","hlx","hly"],[GPathBase.AnchorPoint.Type.Symmetric,null,null]):this._editPt.setProperties(["tp","hlx","hly"],[GPathBase.AnchorPoint.Type.Asymmetric,null,null]):ifPlatform.modifiers.optionKey?this._editPt.setProperties(["tp","hrx","hry"],[GPathBase.AnchorPoint.Type.Asymmetric,null,null]):this._editPt.setProperties(["tp","hlx","hly","hrx","hry"],[GPathBase.AnchorPoint.Type.Asymmetric,null,null,null,null]);else{var i=this._pathEditor.getTransformFromNative(this._view.getWorldTransform()),j=i.inverted(),k=j.mapPoint(a);if(this._newPoint||!ifPlatform.modifiers.optionKey||!this._firstAlt||f==GPathBase.AnchorPoint.Type.Connector||null==this._editPt.getPrevious()&&null==this._editPt.getNext()){if(f!=GPathBase.AnchorPoint.Type.Connector){this._editPt.setProperty("ah",!1);var l=k.getX(),m=k.getY();if(ifPlatform.modifiers.optionKey)this._mode==GPathTool.Mode.Prepend?this._editPt.setProperties(["tp","hlx","hly"],[GPathBase.AnchorPoint.Type.Asymmetric,l,m]):this._editPt.setProperties(["tp","hrx","hry"],[GPathBase.AnchorPoint.Type.Asymmetric,l,m]);else{var n=GPathBase.AnchorPoint.Type.Symmetric;if(this._mode==GPathTool.Mode.Edit||this._newPoint||this._dpathRef.getProperty("closed")||!(null==this._editPt.getPrevious()&&null!=this._editPt.getNext()||null!=this._editPt.getPrevious()&&null==this._editPt.getNext())){var o=g+g-l,p=h+h-m;this._mode==GPathTool.Mode.Prepend?this._editPt.setProperties(["tp","hrx","hry","hlx","hly"],[n,o,p,l,m]):this._editPt.setProperties(["tp","hrx","hry","hlx","hly"],[n,l,m,o,p])}else this._mode==GPathTool.Mode.Prepend?this._editPt.setProperties(["tp","hlx","hly"],[n,l,m]):this._editPt.setProperties(["tp","hrx","hry"],[n,l,m])}}else if(this._mode==GPathTool.Mode.Append||this._mode==GPathTool.Mode.Edit&&ifPlatform.modifiers.optionKey){b=null,c=null;var q=this._editPt.getPrevious();if(q){var r=q.getProperty("x"),s=q.getProperty("y"),t=Math.sqrt(GMath.ptSqrDist(g,h,r,s));if(GMath.isEqualEps(t,0))d=k.getX(),e=k.getY();else{var u=(g-r)/t,v=(h-s)/t,w=GMath.vDotProduct(u,v,k.getX()-g,k.getY()-h);w>0?(d=g+u*w,e=h+v*w):(d=null,e=null)}}else d=k.getX(),e=k.getY();this._editPt.setProperties(["hlx","hly","hrx","hry"],[b,c,d,e])}else if(this._mode==GPathTool.Mode.Prepend){d=null,e=null;var x=this._editPt.getNext();if(x){var y=x.getProperty("x"),z=x.getProperty("y"),t=Math.sqrt(GMath.ptSqrDist(g,h,y,z));if(GMath.isEqualEps(t,0))b=k.getX(),c=k.getY();else{var u=(g-y)/t,v=(h-z)/t,w=GMath.vDotProduct(u,v,k.getX()-g,k.getY()-h);w>0?(b=g+u*w,c=h+v*w):(b=null,c=null)}}else b=k.getX(),c=k.getY();this._editPt.setProperties(["hlx","hly","hrx","hry"],[b,c,d,e])}}else{var A=k.getX()-g,B=k.getY()-h;this._editPt.setProperty("ah",!1);var C=this._dragStartPt.getProperty("hrx");d=null!=C?C+A:k.getX();var D=this._dragStartPt.getProperty("hry");e=null!=D?D+B:k.getY(),this._editPt.setProperty("ah",!1),this._editPt.setProperties(["tp","hrx","hry"],[GPathBase.AnchorPoint.Type.Asymmetric,d,e])}}this._pathEditor.requestInvalidation()},b.prototype._mouseDrag=function(a){!this._refPt||this._editPt||this._released||(this._makePointMajor(this._refPt),this._editPt=this._pathEditor.getPathPointPreview(this._refPt),this._dragStartPt=this._refPt,a.button==GMouseEvent.BUTTON_LEFT&&this._editPt.setProperty("tp",GPathBase.AnchorPoint.Type.Symmetric),this._pathEditor.requestInvalidation()),!this._released&&this._editPt&&(this._lastMouseEvent=a,this._setCursorForPosition(GCursor.PenDrag),this._dragStartPt||(this._dragStartPt=this._refPt?this._refPt:this._editPt,a.button==GMouseEvent.BUTTON_LEFT&&this._editPt.getProperty("tp")!=GPathBase.AnchorPoint.Type.Connector&&this._editPt.setProperty("tp",GPathBase.AnchorPoint.Type.Symmetric)),this._dragStarted=!0,this._updatePointProperties(a.client))},b.prototype._constructNewPoint=function(a,b){var c=new GPath.AnchorPoint;return c.setProperties(["x","y"],[b.getX(),b.getY()]),c},b.prototype._mouseRelease=function(a){if(!this._released)try{if(this._editor.updateByMousePosition(a.client,this._view.getWorldTransform()),this._released=!0,this._pathEditor&&this._mode==GPathTool.Mode.Edit)this._dragStarted||!this._refPt||this._editPt?this._dragStarted?(this._updatePointProperties(a.client),this._transactionType==GPathTool.Transaction.NoTransaction&&this._startTransaction(GPathTool.Transaction.ModifyPointProperties),this._pathEditor.applyTransform(this._pathRef),this._commitChanges(),this._setCursorForPosition(null,a.client)):(this._commitChanges(),this._setCursorForPosition(null,a.client)):this._mouseNoDragReleaseOnEdit(a.client);else if(this._dpathRef){var b=a.client;if(this._dragStarted&&(b=this._updatePointProperties(a.client)),this._dpathRef.getProperty("closed"))this._refPt&&(this._startTransaction(GPathTool.Transaction.ModifyPathProperties),this._pathEditor.selectOnePoint(this._refPt),this._pathEditor.applyTransform(this._pathRef),this._pathEditor.requestInvalidation(),this._pathRef.setProperty("closed",!0),this._pathEditor.setActiveExtendingMode(!1)),this._commitChanges(),this._mode=GPathTool.Mode.Edit,this._setCursorForPosition(null,a.client);else{this._newPoint&&(this._addPoint(this._editPt,!1,!0),this._pathEditor.requestInvalidation());var c;this._mode==GPathTool.Mode.Append?(this._refPt=this._pathRef.getAnchorPoints().getLastChild(),c=this._pathRef.getAnchorPoints().getFirstChild()):(this._refPt=this._pathRef.getAnchorPoints().getFirstChild(),c=this._pathRef.getAnchorPoints().getLastChild()),this._newPoint||(this._transactionType==GPathTool.Transaction.NoTransaction&&this._startTransaction(GPathTool.Transaction.ModifyPointProperties),this._pathEditor.selectOnePoint(this._refPt),this._pathEditor.applyTransform(this._pathRef)),this._setCursorForPosition(c&&c!=this._refPt&&this._pathEditor.hitAnchorPoint(c,b,this._view.getWorldTransform(),this._scene.getProperty("pickDist"))?GCursor.PenEnd:GCursor.Pen),this._commitChanges()}this._refPt=null}}finally{this._finishTransaction()}this._dragStarted=!1,this._dragStartPt=null,this._lastMouseEvent=null,this._firstAlt=!1,this._allowDeactivation()},b.prototype._updateShoulders=function(a){if((this._mode==GPathTool.Mode.Append||this._mode==GPathTool.Mode.Prepend)&&this._editPt)if(this._pathEditor.hitAnchorPoint(this._editPt,a,this._view.getWorldTransform(),0))this._mode==GPathTool.Mode.Append?this._editPt.setProperty("cr",null):this._mode==GPathTool.Mode.Prepend&&this._editPt.setProperty("cl",null);else{var b=this._pathEditor.getTransformFromNative(this._view.getWorldTransform()),c=new GPoint(this._editPt.getProperty("x"),this._editPt.getProperty("y"));c=b.mapPoint(c);var d=GMath.ptDist(c.getX(),c.getY(),a.getX(),a.getY());this._mode==GPathTool.Mode.Append?this._editPt.setProperty("cr",d):this._mode==GPathTool.Mode.Prepend&&this._editPt.setProperty("cl",d)}},b.prototype._updatePointProperties=function(a){var b=a;if(this._pathEditor.requestInvalidation(),this._editPt.getProperty("tp")==GPathBase.CornerType.Rounded)this._updateShoulders(a);else{var b=this._constrainIfNeeded(a,this._view.getWorldTransform(),this._pathRef,this._dragStartPt);this._updateHandles(b)}return b},b.prototype.toString=function(){return"[Object GPenTool]"},a.GPenTool=b}(this),function(a){function b(){GPathTool.call(this)}GObject.inherit(b,GPathTool),b.prototype.activate=function(a){GPathTool.prototype.activate.call(this,a),a.addEventListener(GMouseEvent.Drag,this._mouseDrag,this),a.addEventListener(GMouseEvent.Move,this._mouseMove,this),this._checkMode()},b.prototype.deactivate=function(a){GPathTool.prototype.deactivate.call(this,a),a.removeEventListener(GMouseEvent.Drag,this._mouseDrag),a.removeEventListener(GMouseEvent.Move,this._mouseMove)},b.prototype._mouseDown=function(a){var b=(new Date).getTime();if(b-this._mDownTime<GPathTool.DBLCLICKTM)return void this._mouseDblClick(a);this._mDownTime=b,this._lastMouseEvent=a;var c,d=null;if(this._editor.updateByMousePosition(a.client,this._view.getWorldTransform()),this._dragStarted=!1,this._dragStartPt=null,this._newPoint=null,this._editPt=null,a.button==GMouseEvent.BUTTON_LEFT||a.button==GMouseEvent.BUTTON_RIGHT&&ifPlatform.modifiers.optionKey){if(this._released=!1,this._blockDeactivation(),this._checkMode(),this._mode==GPathTool.Mode.Edit){var e=function(a){ifPlatform.modifiers.optionKey&&a.getProperty("tp")!=GPathBase.AnchorPoint.Type.Connector&&a.setProperty("tp",GPathBase.AnchorPoint.Type.Symmetric)};this._mouseDownOnEdit(a,e)}if(this._mode!=GPathTool.Mode.Edit){this._renewPreviewLink(),c=this._constrainIfNeeded(a.client,this._view.getWorldTransform(),this._pathRef);var f;if(this._pathEditor&&(f=this._mode==GPathTool.Mode.Append?this._pathRef.getAnchorPoints().getFirstChild():this._pathRef.getAnchorPoints().getLastChild()),f&&this._pathEditor.hitAnchorPoint(f,c,this._view.getWorldTransform(),this._scene.getProperty("pickDist")))this._setCursorForPosition(GCursor.PenEnd),this._startTransaction(GPathTool.Transaction.ModifyPathProperties),this._pathRef.setProperty("closed",!0),this._makePointMajor(f),this._pathEditor.setActiveExtendingMode(!1),this._mode=GPathTool.Mode.Edit,this._editPt=this._pathEditor.getPathPointPreview(f),this._pathEditor.requestInvalidation();else{this._setCursorForPosition(GCursor.Pen);var g;if(this._pathEditor&&(g=this._mode==GPathTool.Mode.Append?this._pathRef.getAnchorPoints().getLastChild():this._pathRef.getAnchorPoints().getFirstChild()),g&&this._pathEditor.hitAnchorPoint(g,c,this._view.getWorldTransform(),this._scene.getProperty("pickDist")))this._makePointMajor(g),this._editPt=this._pathEditor.getPathPointPreview(g),this._pathEditor.requestInvalidation();else{var h=this._view.getViewTransform().mapPoint(c);this._editor.getGuides().beginMap(),h=this._editor.getGuides().mapPoint(h),this._editor.getGuides().finishMap(),d=this._constructNewPoint(a,h),this._addPoint(d,!0,!1)}}}}},b.prototype._mouseMove=function(a){return this._released?(this._lastMouseEvent=a,void this._setCursorForPosition(null,a.client)):void(a.button==GMouseEvent.BUTTON_RIGHT&&ifPlatform.modifiers.optionKey&&this._mouseDrag(a))},b.prototype._mouseDrag=function(a){if(this._refPt&&!this._released&&(this._makePointMajor(this._refPt),this._editPt=this._pathEditor.getPathPointPreview(this._refPt),this._dragStartPt=this._refPt,this._pathEditor.requestInvalidation(),this._refPt=null),this._editPt&&!this._released){this._lastMouseEvent=a,this._dragStarted=!0,this._pathEditor.requestInvalidation();var b,c=this._updatePoint(a.client);this._newPoint||this._pathRef.getAnchorPoints().getFirstChild()!=this._pathRef.getAnchorPoints().getLastChild()?(this._editPt==this._dpathRef.getAnchorPoints().getLastChild()?b=this._pathRef.getAnchorPoints().getFirstChild():this._editPt==this._dpathRef.getAnchorPoints().getFirstChild()&&(b=this._pathRef.getAnchorPoints().getLastChild()),this._setCursorForPosition(b&&this._pathEditor.hitAnchorPoint(b,c,this._view.getWorldTransform(),this._scene.getProperty("pickDist"))?GCursor.PenEnd:GCursor.Pen)):this._setCursorForPosition(GCursor.Pen),this._pathEditor.requestInvalidation()}},b.prototype._constructNewPoint=function(a,b){var c=new GPath.AnchorPoint;return c.setProperties(["x","y","ah"],[b.getX(),b.getY(),!0]),a.button==GMouseEvent.BUTTON_LEFT?ifPlatform.modifiers.optionKey?c.setProperty("tp",GPathBase.AnchorPoint.Type.Symmetric):c.setProperty("tp",GPathBase.AnchorPoint.Type.Asymmetric):c.setProperty("tp",GPathBase.AnchorPoint.Type.Connector),c},b.prototype._closeIfNeeded=function(){if(this._pathRef&&(this._newPoint||this._pathRef.getAnchorPoints().getFirstChild()!=this._pathRef.getAnchorPoints().getLastChild())&&(this._mode==GPathTool.Mode.Append||this._mode==GPathTool.Mode.Prepend)){var a,b;this._mode==GPathTool.Mode.Append?(a=this._dpathRef.getAnchorPoints().getLastChild(),b=this._pathRef.getAnchorPoints().getFirstChild()):(a=this._dpathRef.getAnchorPoints().getFirstChild(),b=this._pathRef.getAnchorPoints().getLastChild());var c=new GPoint(a.getProperty("x"),a.getProperty("y")),d=this._pathRef.getTransform();c=d?d.mapPoint(c):c,b&&this._pathEditor.hitAnchorPoint(b,c,null,this._scene.getProperty("pickDist"))&&(this._transactionType==GPathTool.Transaction.NoTransaction?this._startTransaction(GPathTool.Transaction.ModifyPathProperties):this._transactionType=GPathTool.Transaction.ModifyPathProperties,this._pathRef.beginUpdate(),this._pathEditor.selectOnePoint(b),ifPlatform.modifiers.optionKey&&b.setProperties(["ah","tp"],[!1,GPathBase.AnchorPoint.Type.Asymmetric]),b.getProperty("ah")||b.setProperties(["hlx","hly"],[a.getProperty("hlx"),a.getProperty("hly")]),this._dpathRef.getAnchorPoints().removeChild(a),this._newPoint||(a=this._mode==GPathTool.Mode.Append?this._pathRef.getAnchorPoints().getLastChild():this._pathRef.getAnchorPoints().getFirstChild(),this._pathRef.getAnchorPoints().removeChild(a)),this._dpathRef.setProperty("closed",!0),this._pathRef.setProperty("closed",!0),this._pathRef.endUpdate(),this._pathEditor.requestInvalidation(),this._pathEditor.setActiveExtendingMode(!1),this._newPoint=!1)}},b.prototype._mouseRelease=function(a){if(!this._released)try{if(this._released=!0,this._mode==GPathTool.Mode.Append||this._mode==GPathTool.Mode.Prepend){var b=this._updatePoint(a.client);
this._closeIfNeeded(),this._pathRef.getProperty("closed")?(this._setCursorForPosition(GCursor.PenMinus),this._mode=GPathTool.Mode.Edit):this._newPoint?(this._addPoint(this._editPt,!1,!0),this._setCursorForPosition(GCursor.Pen)):this._editPt&&(this._transactionType==GPathTool.Transaction.NoTransaction&&this._startTransaction(GPathTool.Transaction.MovePoint),this._pathEditor.applyTransform(this._pathRef),this._setCursorForPosition(GCursor.PenEnd)),this._commitChanges()}else if(this._mode==GPathTool.Mode.Edit&&(this._editPt||this._refPt))if(this._dragStarted&&this._editPt){var b=this._updatePoint(a.client);this._transactionType==GPathTool.Transaction.NoTransaction&&this._startTransaction(GPathTool.Transaction.MovePoint),this._pathEditor.applyTransform(this._pathRef),this._setCursorForPosition(null,b),this._commitChanges()}else this._editPt?this._commitChanges():this._mouseNoDragReleaseOnEdit(a.client);this._dragStarted=!1,this._dragStartPt=null}finally{this._finishTransaction()}this._lastMouseEvent=null,this._allowDeactivation()},b.prototype.toString=function(){return"[Object GBezigonTool]"},a.GBezigonTool=b}(this),function(a){function b(){GShapeTool.call(this,!0,!0)}GObject.inherit(b,GShapeTool),b.prototype._createShape=function(){var a=new GPath;return a.getAnchorPoints().appendChild(new GPathBase.AnchorPoint),a.getAnchorPoints().appendChild(new GPathBase.AnchorPoint),a},b.prototype._updateShape=function(a,b,c){a.getAnchorPoints().getChildByIndex(0).setProperties(["x","y"],[c[0].getX(),c[0].getY()]),a.getAnchorPoints().getChildByIndex(1).setProperties(["x","y"],[c[1].getX(),c[1].getY()])},b.prototype.toString=function(){return"[Object GLineTool]"},a.GLineTool=b}(this),function(a){function b(){GShapeTool.call(this,!0,!0)}GObject.inherit(b,GShapeTool),b.prototype._createShape=function(){return new GRectangle},b.prototype._updateShape=function(a,b){a.setProperty("trf",new GTransform(b.getWidth()/2,0,0,b.getHeight()/2,b.getX()+b.getWidth()/2,b.getY()+b.getHeight()/2))},b.prototype._hasCenterCross=function(){return!0},b.prototype.toString=function(){return"[Object GRectangleTool]"},a.GRectangleTool=b}(this),function(a){function b(){GShapeTool.call(this,!0,!0)}GObject.inherit(b,GShapeTool),b.prototype._createShape=function(){return new GEllipse},b.prototype._updateShape=function(a,b){a.setProperty("trf",new GTransform(b.getWidth()/2,0,0,b.getHeight()/2,b.getX()+b.getWidth()/2,b.getY()+b.getHeight()/2))},b.prototype._hasCenterCross=function(){return!0},b.prototype.toString=function(){return"[Object GEllipseTool]"},a.GEllipseTool=b}(this),function(a){function b(){GShapeTool.call(this,!1,!1)}GObject.inherit(b,GShapeTool),b.prototype._numberOfPoints=6,b.prototype._innerRadiusFactor=.5,b.prototype._modifiersChanged=function(a){(a.changed.shiftKey||a.changed.optionKey)&&this._invalidateShape(),GShapeTool.prototype._modifiersChanged.call(this,a)},b.prototype._createShape=function(){return new GPolygon},b.prototype._updateShape=function(a,b,c){var d=c[1].getX()-c[0].getX(),e=c[1].getY()-c[0].getY(),f=GMath.normalizeAngleRadians(Math.atan2(e,d)),g=GMath.ptDist(c[1].getX(),c[1].getY(),c[0].getX(),c[0].getY());ifPlatform.modifiers.shiftKey&&(f=Math.round(12*f/Math.PI)*Math.PI/12);var h=f,i=GMath.normalizeAngleRadians(f+Math.PI/this._numberOfPoints),j=g,k=g*Math.cos(Math.PI/this._numberOfPoints);ifPlatform.modifiers.optionKey&&(k=g*this._innerRadiusFactor),a.setProperties(["pts","cx","cy","ir","or","ia","oa"],[this._numberOfPoints,c[0].getX(),c[0].getY(),k,j,i,h])},b.prototype._hasCenterCross=function(){return!0},b.prototype.toString=function(){return"[Object GPolygonTool]"},a.GPolygonTool=b}(this),function(a){function b(){GShapeTool.call(this,!0,!0)}GObject.inherit(b,GShapeTool),b.prototype._textUnderMouse=null,b.prototype.getCursor=function(){return this._textUnderMouse?GCursor.SelectDot:this._shape?GShapeTool.prototype.getCursor.call(this):GCursor.Text},b.prototype._mouseRelease=function(a){if(this._textUnderMouse){var b=this._editor,c=this._view;this._manager.activateTool(GPointerTool),b.openInlineEditor(this._textUnderMouse,c,a.client)}else GShapeTool.prototype._mouseRelease.call(this,a)},b.prototype._mouseMove=function(a){if(GShapeTool.prototype._mouseMove.call(this,a),this._textUnderMouse&&(this._textUnderMouse=null,this.updateCursor()),!this._shape){var b=this._scene.hitTest(a.client,this._view.getWorldTransform(),null,!1,-1,this._scene.getProperty("pickDist"));b&&b.length&&b[0].element instanceof GText&&(this._textUnderMouse=b[0].element,this.updateCursor())}},b.prototype._createShape=function(){return new GRectangle},b.prototype._updateShape=function(a,b,c,d){d?a.setProperty("trf",new GTransform(b.getWidth(),0,0,b.getHeight(),b.getX(),b.getY())):a.setProperty("trf",new GTransform(b.getWidth()/2,0,0,b.getHeight()/2,b.getX()+b.getWidth()/2,b.getY()+b.getHeight()/2))},b.prototype._insertShape=function(a){var b=new GText;b.setProperties(["aw","ah","trf"],[!1,!1,a.getProperty("trf")]),b.useTextBoxAsBase(),this._insertText(b)},b.prototype._hasCenterCross=function(){return!0},b.prototype._createShapeManually=function(a){var b=new GText;b.setProperty("trf",new GTransform(1,0,0,1,a.getX(),a.getY())),this._insertText(b)},b.prototype._insertText=function(a){GShapeTool.prototype._insertShape.call(this,a);var b=this._editor,c=this._view;this._manager.activateTool(GPointerTool),b.openInlineEditor(a,c)},b.prototype.toString=function(){return"[Object GTextTool]"},a.GTextTool=b}(this),function(a){function b(){GSelectTool.call(this)}GObject.inherit(b,GSelectTool),b.prototype.toString=function(){return"[Object GPointerTool]"},a.GPointerTool=b}(this),function(a){function b(){GSelectTool.call(this)}GObject.inherit(b,GSelectTool),b.prototype.activate=function(a){GSelectTool.prototype.activate.call(this,a),this._editor.storeSelection();var b=this._scene.getActivePage();b?this._editor.updateSelection(!1,[b]):this._editor.clearSelection()},b.prototype.deactivate=function(a){this._editor.restoreSelection(),GSelectTool.prototype.deactivate.call(this,a)},b.prototype._selectFilter=function(a){return a instanceof GLayer?!1:!0},b.prototype._getSelectableElement=function(a){for(var b=a;null!==b;b=b.getParent())if(b instanceof GPage)return b;return null},b.prototype.toString=function(){return"[Object GPageTool]"},a.GPageTool=b}(this),function(a){function b(){GSelectTool.call(this)}GObject.inherit(b,GSelectTool),b.prototype.activate=function(a){GSelectTool.prototype.activate.call(this,a);var b=a.getEditor().getSelection();b&&0!==b.length?this._openTransformBox():this._manager.activateTool(GPointerTool)},b.prototype._mouseDblClick=function(){},b.prototype.toString=function(){return"[Object GTransformTool]"},a.GTransformTool=b}(this),function(a){function b(){GTool.call(this)}GObject.inherit(b,GTool),b.prototype._dragStart=null,b.prototype._dragCurrent=null,b.prototype._slice=null,b.prototype._dragArea=null,b.prototype._hasCreatedSlice=!1,b.prototype.getCursor=function(){return GCursor.Cross},b.prototype.activate=function(a){GTool.prototype.activate.call(this,a),a.addEventListener(GMouseEvent.DragStart,this._mouseDragStart,this),a.addEventListener(GMouseEvent.Drag,this._mouseDrag,this),a.addEventListener(GMouseEvent.DragEnd,this._mouseDragEnd,this),a.addEventListener(GMouseEvent.Down,this._mouseDown,this),a.addEventListener(GMouseEvent.Release,this._mouseRelease,this),ifPlatform.addEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged,this)},b.prototype.deactivate=function(a){GTool.prototype.deactivate.call(this,a),a.removeEventListener(GMouseEvent.DragStart,this._mouseDragStart),a.removeEventListener(GMouseEvent.Drag,this._mouseDrag),a.removeEventListener(GMouseEvent.DragEnd,this._mouseDragEnd),a.removeEventListener(GMouseEvent.Down,this._mouseDown),a.removeEventListener(GMouseEvent.Release,this._mouseRelease),ifPlatform.removeEventListener(GPlatform.ModifiersChangedEvent,this._modifiersChanged)},b.prototype.isDeactivatable=function(){return this._dragStart?!1:!0},b.prototype.paint=function(a){if(this._slice){var b=this._slice.getGeometryBBox();b=this._view.getWorldTransform().mapRect(b);var c=Math.floor(b.getX())+.5,d=Math.floor(b.getY())+.5;a.canvas.strokeRect(c,d,b.getWidth(),b.getHeight(),1,a.selectionOutlineColor)}},b.prototype._mouseDown=function(a){a.button===GMouseEvent.BUTTON_LEFT&&this._editor.updateByMousePosition(a.client,this._view.getWorldTransform())},b.prototype._mouseRelease=function(a){if(!this._hasCreatedSlice){var b=this._view.getViewTransform().mapPoint(a.client);b=this._editor.getGuides().mapPoint(b)}this._hasCreatedSlice=!1},b.prototype._mouseDragStart=function(a){this._hasCreatedSlice=!1,this._dragStart=this._view.getViewTransform().mapPoint(a.client),this._editor.getGuides().beginMap(),this._dragStart=this._editor.getGuides().mapPoint(this._dragStart),this._editor.getGuides().finishMap(),this._slice=new GSlice,this._invalidateSlice(),this.updateCursor()},b.prototype._mouseDrag=function(a){this._dragCurrent=this._view.getViewTransform().mapPoint(a.client),this._invalidateSlice()},b.prototype._mouseDragEnd=function(){var a=this._slice;this._slice=null,this._invalidateSliceArea(a),this._updateSlice(a,this._dragArea),this._dragStart=null,this._dragCurrent=null,this._slice=null,this._dragArea=null,this.updateCursor(),this._editor.insertElements([a]),this._hasCreatedSlice=!0},b.prototype._modifiersChanged=function(a){(a.changed.shiftKey||a.changed.optionKey||a.changed.metaKey)&&this._invalidateSlice()},b.prototype._invalidateSlice=function(){if(this._dragStart&&this._dragCurrent){this._editor.getGuides().beginMap();var a=this._editor.getGuides().mapPoint(this._dragCurrent);if(this._editor.getGuides().finishMap(),GPoint.equals(this._dragStart,a))this._invalidateSliceArea();else{var b=this._dragStart.getX(),c=this._dragStart.getY(),d=a.getX(),e=a.getY();if(ifPlatform.modifiers.shiftKey){var f=Math.abs(d-b),g=Math.abs(e-c),h=b>d?-1:1,i=c>e?-1:1;f>=g?(d=b+f*h,e=c+f*i):(d=b+g*h,e=c+g*i)}var j=null;j=ifPlatform.modifiers.optionKey?GRect.fromPoints(new GPoint(b-(d-b),c-(e-c)),new GPoint(b+(d-b),c+(e-c))):GRect.fromPoints(new GPoint(b,c),new GPoint(d,e)),this._dragArea=j,this._invalidateSliceArea(),this._updateSlice(this._slice,j),this._invalidateSliceArea()}}},b.prototype._invalidateSliceArea=function(a){if(a=a||this._slice){var b=this._view.getWorldTransform().mapRect(a.getGeometryBBox());b&&(b.getWidth()>0||b.getHeight()>0)&&this.invalidateArea(b.expanded(1,1,1,1))}},b.prototype._updateSlice=function(a,b){a.setProperty("trf",new GTransform(b.getWidth()/2,0,0,b.getHeight()/2,b.getX()+b.getWidth()/2,b.getY()+b.getHeight()/2))},b.prototype.toString=function(){return"[Object GSliceTool]"},a.GSliceTool=b}(this),function(a){function b(a){GStage.call(this,a),a.getScene().addEventListener(GScene.InvalidationRequestEvent,this._sceneInvalidationRequest,this)}var c=null;GObject.inherit(b,GStage),b.MARGIN_OUTLINE=new GRGBColor([255,0,255]),b.prototype.release=function(){this._view.getScene().removeEventListener(GScene.InvalidationRequestEvent,this._sceneInvalidationRequest,this)},b.prototype.paint=function(a){a.dirtyMatcher&&a.dirtyMatcher.transform(this._view.getViewTransform()),a.configuration.pagesVisible&&this._renderPages(a)},b.prototype._sceneInvalidationRequest=function(a){var b=a.area;b&&(b=this._view.getWorldTransform().mapRect(b)),this.invalidate(b)},b.prototype._renderPages=function(a){for(var b=this._view.getScene().getProperty("singlePage"),c=this._view.getWorldTransform(),d=this._view.getScene().getFirstChild();null!==d;d=d.getNext())d instanceof GPage&&d.isPaintable(a)&&(!b||d.hasFlag(GNode.Flag.Active))&&this._renderPage(a,c,d)},b.prototype._renderPage=function(a,d,e){var f=new GRect(e.getProperty("x"),e.getProperty("y"),e.getProperty("w"),e.getProperty("h")),g=f.expanded(-e.getProperty("ml"),-e.getProperty("mt"),-e.getProperty("mr"),-e.getProperty("mb")),h=d.mapRect(f).toAlignedRect(),i=d.mapRect(g).toAlignedRect(),j=h.getX(),k=h.getY(),l=h.getWidth(),m=h.getHeight(),n=i.getX(),o=i.getY(),p=i.getWidth(),q=i.getHeight();c||(c=GPaintCanvas.createChessboard(8,"white","rgb(205, 205, 205)"));var r=a.canvas.createTexture(c);a.canvas.setTransform(new GTransform(1,0,0,1,j,k)),a.canvas.fillRect(0,0,l,m,r),a.canvas.resetTransform(),GRect.equals(f,g)||a.canvas.strokeRect(n+.5,o+.5,p,q,1,b.MARGIN_OUTLINE)},b.prototype.toString=function(){return"[Object GEditorBackStage]"},a.GEditorBackStage=b}(this),function(a){function b(a){GStage.call(this,a),a.getEditor().addEventListener(GEditor.InvalidationRequestEvent,this._editorInvalidationRequest,this)}GObject.inherit(b,GStage),b.prototype.release=function(){this._view.getEditor().removeEventListener(GEditor.InvalidationRequestEvent,this._editorInvalidationRequest,this)},b.prototype.paint=function(a){var b=GElementEditor.getEditor(this._view.getScene());b&&b.paint(this._view.getWorldTransform(),a)},b.prototype._editorInvalidationRequest=function(a){if(a.editor){var b=a.editor.invalidate(this._view.getWorldTransform(),a.args);b&&this.invalidate(b)}},b.prototype.toString=function(){return"[Object GEditorSceneStage]"},a.GEditorSceneStage=b}(this),function(a){function b(a){GStage.call(this,a)}GObject.inherit(b,GStage),b.prototype.toString=function(){return"[Object GEditorToolStage]"},a.GEditorToolStage=b}(this),function(a){function b(a){GStage.call(this,a),a.getScene().addEventListener(GNode.AfterPropertiesChangeEvent,this._sceneAfterPropertiesChanged,this),a.addEventListener(GMouseEvent.Release,this._cleanGuides,this),a.getEditor().getGuides().addEventListener(GGuides.InvalidationRequestEvent,this._guidesInvalidationRequest,this)}GObject.inherit(b,GStage),b.prototype.release=function(){this._view.getScene().removeEventListener(GNode.AfterPropertiesChangeEvent,this._sceneAfterPropertiesChanged,this),this._view.getEditor().removeEventListener(GGuides.InvalidationRequestEvent,this._guidesInvalidationRequest,this),this._view.removeEventListener(GMouseEvent.Release,this._cleanGuides,this)},b.prototype.paint=function(a){this._view.getEditor().getGuides().paint(this._view.getWorldTransform(),a)},b.prototype._sceneAfterPropertiesChanged=function(a){(a.properties.indexOf("gridSizeX")>=0||a.properties.indexOf("gridSizeY")>=0||a.properties.indexOf("gridActive")>=0)&&this.invalidate()},b.prototype._guidesInvalidationRequest=function(a){if(a.area){var b=this._view.getWorldTransform().mapRect(a.area);this.invalidate(b)}},b.prototype._sceneInvalidationRequest=function(a){if(a.area){var b=this._view.getWorldTransform().mapRect(a.area);this.invalidate(b)}},b.prototype._cleanGuides=function(){this._view.getEditor().getGuides().invalidate()},b.prototype.toString=function(){return"[Object GEditorFrontStage]"},a.GEditorFrontStage=b}(this),function(a){function b(a){var b=Array.prototype.slice.call(arguments);b[0]=a.getScene(),this._editor=a,this._viewConfiguration=new GEditorPaintConfiguration,GSceneWidget.apply(this,b),$(this._htmlElement).on("dragenter",function(a){var b=a.originalEvent;b.preventDefault(),b.stopPropagation()}).on("dragover",function(a){var b=a.originalEvent;b.preventDefault(),b.stopPropagation(),a.originalEvent.dataTransfer.dropEffect="move"}).on("drop",function(a){var b=a.originalEvent;b.preventDefault(),b.stopPropagation();var c=GWidget.convertClientPositionFromMousePosition(this._htmlElement,b);return this._handleDrop(c,b.dataTransfer),!1}.bind(this))}GObject.inherit(b,GSceneWidget),b.prototype._editor=null,b.prototype._toolStage=null,b.prototype.getEditor=function(){return this._editor},b.prototype.getToolStage=function(){return this._toolStage},b.prototype._initStages=function(){this.addStage(new GEditorBackStage(this)),this.addStage(new GSceneStage(this)),this.addStage(new GEditorFrontStage(this)),this.addStage(new GEditorSceneStage(this)),this._toolStage=this.addStage(new GEditorToolStage(this))},b.prototype._updateViewTransforms=function(){GSceneWidget.prototype._updateViewTransforms.call(this),this._editor.updateInlineEditorForView(this)},b.prototype._handleDrop=function(a,b){var c=this.getViewTransform().mapPoint(a);if(b.files&&b.files.length>0){if(this._editor.hasEventListeners(GEditor.FileDropEvent))for(var d=0;d<b.files.length;++d)this._editor.trigger(new GEditor.FileDropEvent(b.files[d],c))}else if(b.items&&b.items.length>0)for(var d=0;d<b.items.length;++d){var e=b.items[d],f=null,g=null;if(e.type===GPattern.MIME_TYPE?(f=GElementEditor.DropType.Pattern,g=b.getData(GPattern.MIME_TYPE),g=g&&""!==g?GPattern.deserialize(g):null):e.type===GNode.MIME_TYPE?(f=GElementEditor.DropType.Node,g=b.getData(GNode.MIME_TYPE),g=g&&""!==g?GNode.deserialize(g):null):"text/plain"===e.type&&(f=GElementEditor.DropType.Text,g=b.getData("text/plain")),null!==f){var h=this._scene.hitTest(a,this.getWorldTransform(),null,!0,-1,this._scene.getProperty("pickDist"),!0),i=!1;if(h&&h.length>0)for(var j=0;j<h.length;++j){var k=h[j],l=GElementEditor.createEditor(k.element);if(l&&l.acceptDrop(c,f,g,k.data)){i=!0;break}}if(!i&&f===GElementEditor.DropType.Node&&g instanceof GElement){var m=g.getGeometryBBox();g.transform(new GTransform(1,0,0,1,c.getX()-(m?m.getX():0),c.getY()-(m?m.getY():0))),this._editor.insertElements([g]),i=!0}}}},b.prototype.toString=function(){return"[Object GEditorWidget]"},a.GEditorWidget=b}(this),function(a){function b(a){this._scene=a,this._scene.__graphic_editor__=this,this._transactionStack=[],this._undoStates=[],this._redoStates=[],this._guides=new GGuides(this._scene),this._scene.addEventListener(GNode.AfterInsertEvent,this._afterNodeInsert,this),this._scene.addEventListener(GNode.BeforeRemoveEvent,this._beforeNodeRemove,this),this._scene.addEventListener(GNode.AfterPropertiesChangeEvent,this._afterPropertiesChange,this),this._scene.addEventListener(GNode.BeforeFlagChangeEvent,this._beforeFlagChange,this),this._scene.addEventListener(GNode.AfterFlagChangeEvent,this._afterFlagChange,this),this._scene.addEventListener(GElement.GeometryChangeEvent,this._geometryChange,this);var b=this._scene.queryAll(":selected");if(b&&b.length)for(var c=0;c<b.length;++c)this._tryAddToSelection(b[c])}GObject.inherit(b,GEventTarget),b.options={maxUndoSteps:20,smartUndoPropertyMerge:!0,cloneShift:10},b.getEditor=function(a){return a.__graphic_editor__?a.__graphic_editor__:null},b.tryRunTransaction=function(a,c,d){var e=b.getEditor(a.getScene());e&&e.beginTransaction();try{c()}finally{e&&e.commitTransaction(d)}},b.FileDropEvent=function(a,b){this.file=a,this.position=b},GObject.inherit(b.FileDropEvent,GEvent),b.FileDropEvent.file=null,b.FileDropEvent.position=null,b.FileDropEvent.prototype.toString=function(){return"[Event GEditor.FileDropEvent]"},b.SelectionChangedEvent=function(){},GObject.inherit(b.SelectionChangedEvent,GEvent),b.SelectionChangedEvent.prototype.toString=function(){return"[Event GEditor.SelectionChangedEvent]"},b.SELECTION_CHANGED_EVENT=new b.SelectionChangedEvent,b.InlineEditorEvent=function(a,b){this.editor=a,this.type=b},GObject.inherit(b.InlineEditorEvent,GEvent),b.InlineEditorEvent.Type={BeforeOpen:0,AfterOpen:1,BeforeClose:10,AfterClose:11,SelectionChanged:100},b.InlineEditorEvent.prototype.editor=null,b.InlineEditorEvent.prototype.type=null,b.InlineEditorEvent.prototype.toString=function(){return"[Event GEditor.InlineEditorEvent]"},b.InvalidationRequestEvent=function(a,b){this.editor=a,this.args=b},GObject.inherit(b.InvalidationRequestEvent,GEvent),b.InvalidationRequestEvent.prototype.editor=null,b.InvalidationRequestEvent.prototype.args=null,b.InvalidationRequestEvent.prototype.toString=function(){return"[Event GEditor.InvalidationRequestEvent]"},b.prototype._scene=null,b.prototype._selection=null,b.prototype._lastCloneSelection=null,b.prototype._storedSelection=null,b.prototype._pageSelections=null,b.prototype._selectionUpdateCounter=0,b.prototype._selectionDetail=!1,b.prototype._transactionStack=null,b.prototype._undoStates=null,b.prototype._redoStates=null,b.prototype._guides=null,b.prototype._currentInlineEditorNode=null,b.prototype.getScene=function(){return this._scene},b.prototype.hasSelection=function(){return this._selection&&this._selection.length>0},b.prototype.getSelectionBBox=function(a){if(this.hasSelection()){for(var b=null,c=0;c<this._selection.length;++c){var d=a?this._selection[c].getGeometryBBox():this._selection[c].getPaintBBox();d&&!d.isEmpty()&&(b=b?b.united(d):new GRect(d.getX(),d.getY(),d.getWidth(),d.getHeight()))}return b}return null},b.prototype.getSelection=function(){return this._selection},b.prototype.getSelectionCopy=function(){var a=null;if(this._selection&&this._selection.length>0){a=[];for(var b=0;b<this._selection.length;++b){var c=this._selection[b];if(c instanceof GBlock){var d=c.getPage(),e=c.clone();e&&(e.transform(new GTransform(1,0,0,1,-d.getProperty("x"),-d.getProperty("y"))),a.push(e))}}a.length||(a=null)}return a},b.prototype.hasSelectionDetail=function(){return this._selectionDetail},b.prototype.setSelectionDetail=function(a){if(a!==this._selectionDetail&&(this._selectionDetail=a,this._selection))for(var b=0;b<this._selection.length;++b){var c=GElementEditor.getEditor(this._selection[b]);c&&(this._selectionDetail?c.setFlag(GElementEditor.Flag.Detail):c.removeFlag(GElementEditor.Flag.Detail))}},b.prototype.getGuides=function(){return this._guides},b.prototype.getPathSelection=function(){var a,b=null;if(this.hasSelection())for(a=0;a<this._selection.length;++a)if(this._selection[a]instanceof GPath||this._selection[a]instanceof GCompoundPath){if(b){b=null;break}b=this._selection[a]}else if(b){b=null;break}return b},b.prototype.release=function(){delete this._scene.__graphic_editor__,this._scene.removeEventListener(GNode.AfterInsertEvent,this._afterNodeInsert,this),this._scene.removeEventListener(GNode.BeforeRemoveEvent,this._beforeNodeRemove,this),this._scene.removeEventListener(GNode.AfterPropertiesChangeEvent,this._afterPropertiesChange,this),this._scene.removeEventListener(GNode.BeforeFlagChangeEvent,this._beforeFlagChange,this),this._scene.removeEventListener(GNode.AfterFlagChangeEvent,this._afterFlagChange,this),this._scene.removeEventListener(GElement.GeometryChangeEvent,this._geometryChange,this)},b.prototype.requestInvalidation=function(a,c){this.hasEventListeners(b.InvalidationRequestEvent)&&this.trigger(new b.InvalidationRequestEvent(a,c))},b.prototype.cloneSelection=function(a,c){if(this._selection&&this._selection.length>0){for(var d=[],e=0;e<this._selection.length;++e){var f=this._selection[e];f.hasMixin(GNode.Store)&&d.push({element:f,transform:a?new GTransform(1,0,0,1,b.options.cloneShift,b.options.cloneShift):null})}var g=[];if(c&&this._lastCloneSelection)for(var e=0;e<this._lastCloneSelection.length;++e){var h=this._lastCloneSelection[e],i=d[e].element;if(h.hasMixin(GElement.Transform)&&i.hasMixin(GElement.Transform)){var j=h.getTransform(),k=i.getTransform();if(k){var l=j?k.preMultiplied(j.inverted()):k;l.isIdentity()||(d[e].transform=l)}}}for(var e=0;e<d.length;++e){var f=d[e].element,m=d[e].transform,n=f.clone();n&&(f.getParent().appendChild(n),m&&n.hasMixin(GElement.Transform)&&n.transform(m),g.push(n))}if(g.length>0&&this.updateSelection(!1,g),c){this._lastCloneSelection=[];for(var e=0;e<d.length;++e)this._lastCloneSelection.push(d[e].element)}return g}return null},b.prototype.deleteSelection=function(a){if(this._selection&&this._selection.length>0){a||this.beginTransaction(),this._beginSelectionUpdate();try{for(var b=GNode.order(this._selection.slice(),!0),c=0;c<b.length;++c){var d=b[c];if(d instanceof GItem&&!d.hasFlag(GElement.Flag.Locked)){var e=GElementEditor.getEditor(d);e&&e.isDeletePartsAllowed()?e.deletePartsSelected():(d.removeFlag(GNode.Flag.Selected),d.getParent().removeChild(d))}}}finally{this._finishSelectionUpdate(),a||this.commitTransaction("Delete Selection")}}return null},b.prototype.updateSelection=function(a,b){this._beginSelectionUpdate();try{if(a){if(b&&b.length)for(var c=0;c<b.length;++c)b[c].hasFlag(GNode.Flag.Selected)?b[c].removeFlag(GNode.Flag.Selected):b[c].setFlag(GNode.Flag.Selected)}else{if(b&&b.length>0)for(var c=0;c<b.length;++c)b[c].setFlag(GNode.Flag.Selected);this.clearSelection(b)}}finally{this._finishSelectionUpdate()}},b.prototype.updateSelectionUnderCollision=function(a,b,c){this._beginSelectionUpdate();try{for(var d=[],e=[],f=0;f<b.length;++f){var g=b[f],h=GElementEditor.openEditor(g);h&&h.isPartSelectionUnderCollisionAllowed()?h.updatePartSelectionUnderCollision(a,c)&&e.push(g):g.isFullUnderCollision(c)&&d.push(g)}if(e&&e.length)if(this._selection||(this._selection=[]),a){for(var f=0;f<e.length;++f)this._selection.indexOf(e[f])<0&&this._tryAddToSelection(e[f]);this.updateSelection(a,d)}else d=d.concat(e),this.updateSelection(a,d);else this.updateSelection(a,d)}finally{this._finishSelectionUpdate()}},b.prototype.clearSelection=function(a){if(!GUtil.equals(a,this._selection)){this._beginSelectionUpdate();try{for(var b=0;this._selection&&b<this._selection.length;)a&&a.indexOf(this._selection[b])>=0?b++:this._selection[b].removeFlag(GNode.Flag.Selected)}finally{this._finishSelectionUpdate()}}},b.prototype.storeSelection=function(){this._scene.getProperty("singlePage")?this._savePageSelection(this._scene.getActivePage(),!0):this._storedSelection=this._saveSelection()},b.prototype.restoreSelection=function(){this._scene.getProperty("singlePage")?this._restorePageSelection(this._scene.getActivePage()):this._loadSelection(this._storedSelection)},b.prototype.moveSelection=function(a,b,c,d,e){var f=a;if(b&&e&&1==this._selection.length){var g=GElement.prototype.getGroupGeometryBBox(this._selection),h=g.getClosestSideName(e),i=g.getSide(h),j=i.add(a);this._guides.getShapeBoxGuide().useExclusions(this._selection),this._guides.beginMap(),j=this._guides.mapPoint(j),this._guides.finishMap(),f=j.subtract(i)}this.transformSelection(new GTransform(1,0,0,1,f.getX(),f.getY()),c,d)},b.prototype.scaleSelection=function(a,b,c,d,e,f,g){var h=GElement.prototype.getGroupGeometryBBox(this._selection);if(h){var i,j,k=h.getSide(GRect.Side.TOP_LEFT),l=h.getSide(GRect.Side.BOTTOM_RIGHT),m=h.getSide(GRect.Side.CENTER);i=0>c?l.getX():c>0?k.getX():m.getX(),j=0>d?l.getY():d>0?k.getY():m.getY();var n=new GTransform(1,0,0,1,-i,-j).multiplied(new GTransform(a,0,0,b,0,0)).multiplied(new GTransform(1,0,0,1,i,j));this.transformSelection(n,f,g)}},b.prototype.transformSelection=function(a,b,c){if(this._selection&&this._selection.length)for(var d=0;d<this._selection.length;++d){var e=this._selection[d],f=GElementEditor.getEditor(e);f&&f.transform(a,b,c)}},b.prototype.resetSelectionTransform=function(){if(this._selection&&this._selection.length)for(var a=0;a<this._selection.length;++a){var b=this._selection[a],c=GElementEditor.getEditor(b);c&&c.resetTransform()}},b.prototype.applySelectionTransform=function(a,b){if(this._selection&&this._selection.length){for(var c=[],d=0;d<this._selection.length;++d){var e=this._selection[d],f=GElementEditor.getEditor(e);f&&(f.canApplyTransform()?c.push(e):f.resetTransform())}if(c&&c.length>0){b||this.beginTransaction();try{for(var g=[],d=0;d<c.length;++d){var e=c[d],f=GElementEditor.getEditor(e);if(f){var h=c[d],i=h;a?h.hasMixin(GNode.Store)?(i=h.clone(),h.getParent().appendChild(i),g.push(i)):i=null:h.hasFlag(GElement.Flag.Locked)&&(i=null),i?f.applyTransform(i):f.resetTransform()}}g.length>0&&this.updateSelection(!1,g)}finally{b||this.commitTransaction(a?"Transform & Clone Selection":"Transform Selection")}}}},b.prototype.insertElements=function(a,b,c){var d=this._scene.querySingle("page:active layer:active");if(!d)throw new Error("No active page/layer.");c||this.beginTransaction();try{for(var e=0;e<a.length;++e){var f=a[e];if(d.appendChild(f),!b){var g=GElementEditor.createEditor(f);g&&g.initialSetup()}}this.updateSelection(!1,a)}finally{c||this.commitTransaction("Insert Element(s)")}},b.prototype.convertSelectionToPaths=function(a){var b=[],c=[];if(this._selection&&this._selection.length)for(var d=0;d<this._selection.length;++d){var e=this._selection[d];e instanceof GPathBase&&!(e instanceof GPath)||e.hasMixin(GVertexSource)?b.push(e):c.push(e)}if(b.length){a||this.beginTransaction(),this._beginSelectionUpdate();try{this.updateSelection(!1,b);for(var d=0;d<b.length;++d){var f=b[d];f.removeFlag(GNode.Flag.Selected);var g=f.getParent(),h=f.getNext(!0);g.removeChild(f);var i=null;if(f instanceof GPathBase){var j=f.clearAnchorPoints();i=new GPath(f.getProperty("closed"),f.getProperty("evenodd"),j)}else f.hasMixin(GVertexSource)&&(i=GPathBase.createPathFromVertexSource(f));i&&(i.assignFrom(f),f=null,g.insertChild(i,h),c.push(i))}b=null,this.updateSelection(!1,c)}finally{this._finishSelectionUpdate(),a||this.commitTransaction("Convert to Path(s)")}}},b.prototype.updateByMousePosition=function(a,b){if(this._scene.getProperty("singlePage")===!1){var c=this._scene.hitTest(a,b,function(a){return a instanceof GPage}.bind(this),!1,1);if(c&&1===c.length)for(var d=this._scene.getFirstChild();null!==d;d=d.getNext())d instanceof GPage&&(d===c[0].element?d.setFlag(GNode.Flag.Active):d.removeFlag(GNode.Flag.Active))}},b.prototype.beginTransaction=function(){var a=GElementEditor.getEditor(this._scene);this._transactionStack.push({actions:[],selection:this._saveSelection(),transformBoxCenter:a?a.getTransformBoxCenter():null})},b.prototype._transactionRedo=function(a){for(var b=0;b<a.actions.length;++b)a.actions[b].action();this._loadSelection(a.newSelection);var c=GElementEditor.getEditor(this._scene);(a.newTransformBoxCenter||c&&c.isTransformBoxActive())&&(a.newTransformBoxCenter?c.setTransformBoxActive(!0,a.newTransformBoxCenter):c.setTransformBoxActive(!1))},b.prototype._transactionUndo=function(a){for(var b=a.actions.length-1;b>=0;--b)a.actions[b].revert();this._loadSelection(a.selection);var c=GElementEditor.getEditor(this._scene);(a.transformBoxCenter||c&&c.isTransformBoxActive())&&(a.transformBoxCenter?c.setTransformBoxActive(!0,a.transformBoxCenter):c.setTransformBoxActive(!1))},b.prototype._transactionMerge=function(a,c){if(b.options.smartUndoPropertyMerge&&1===c.actions.length&&1===a.actions.length){var d=c.actions[0],e=a.actions[0];if(d.isPropertyChangeAction&&e.isPropertyChangeAction&&d.node===e.node&&d.properties.length===e.properties.length){for(var f=!0,g=0;g<e.properties.length;++g){var h=e.properties[g];if(d.properties.indexOf(h)<0){f=!1;break}}if(f){for(var g=0;g<d.properties.length;++g){var h=d.properties[g];e.values[e.properties.indexOf(h)]=d.values[g]}return!0}}}return!1},b.prototype.commitTransaction=function(a){if(!this._transactionStack.length)throw new Error("Nothing to commit, transaction stack is empty.");var b=this._transactionStack.pop();if(b.actions.length>0){var c=GElementEditor.getEditor(this._scene),d={actions:b.actions.slice(),selection:b.selection?b.selection.slice():null,newSelection:this._saveSelection(),transformBoxCenter:b.transformBoxCenter,newTransformBoxCenter:c?c.getTransformBoxCenter():null};this.pushState(a,this._transactionRedo.bind(this),this._transactionUndo.bind(this),d,this._transactionMerge.bind(this))}},b.prototype.pushState=function(a,c,d,e,f){if(f&&e&&this._undoStates.length>0){var g=this._undoStates[this._undoStates.length-1];if(g.data&&g.name===a&&f(g.data,e))return}this._undoStates.length>=b.options.maxUndoSteps&&this._undoStates.shift(),this._undoStates.push({name:a?a:"",action:c,revert:d,data:e}),this._redoStates=[]},b.prototype.hasUndoState=function(){return this._undoStates.length>0},b.prototype.hasRedoState=function(){return this._redoStates.length>0},b.prototype.getUndoStateName=function(){return this._undoStates.length>0?this._undoStates[this._undoStates.length-1].name:null},b.prototype.getRedoStateName=function(){return this._redoStates.length>0?this._redoStates[this._redoStates.length-1].name:null},b.prototype.undoState=function(){if(this._undoStates.length>0){var a=this._undoStates.pop();this._redoStates.push(a),a.revert(a.data)}},b.prototype.redoState=function(){if(this._redoStates.length>0){var a=this._redoStates.pop();this._undoStates.push(a),a.action(a.data)}},b.prototype.isInlineEditing=function(){return!!this._currentInlineEditorNode
},b.prototype.openInlineEditor=function(a,c,d){this.closeInlineEditor();var e=GElementEditor.getEditor(a);return e&&e.canInlineEdit()?(this.hasEventListeners(b.InlineEditorEvent)&&this.trigger(new b.InlineEditorEvent(e,b.InlineEditorEvent.Type.BeforeOpen)),e.beginInlineEdit(c,c._htmlElement),e.adjustInlineEditForView(c,d),this._currentInlineEditorNode=a,this.hasEventListeners(b.InlineEditorEvent)&&this.trigger(new b.InlineEditorEvent(e,b.InlineEditorEvent.Type.AfterOpen)),!0):!1},b.prototype.updateInlineEditorForView=function(a){if(this._currentInlineEditorNode){var b=GElementEditor.getEditor(this._currentInlineEditorNode);b&&b.isInlineEdit()&&b.adjustInlineEditForView(a)}},b.prototype.closeInlineEditor=function(){return this._currentInlineEditorNode?this._finishEditorInlineEdit(this._currentInlineEditorNode):!1},b.prototype._afterNodeInsert=function(a){if(this._transactionStack.length){var b=a.node,c=b.getParent(),d=b.getNext();this._transactionStack[this._transactionStack.length-1].actions.push({action:function(){c.insertChild(b,d)},revert:function(){c.removeChild(b)}})}this._tryAddToSelection(a.node)},b.prototype._beforeNodeRemove=function(a){if(this._transactionStack.length){var b=a.node,c=b.getParent(),d=b.getNext();this._transactionStack[this._transactionStack.length-1].actions.push({action:function(){c.removeChild(b)},revert:function(){c.insertChild(b,d)}})}a.node instanceof GElement&&(this._selection&&this._selection.indexOf(a.node)>=0?a.node.removeFlag(GNode.Flag.Selected):this._closeEditor(a.node)),a.node instanceof GPage&&this._scene.getProperty("singlePage")===!0&&this._removePageSelection(a.node)},b.prototype._afterPropertiesChange=function(a){if(this._transactionStack.length){var b=a.node,c=a.properties,d=b.getProperties(a.properties),e=a.values.slice();this._transactionStack[this._transactionStack.length-1].actions.push({isPropertyChangeAction:!0,node:b,properties:c.slice(),values:d.slice(),oldValues:e,action:function(){b.setProperties(this.properties,this.values)},revert:function(){b.setProperties(this.properties,this.oldValues)}})}},b.prototype._beforeFlagChange=function(a){a.node instanceof GElement&&a.flag===GElement.Flag.Hidden&&a.set&&a.node.removeFlag(GNode.Flag.Selected)},b.prototype._afterFlagChange=function(a){if(a.node instanceof GElement)if(a.flag===GNode.Flag.Selected)a.set?this._tryAddToSelection(a.node):this._tryRemoveFromSelection(a.node);else if(a.flag==GNode.Flag.Highlighted)if(a.set){var b=GElementEditor.openEditor(a.node);b&&b.setFlag(GElementEditor.Flag.Highlighted)}else{var b=GElementEditor.openEditor(a.node);b&&b.removeFlag(GElementEditor.Flag.Highlighted),this._tryCloseEditor(a.node)}else a.flag==GNode.Flag.Active&&a.node instanceof GPage&&this._scene.getProperty("singlePage")===!0&&(a.set?this._restorePageSelection(a.node):this._savePageSelection(a.node,!1,!0))},b.prototype._geometryChange=function(a){if(this._selection&&this._selection.indexOf(a.element)>=0)switch(a.type){case GElement.GeometryChangeEvent.Type.Before:case GElement.GeometryChangeEvent.Type.After:case GElement.GeometryChangeEvent.Type.Child:var b=GElementEditor.getEditor(a.element);b&&b.requestInvalidation()}},b.prototype._beginSelectionUpdate=function(){this._selectionUpdateCounter+=1},b.prototype._finishSelectionUpdate=function(){0===--this._selectionUpdateCounter&&this._updatedSelection()},b.prototype._updatedSelection=function(){0===this._selectionUpdateCounter&&(this._lastCloneSelection=null,this.hasEventListeners(b.SelectionChangedEvent)&&this.trigger(b.SELECTION_CHANGED_EVENT))},b.prototype._tryAddToSelection=function(a){if(a instanceof GElement&&a.hasFlag(GNode.Flag.Selected)){var b=GElementEditor.openEditor(a);b&&(b.setFlag(GElementEditor.Flag.Selected),this._selectionDetail&&b.setFlag(GElementEditor.Flag.Detail),b.validateSelectionChange()&&(this._selection||(this._selection=[]),this._selection.push(a),this._updatedSelection()))}},b.prototype._tryRemoveFromSelection=function(a){if(a instanceof GElement){var b=GElementEditor.getEditor(a);if(b&&b.hasFlag(GElementEditor.Flag.Selected)){var c=b.validateSelectionChange();if(b.removeFlag(GElementEditor.Flag.Selected),this._tryCloseEditor(a),this._selection&&c){for(var d=!1,e=-1,f=0;f<this._selection.length;++f){var g=this._selection[f];g===a?e=f:g.getParent()===a.getParent()&&(d=!0)}this._selection.splice(e,1),0==this._selection.length&&(this._selection=null),this._updatedSelection()}}}},b.prototype._tryCloseEditor=function(a){var b=GElementEditor.getEditor(a);if(b&&!b.hasFlag(GElementEditor.Flag.Selected)&&!b.hasFlag(GElementEditor.Flag.Highlighted)&&(null==b.getEditors()||0==b.getEditors().length)){var c=b.getParentEditor();this._closeEditor(a),c&&this._tryCloseEditor(c.getElement())}},b.prototype._finishEditorInlineEdit=function(a){var c=GElementEditor.getEditor(a);if(c&&c.isInlineEdit()){this.hasEventListeners(b.InlineEditorEvent)&&this.trigger(new b.InlineEditorEvent(c,b.InlineEditorEvent.Type.BeforeClose));var d=null;this.beginTransaction();try{d=c.finishInlineEdit()}finally{this.commitTransaction(d?d:"Inline Editing")}return a===this._currentInlineEditorNode&&(this._currentInlineEditorNode=null),this.hasEventListeners(b.InlineEditorEvent)&&this.trigger(new b.InlineEditorEvent(c,b.InlineEditorEvent.Type.AfterClose)),!0}return!1},b.prototype._closeEditor=function(a){this._finishEditorInlineEdit(a),GElementEditor.closeEditor(a)},b.prototype._savePageSelection=function(a,b,c){this._pageSelections||(this._pageSelections=[]);for(var d=0;d<this._pageSelections.length;++d){var e=this._pageSelections[d];if(e.page===a)return void(c&&e.noOverwrite||(e.selection=this._saveSelection(),e.noOverwrite=b))}this._pageSelections.push({page:a,selection:this._saveSelection()})},b.prototype._restorePageSelection=function(a){if(this._pageSelections)for(var b=0;b<this._pageSelections.length;++b){var c=this._pageSelections[b];if(c.page===a)return void this._loadSelection(c.selection)}this.clearSelection()},b.prototype._removePageSelection=function(a){if(this._pageSelections)for(var b=0;b<this._pageSelections.length;++b){var c=this._pageSelections[b];if(c.page===a){this._pageSelections.splice(b,1);break}}},b.prototype._saveSelection=function(){if(!this._selection||0===this._selection.length)return null;for(var a=[],b=0;b<this._selection.length;++b){var c=this._selection[b],d=GElementEditor.getEditor(c),e=d?d.getPartSelection():null;a.push({element:c,parts:e?e.slice():null})}return a},b.prototype._loadSelection=function(a){if(a&&0!==a.length){for(var b=[],c=0;c<a.length;++c)b.push(a[c].element);this.updateSelection(!1,b);for(var c=0;c<a.length;++c)if(a[c].parts){var d=GElementEditor.getEditor(a[c].element);d&&d.updatePartSelection(!1,a[c].parts)}}else this.clearSelection()},b.prototype.toString=function(){return"[Object GEditor]"},a.GEditor=b}(this),function(a){function b(){}GObject.inherit(b,GScenePaintConfiguration),b.prototype.pagesVisible=!0,b.prototype.gridVisible=!0,b.prototype.toString=function(){return"[Object GEditorPaintConfiguration]"},a.GEditorPaintConfiguration=b}(this),ifLocale.setValues(GSceneEditor,GLocale.Language.English,["action.insert","action.remove","action.properties"],["Insert","Remove","Change Properties"]);